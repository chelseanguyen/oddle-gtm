{
  "updatedAt": "2026-02-16T03:28:39.146Z",
  "createdAt": "2026-01-14T09:14:31.594Z",
  "id": "Z4BV7uCQ8dSjXR1w",
  "name": "[Email] Process human-approved response for Sophie",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.update",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"ts\": \"{{ $('Parse Slack Payload').item.json.original_message_ts }}\",\n  \"text\": \"Prospect reply approved\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Lead Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.lead_identifier }}|{{ $('Parse Slack Payload').item.json.lead_identifier }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Reply-from Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.reply_from_email }}|{{ $('Parse Slack Payload').item.json.reply_from_email }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ $('Parse Slack Payload').item.json.lead_message && $('Parse Slack Payload').item.json.lead_message.length > 500 ? $('Parse Slack Payload').item.json.lead_message.substring(0, 500).replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') + '\\\\n\\\\n[Message truncated - view full reply in Lemlist]' : ($('Parse Slack Payload').item.json.lead_message || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ ($('Parse Slack Payload').item.json.ai_generated_response || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View full conversation in Lemlist>\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \":white_check_mark: *Approved* by <@{{ $('Parse Slack Payload').item.json.user_id }}>\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        720,
        -32
      ],
      "name": "Update Message - Approved",
      "id": "c0bb6280-cc23-4bba-8cde-1993c51dd7ee",
      "credentials": {
        "httpBearerAuth": {
          "id": "A9y0ZdmG00hI8udd",
          "name": "Slack's Email SDR Agent"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.update",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"ts\": \"{{ $('Parse Slack Payload').item.json.original_message_ts }}\",\n  \"text\": \"Prospect reply - send failed\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Lead Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.lead_identifier }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Reply-from Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.reply_from_email }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ \n  (function() {\n    let rawText = $('Parse Slack Payload').item.json.lead_message || '';\n    \n    let truncated = rawText.length > 500 \n      ? rawText.substring(0, 500) + '\\n\\n[Message truncated - view full reply in Lemlist]' \n      : rawText;\n    \n    return JSON.stringify(truncated).slice(1, -1);\n  })()\n}}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ \n  (function() {\n    let agentText = $('Parse Slack Payload').item.json.ai_generated_response || ''; \n    return JSON.stringify(agentText).slice(1, -1);\n  })()\n}}```\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View full conversation in Lemlist>\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \":x: *Email Send Failed* - Approved by <@{{ $('Parse Slack Payload').item.json.user_id }}>\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1936,
        320
      ],
      "name": "Update Message - Error",
      "id": "5e15d02c-1bd0-4e09-b25b-503cc1a61c72",
      "credentials": {
        "httpBearerAuth": {
          "id": "A9y0ZdmG00hI8udd",
          "name": "Slack's Email SDR Agent"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.update",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"ts\": \"{{ $('Parse Slack Payload').item.json.original_message_ts }}\",\n  \"text\": \"Prospect reply rejected\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Lead Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.lead_identifier }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Reply-from Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.reply_from_email }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ $('Parse Slack Payload').item.json.lead_message && $('Parse Slack Payload').item.json.lead_message.length > 500 ? $('Parse Slack Payload').item.json.lead_message.substring(0, 500).replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') + '\\\\n\\\\n[Message truncated - view full reply in Lemlist]' : ($('Parse Slack Payload').item.json.lead_message || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ ($('Parse Slack Payload').item.json.ai_generated_response || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View full conversation in Lemlist>\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \":no_entry: *Rejected* by <@{{ $('Parse Slack Payload').item.json.user_id }}>\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        720,
        416
      ],
      "name": "Update Message - Rejected",
      "id": "a374ed4a-89e5-41ac-bc27-5b3d2afc32a5",
      "credentials": {
        "httpBearerAuth": {
          "id": "A9y0ZdmG00hI8udd",
          "name": "Slack's Email SDR Agent"
        }
      }
    },
    {
      "parameters": {
        "content": "When a user clicks a button in Slack, Slack sends a webhook payload to n8n workflow and expects a response within 3 seconds. Otherwise, it'll show an operation time-out error "
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        64,
        496
      ],
      "typeVersion": 1,
      "id": "06eed927-712c-458c-9779-cdaba5654b58",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2224,
        352
      ],
      "name": "Google Gemini Chat1",
      "id": "351b911a-8b4a-4d00-8289-4488de226201",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"topic\": \"pricing\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2496,
        352
      ],
      "name": "Topic Output Parser1",
      "id": "23f02daf-e5c4-460d-9ad2-883318391959"
    },
    {
      "parameters": {
        "modelName": "models/gemini-embedding-001"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        2832,
        368
      ],
      "name": "Google Gemini Embeddings",
      "id": "045d227b-111b-4782-a8d7-f421af33fb35",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse conversation history to extract subject, metadata, and lead message\n\n  const messages = $input.first().json.data || [];\n  const latestMessage = messages[0] || {};\n\n  // Extract subject line\n  let subject = latestMessage.subject || 'Re: Follow-up';\n  if (!subject.toLowerCase().startsWith('re:')) {\n    subject = 'Re: ' + subject;\n  }\n\n  // Find the first email sent by us for metadata\n  const sentMessage = messages.find(msg => msg.type === 'emailsSent') || latestMessage;\n\n  // Find the latest lead message (type: \"emailsReplied\")\n  const leadReply = messages.find(msg => msg.type === 'emailsReplied');\n  let leadMessage = '';\n\n  if (leadReply && leadReply.message) {\n    // Clean up HTML tags and decode entities\n    leadMessage = leadReply.message\n      .replace(/<[^>]*>/g, '')           // Remove HTML tags\n      .replace(/&lt;/g, '<')             // Decode HTML entities\n      .replace(/&gt;/g, '>')\n      .replace(/&amp;/g, '&')\n      .replace(/&nbsp;/g, ' ')\n      .replace(/&#39;/g, \"'\")            // Decode apostrophe\n      .replace(/&quot;/g, '\"')           // Decode quotes\n      .replace(/&#x27;/g, \"'\")           // Decode hex apostrophe\n      .replace(/&apos;/g, \"'\")           // Decode apos\n      .replace(/\\s+/g, ' ')              // Collapse multiple spaces\n      .trim()                            // Remove leading/trailing whitespace\n      .substring(0, 500);                // Truncate to 500 characters\n  }\n\n  // Handle CC\n  let cc = null;\n  if (Array.isArray(sentMessage.cc)) {\n    cc = sentMessage.cc.length > 0 ? sentMessage.cc : null;\n  } else if (Array.isArray(latestMessage.cc)) {\n    cc = latestMessage.cc.length > 0 ? latestMessage.cc : null;\n  }\n\n  return {\n    json: {\n      subject: subject,\n      sendUserId: sentMessage.sendUserId || null,\n      sendUserEmail: sentMessage.sendUserEmail || null,\n      sendUserMailboxId: sentMessage.sendUserMailboxId || null,\n      contactId: latestMessage.contactId || null,\n      leadId: latestMessage.leadId || null,\n      cc: cc,\n      leadMessage: leadMessage  // Cleaned and truncated lead message\n    }\n  };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        192
      ],
      "name": "Parse Conversation History",
      "id": "c8f231c4-a50f-47f9-9677-477c2c5d482e"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "slack-reply-approval",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -144,
        128
      ],
      "name": "Slack Webhook Trigger",
      "webhookId": "slack-reply-approval",
      "id": "8f0b0f30-e8aa-4f1e-886a-95cfe672fa47"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        64,
        320
      ],
      "name": "Respond to Slack",
      "id": "8262bccd-7e74-46ba-a844-7a1f4d9aabd5"
    },
    {
      "parameters": {
        "jsCode": "// Parse Slack interaction payload for RLHF\nconst payload = $input.first().json.body.payload;\nlet parsedPayload;\n\nif (typeof payload === 'string') {\n  parsedPayload = JSON.parse(payload);\n} else {\n  parsedPayload = payload;\n}\n\n// Helper function to decode Slack HTML entities\nconst decode = (str) => {\n  if (!str) return null;\n  return str\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>');\n};\n\n// Extract basic action details\nconst action = parsedPayload.actions?.[0];\nconst actionId = action?.action_id;\nconst user = parsedPayload.user;\nconst channel = parsedPayload.channel;\nconst responseUrl = parsedPayload.response_url;\n\n// Helper function to extract text from markdown field\nfunction extractFromField(blocks, label) {\n  for (const block of blocks) {\n    if (block.type === 'section' && block.fields) {\n      for (const field of block.fields) {\n        if (field.text && field.text.includes(label)) {\n          const parts = field.text.split('\\n');\n          if (parts.length > 1) {\n            let value = parts[1];\n            const emailMatch = value.match(/<mailto:([^|>]+)\\|/);\n            if (emailMatch) {\n              return emailMatch[1];\n            }\n            return value.trim();\n          }\n        }\n      }\n    }\n  }\n  return null;\n}\n\n// Helper function to extract text from section with specific header\nfunction extractSectionText(blocks, header) {\n  for (const block of blocks) {\n    if (block.type === 'section' && block.text && block.text.text) {\n      if (block.text.text.includes(header)) {\n        const text = block.text.text;\n        const codeBlockMatch = text.match(/```([\\s\\S]*?)```/);\n        if (codeBlockMatch) {\n          return codeBlockMatch[1].trim();\n        }\n        const parts = text.split(header);\n        if (parts.length > 1) {\n          return parts[1].replace(/^\\n/, '').trim();\n        }\n      }\n    }\n  }\n  return null;\n}\n\n// Helper function to extract Lemlist IDs from URL in context block\nfunction extractLemlistIds(blocks) {\n  for (const block of blocks) {\n    if (block.type === 'context' && block.elements) {\n      for (const element of block.elements) {\n        if (element.text && element.text.includes('app.lemlist.com')) {\n          const urlMatch = element.text.match(/https:\\/\\/app\\.lemlist\\.com\\/teams\\/([^\\/]+)\\/inbox\\/list\\/myConversations\\/contacts\\/([^|>]+)/);\n          if (urlMatch) {\n            return {\n              teamId: urlMatch[1],\n              contactId: urlMatch[2]\n            };\n          }\n        }\n      }\n    }\n  }\n  return { teamId: null, contactId: null };\n}\n\nconst blocks = parsedPayload.message?.blocks || [];\n\n// Apply decoding during extraction\nconst companyName = decode(extractFromField(blocks, '*Company:*'));\nconst leadEmail = extractFromField(blocks, '*Lead Email:*');\nconst replyFromEmail = extractFromField(blocks, '*Reply-from Email:*');\nconst outreachCampaign = decode(extractFromField(blocks, '*Outreach Campaign:*'));\nconst prospectReply = decode(extractSectionText(blocks, \"*Prospect's Reply:*\"));\nconst agentResponse = decode(extractSectionText(blocks, '*Agent Generated Response:*'));\nconst lemlistIds = extractLemlistIds(blocks);\nconst lemlistMessageId = action?.value;\n\nreturn {\n  json: {\n    action_id: actionId,\n    slack_channel_id: channel?.id,\n    slack_channel_name: channel?.name,\n    slack_user_name: user?.name || user?.username,\n    company_name: companyName,\n    lead_identifier: leadEmail,\n    reply_from_email: replyFromEmail,\n    campaign_name: outreachCampaign,\n    lead_message: prospectReply,\n    ai_generated_response: agentResponse,\n    lemlist_contact_id: lemlistIds.contactId,\n    lemlist_team_id: lemlistIds.teamId,\n    lemlist_message_id: lemlistMessageId,\n    user_id: user?.id,\n    response_url: responseUrl,\n    original_message_ts: parsedPayload.message?.ts,\n    team_id: parsedPayload.team?.id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        320
      ],
      "name": "Parse Slack Payload",
      "id": "0840d52c-e4d6-450e-97a1-ea46837a4936"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition-approve",
              "leftValue": "={{ $json.action_id }}",
              "rightValue": "approve",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        496,
        320
      ],
      "name": "Check Action",
      "id": "f8866b04-bfe6-4ddb-9c34-1205e3a37afc"
    },
    {
      "parameters": {
        "url": "=https://api.lemlist.com/api/inbox/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "lemlistApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        720,
        192
      ],
      "name": "Retrieve Conversation History",
      "id": "f29fcfaa-b69c-4eb3-9837-c777e32f9ef6",
      "credentials": {
        "lemlistApi": {
          "id": "6dgMHleAsx5bfyF9",
          "name": "Lemlist account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.lemlist.com/api/inbox/email",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "sendUserId",
              "value": "={{ $json.sendUserId }}"
            },
            {
              "name": "sendUserEmail",
              "value": "={{ $json.sendUserEmail }}"
            },
            {
              "name": "sendUserMailboxId",
              "value": "={{ $json.sendUserMailboxId }}"
            },
            {
              "name": "contactId",
              "value": "={{ $json.contactId }}"
            },
            {
              "name": "leadId",
              "value": "={{ $json.leadId }}"
            },
            {
              "name": "subject",
              "value": "={{ $json.subject }}"
            },
            {
              "name": "message",
              "value": "={{ '<p>' + $('Parse Slack Payload').item.json.ai_generated_response.split('\\n\\n').map(para => para.replace(/\\n/g, '<br>')).join('</p><p>') + '</p>' }}"
            },
            {
              "name": "cc",
              "value": "={{ $json.cc.map(item => item.address).join(', ') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1152,
        192
      ],
      "name": "Send Email via Lemlist",
      "id": "80d7a160-204b-4808-b891-1818a837e993",
      "credentials": {
        "lemlistApi": {
          "id": "6dgMHleAsx5bfyF9",
          "name": "Lemlist account"
        },
        "httpBasicAuth": {
          "id": "ErJHjZR0I2frgqLU",
          "name": "Lemlist Account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition-send-success",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isEmpty"
              }
            },
            {
              "id": "a9b819a9-7bac-4399-984e-28e3ddfd0802",
              "leftValue": "={{ $json.ok }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1200,
        576
      ],
      "name": "Check Send Status",
      "id": "87b3f84c-9d61-4c75-838e-8be311c3810f"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"text\": \"Failed to send email\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":x: Failed to Send Email\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Error Details:*\\n```{{ \n  (function() {\n    let errorText = $json.error.message || ''; \n    \n    return JSON.stringify(errorText).slice(1, -1);\n  })()\n}}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*To:*\\n{{ $('Parse Slack Payload').item.json.reply_from_email }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":warning: Error sending email, please send the reply manually in Lemlist\"\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1680,
        320
      ],
      "name": "Post Error status to Slack",
      "id": "98f56553-2067-46d6-9bc4-1e233be2acd7",
      "credentials": {
        "httpBearerAuth": {
          "id": "A9y0ZdmG00hI8udd",
          "name": "Slack's Email SDR Agent"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Parse Conversation History').item.json.leadMessage }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are an AI assistant that categorizes prospect messages into topics.\n\nAnalyze the prospect's message and categorize it into ONE of the following topics:\n\n**Valid Topics:**\n- pricing: Questions about cost, pricing plans, discounts, payment terms\n- product_feature: Questions about specific features, functionality, capabilities\n- competitor_comparison: Comparisons with competitors, asking why choose us\n- objection: Concerns, doubts, hesitations, or pushback\n- interested: Expressing interest, wanting to learn more, positive signals\n- not_interested: Clearly not interested, politely declining, no need\n- timing: Questions about implementation timeline, when to start, availability\n- technical: Technical questions, integrations, API, security, compliance\n- scheduling: Requesting a demo, meeting, call, or follow-up\n- general_inquiry: General questions that don't fit other categories\n- auto_reply: Auto-replies, bot replies, out of office messages\n\n**Instructions:**\n1. Read the prospect's message carefully\n2. Identify the main intent or topic\n3. Return ONLY the topic keyword (e.g., \"pricing\", \"product_feature\")\n4. Use lowercase and underscores for multi-word topics\n5. Choose the MOST relevant single topic\n\n**Output Format:**\nReturn a JSON object with the topic:\n{\n  \"topic\": \"<topic_keyword>\"\n}\n\n**Examples:**\nMessage: \"How much does this cost?\"\nOutput: {\"topic\": \"pricing\"}\n\nMessage: \"Does it integrate with POS?\"\nOutput: {\"topic\": \"technical\"}\n\nMessage: \"Not interested right now, thanks.\"\nOutput: {\"topic\": \"not_interested\"}\n\nMessage: \"Can you tell me more about the reporting features?\"\nOutput: {\"topic\": \"product_feature\"}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        2272,
        160
      ],
      "name": "Categorize Lead Message Topic",
      "id": "d2a301d8-dc58-4b20-b37c-001a3994ac36"
    },
    {
      "parameters": {
        "jsCode": "// Retrieve data\nconst leadMessage = $('Parse Conversation History').first().json.leadMessage;\nconst responseSent = $('Parse Slack Payload').first().json.ai_generated_response;\nconst rawTopic = $('Categorize Lead Message Topic').first().json.output?.topic || 'general_inquiry';\n\n// Capitalize the first letter of the topic (e.g., 'objection' -> 'Objection')\nconst topic = rawTopic.charAt(0).toUpperCase() + rawTopic.slice(1);\n\n// Construct the structured pageContent string\n// Note: This uses backticks to maintain the line breaks exactly as they will appear in the DB\nconst formattedContent = `Prospectâ€™s message: \n\"${leadMessage}\"\n\nHow to respond: \n\n${responseSent}`;\n\nreturn {\n  json: {\n    pageContent: formattedContent,\n    metadata: {\n      topic: topic,\n      created_at: new Date().toISOString() // Recommended for DB sorting\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2656,
        160
      ],
      "name": "Prepare Training Document",
      "id": "823e7e48-60d6-469e-91fe-a159ca48d587"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "response_handling_guide",
          "mode": "list",
          "cachedResultName": "response_handling_guide"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        2896,
        160
      ],
      "name": "Store Approved Response to DB",
      "id": "fd9b425c-1d74-4b9d-a011-a9784c5709ee",
      "credentials": {
        "supabaseApi": {
          "id": "aJzMx5t2Q4kcZ8EL",
          "name": "Supabase Account"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.pageContent }}",
        "textSplittingMode": "custom",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        3024,
        368
      ],
      "id": "b9f78736-bc0b-4bce-8b18-dfae149e0616",
      "name": "Default Data Loader"
    },
    {
      "parameters": {
        "separator": "*&^%$&*()",
        "chunkSize": 1000000
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        3024,
        544
      ],
      "id": "3ea452e2-4307-45f7-a0f3-75a824b97cce",
      "name": "Character Text Splitter"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"text\": \"Email sent successfully!\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":white_check_mark: Email Sent Successfully\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*To:*\\n{{ $('Parse Slack Payload').item.json.reply_from_email }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Approved by:*\\n{{ $('Parse Slack Payload').item.json.slack_user_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View conversation in Lemlist>\"\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1680,
        32
      ],
      "name": "Post Success status to Slack",
      "id": "a859ec25-2b54-40cd-a4b3-f3210f3d7a22",
      "credentials": {
        "httpBearerAuth": {
          "id": "A9y0ZdmG00hI8udd",
          "name": "Slack's Email SDR Agent"
        }
      }
    },
    {
      "parameters": {
        "content": "## Not used for now",
        "height": 720,
        "width": 1344
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2144,
        16
      ],
      "typeVersion": 1,
      "id": "af35ec51-56f1-4d3f-9406-6b57dc05bca4",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Workflow 2: Process human-approved response\n\n",
        "height": 100,
        "width": 640,
        "color": 4
      },
      "id": "a6db13ed-5248-4314-b37a-1ad78fd6d56a",
      "name": "Sticky Note16",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -160,
        -64
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.ok }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "f8b49112-55c9-470e-9925-5d6aafdf74df"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Send success"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d10af122-becb-4eb2-bc29-b810356f05df",
                    "leftValue": "={{ $json.error }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Error sending"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1376,
        192
      ],
      "id": "be1d0f2d-ceb6-4a57-b8cd-b6fdc61c84df",
      "name": "Switch"
    }
  ],
  "connections": {
    "Google Gemini Chat1": {
      "ai_languageModel": [
        [
          {
            "node": "Categorize Lead Message Topic",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Topic Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Categorize Lead Message Topic",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Store Approved Response to DB",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Parse Conversation History": {
      "main": [
        [
          {
            "node": "Send Email via Lemlist",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Webhook Trigger": {
      "main": [
        [
          {
            "node": "Respond to Slack",
            "type": "main",
            "index": 0
          },
          {
            "node": "Parse Slack Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Slack Payload": {
      "main": [
        [
          {
            "node": "Check Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Action": {
      "main": [
        [
          {
            "node": "Retrieve Conversation History",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Message - Approved",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Message - Rejected",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retrieve Conversation History": {
      "main": [
        [
          {
            "node": "Parse Conversation History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email via Lemlist": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Send Status": {
      "main": [
        [],
        []
      ]
    },
    "Post Error status to Slack": {
      "main": [
        [
          {
            "node": "Update Message - Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Categorize Lead Message Topic": {
      "main": [
        [
          {
            "node": "Prepare Training Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Training Document": {
      "main": [
        [
          {
            "node": "Store Approved Response to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Approved Response to DB": {
      "main": [
        []
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Store Approved Response to DB",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Post Success status to Slack": {
      "main": [
        []
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Post Success status to Slack",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Post Error status to Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "timeSavedPerExecution": 5,
    "timezone": "Asia/Singapore",
    "errorWorkflow": "2SWvtvGbkteCtlr0"
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "Slack Webhook Trigger": [
      {
        "json": {
          "headers": {
            "host": "workflow.oddle.center",
            "user-agent": "Slackbot 1.0 (+https://api.slack.com/robots)",
            "accept": "application/json,*/*",
            "x-slack-signature": "v0=cabf76de809ab4b1c7013afb4e2dc15afdc8b9658958fc231cd8505161dbdc92",
            "x-slack-request-timestamp": "1771208504",
            "content-length": "5220",
            "content-type": "application/x-www-form-urlencoded",
            "x-cloud-trace-context": "b18199c1c0a48d5d41aad23b4ca2e571/18327970764835456342;o=1",
            "x-forwarded-proto": "https",
            "traceparent": "00-b18199c1c0a48d5d41aad23b4ca2e571-fe5a084e0bc30556-01",
            "x-forwarded-for": "44.222.92.96",
            "forwarded": "for=\"44.222.92.96\";proto=https",
            "accept-encoding": "gzip,deflate"
          },
          "params": {},
          "query": {},
          "body": {
            "payload": "{\"type\":\"block_actions\",\"user\":{\"id\":\"U06UPB4K0AW\",\"username\":\"chloei.garcia\",\"name\":\"chloei.garcia\",\"team_id\":\"T030ZCV78\"},\"api_app_id\":\"A0A55SZF3EU\",\"token\":\"mA4Pk1zJFUdp77ZGdyQ7LFki\",\"container\":{\"type\":\"message\",\"message_ts\":\"1771128220.011909\",\"channel_id\":\"C0AB3U5B1D4\",\"is_ephemeral\":false},\"trigger_id\":\"10512695193301.3033437246.3cf143a0ba352d0785e0542768aa54a9\",\"team\":{\"id\":\"T030ZCV78\",\"domain\":\"oddle\"},\"enterprise\":null,\"is_enterprise_install\":false,\"channel\":{\"id\":\"C0AB3U5B1D4\",\"name\":\"noti-sdr-email-agent\"},\"message\":{\"user\":\"U0A484RHCNR\",\"type\":\"message\",\"ts\":\"1771128220.011909\",\"bot_id\":\"B0A4BHC4802\",\"app_id\":\"A0A55SZF3EU\",\"text\":\"New prospect reply needs approval\",\"team\":\"T030ZCV78\",\"blocks\":[{\"type\":\"header\",\"block_id\":\"E2JQK\",\"text\":{\"type\":\"plain_text\",\"text\":\":bell: New Prospect Reply\",\"emoji\":true}},{\"type\":\"divider\",\"block_id\":\"5QEZP\"},{\"type\":\"section\",\"block_id\":\"FPQls\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Company:*\\nBistro George\",\"verbatim\":false},{\"type\":\"mrkdwn\",\"text\":\"*Lead Email:*\\n<mailto:info@jacksonsongeorge.com.au|info@jacksonsongeorge.com.au>\",\"verbatim\":false},{\"type\":\"mrkdwn\",\"text\":\"*Reply-from Email:*\\n<mailto:austin@gallagherhotels.com.au|austin@gallagherhotels.com.au>\",\"verbatim\":false},{\"type\":\"mrkdwn\",\"text\":\"*Outreach Campaign:*\\n[AU] SevenRooms &amp; Delivery MP (Feb 2026)\",\"verbatim\":false}]},{\"type\":\"divider\",\"block_id\":\"R5KSR\"},{\"type\":\"section\",\"block_id\":\"e6Rt8\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Prospect's Reply:*\\n```Kindly go away\\nTy\\n\\nOn 15 Feb 2026, at 2:47\\u202fpm, Alan Goh &lt;alan-goh@oddle.me&gt; wrote:\\n\\n\\n\\nHi Bistro George team,\\n\\nFollowing up on my last note. Most owners we speak with feel they are being \\\"double-taxed\\\", paying a luxury price for SevenRooms and then losing 30% to Uber\\/Doordash on the delivery side.\\n\\n...\\n\\n[Message truncated - view full reply in Lemlist]```\",\"verbatim\":false}},{\"type\":\"divider\",\"block_id\":\"Oc3Rc\"},{\"type\":\"section\",\"block_id\":\"Rk2U6\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Agent Generated Response:*\\n```Hi Austin,\\n\\nThanks for letting me know.\\n\\nI have updated our records accordingly. If you are ever open to taking a look at what Oddle has to offer in driving revenue growth, feel free to reach out anytime.\\n\\nCheers,\\nAlan```\",\"verbatim\":false}},{\"type\":\"context\",\"block_id\":\"6++xQ\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":e-mail: <https:\\/\\/app.lemlist.com\\/teams\\/tea_gYwPePZxuhFb6QraW\\/inbox\\/list\\/myConversations\\/contacts\\/ctc_CSA9qBAjqCBG6po9n|View full conversation in Lemlist>\",\"verbatim\":false}]},{\"type\":\"divider\",\"block_id\":\"KaDxm\"},{\"type\":\"actions\",\"block_id\":\"approval_actions\",\"elements\":[{\"type\":\"button\",\"action_id\":\"approve\",\"text\":{\"type\":\"plain_text\",\"text\":\":white_check_mark: Approve &amp; Send\",\"emoji\":true},\"style\":\"primary\",\"value\":\"<BEFFA2CB-3CD7-4910-B8D8-091E21902EB4@gallagherhotels.com.au>\"},{\"type\":\"button\",\"action_id\":\"reject\",\"text\":{\"type\":\"plain_text\",\"text\":\":pencil2: Reject &amp; Edit\",\"emoji\":true},\"style\":\"danger\",\"url\":\"https:\\/\\/app.lemlist.com\\/teams\\/tea_gYwPePZxuhFb6QraW\\/inbox\\/list\\/myConversations\\/contacts\\/ctc_CSA9qBAjqCBG6po9n\"}]}]},\"state\":{\"values\":{}},\"response_url\":\"https:\\/\\/hooks.slack.com\\/actions\\/T030ZCV78\\/10516124283250\\/HTk00UXUQMyndBSPwz4kfjNo\",\"actions\":[{\"action_id\":\"approve\",\"block_id\":\"approval_actions\",\"text\":{\"type\":\"plain_text\",\"text\":\":white_check_mark: Approve &amp; Send\",\"emoji\":true},\"value\":\"<BEFFA2CB-3CD7-4910-B8D8-091E21902EB4@gallagherhotels.com.au>\",\"style\":\"primary\",\"type\":\"button\",\"action_ts\":\"1771208504.681495\"}]}"
          },
          "webhookUrl": "https://workflow.oddle.center/webhook/slack-reply-approval",
          "executionMode": "production"
        }
      }
    ],
    "Send Email via Lemlist": [
      {
        "json": {
          "error": {
            "message": "400 - \"{\\\"error\\\":\\\"Failed to send email\\\"}\"",
            "name": "AxiosError",
            "stack": "AxiosError: Request failed with status code 400\n    at settle (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/axios@1.12.0/node_modules/axios/lib/core/settle.js:19:12)\n    at RedirectableRequest.handleResponse (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/axios@1.12.0/node_modules/axios/lib/adapters/http.js:565:9)\n    at RedirectableRequest.emit (node:events:531:35)\n    at RedirectableRequest._processResponse (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/follow-redirects@1.15.11/node_modules/follow-redirects/index.js:409:10)\n    at ClientRequest.RedirectableRequest._onNativeResponse (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/follow-redirects@1.15.11/node_modules/follow-redirects/index.js:102:12)\n    at Object.onceWrapper (node:events:634:26)\n    at ClientRequest.emit (node:events:519:28)\n    at HTTPParser.parserOnIncomingClient [as onIncoming] (node:_http_client:772:27)\n    at HTTPParser.parserOnHeadersComplete (node:_http_common:122:17)\n    at TLSSocket.socketOnData (node:_http_client:614:22)\n    at TLSSocket.emit (node:events:519:28)\n    at addChunk (node:internal/streams/readable:561:12)\n    at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)\n    at TLSSocket.Readable.push (node:internal/streams/readable:392:5)\n    at TLSWrap.onStreamRead (node:internal/stream_base_commons:189:23)\n    at TLSWrap.callbackTrampoline (node:internal/async_hooks:130:17)\n    at Axios.request (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/axios@1.12.0/node_modules/axios/lib/core/Axios.js:45:41)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at invokeAxios (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/node-execution-context/utils/request-helper-functions.ts:272:10)\n    at proxyRequestToAxios (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/node-execution-context/utils/request-helper-functions.ts:648:20)\n    at Object.request (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/node-execution-context/utils/request-helper-functions.ts:1789:4)",
            "code": "ERR_BAD_REQUEST",
            "status": 400
          }
        }
      }
    ],
    "Retrieve Conversation History": [
      {
        "json": {
          "data": [
            {
              "_id": "act_zXrfcoZyQroYFpMxZ",
              "type": "emailsReplied",
              "messageId": "<BEFFA2CB-3CD7-4910-B8D8-091E21902EB4@gallagherhotels.com.au>",
              "createdAt": "2026-02-15T03:52:25.000Z",
              "fromEmail": "austin@gallagherhotels.com.au",
              "cc": [
                {
                  "address": "info@jacksonsongeorge.com.au",
                  "name": "Info JoG"
                }
              ],
              "teamId": "tea_gYwPePZxuhFb6QraW",
              "leadId": "lea_49y34p7tQTFqDZf4W",
              "campaignId": "cam_opTZb3C8X9n3htfRM",
              "sequenceId": "seq_cTKSefz5DCvyCEXLY",
              "sequenceStep": 1,
              "sendUserId": "usr_a4ZtLexTdBJtdeSrz",
              "sendUserName": "Alan Goh",
              "sendUserEmail": "alan-goh@oddle.me",
              "sendUserMailboxId": "usm_cqWtW96a78zoiccbe",
              "leadEmail": "info@jacksonsongeorge.com.au",
              "contactId": "ctc_CSA9qBAjqCBG6po9n",
              "message": "<html class=\"apple-mail-supports-explicit-dark-mode\">\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n</head>\n<body dir=\"auto\">\n<div dir=\"ltr\"></div>\n<div dir=\"ltr\">Kindly go away</div>\n<div dir=\"ltr\">Ty</div>\n<div dir=\"ltr\"><br>\n<blockquote type=\"cite\">On 15 Feb 2026, at 2:47â€¯pm, Alan Goh &lt;alan-goh@oddle.me&gt; wrote:<br>\n<br>\n</blockquote>\n</div>\n<blockquote type=\"cite\">\n<div dir=\"ltr\">ï»¿\n<div style=\"min-width:360px\"></div>\n<div dir=\"ltr\">\n<div dir=\"ltr\">\n<div>\n<p id=\"isPasted\" style=\"line-height:1.38;margin:12pt 0px;box-sizing:border-box\" dir=\"ltr\">\nHi Bistro George team,</p>\n<p style=\"line-height:1.38;margin:12pt 0px;box-sizing:border-box\" dir=\"ltr\">Following up on my last note. Most owners we speak with feel they are being &quot;double-taxed&quot;, paying a luxury price for SevenRooms and then losing 30% to Uber/Doordash on the delivery\n side.</p>\n<p style=\"line-height:1.38;margin:12pt 0px;box-sizing:border-box\" dir=\"ltr\">We focus on the fundamentals: high-conversion bookings and a direct web-store that lets you keep your delivery margins.</p>\n<p style=\"line-height:1.38;margin:12pt 0px;box-sizing:border-box\" dir=\"ltr\">Is reducing that total digital overhead a priority for you this quarter?</p>\n<p style=\"line-height:1.38;margin:12pt 0px;box-sizing:border-box\" dir=\"ltr\"><br style=\"box-sizing:border-box\">\n</p>\n<p id=\"isPasted\" style=\"line-height:1.38;margin:12pt 0px;box-sizing:border-box\" dir=\"ltr\">\nBest Regards,<br style=\"box-sizing:border-box\">\nAlan Goh<br style=\"box-sizing:border-box\">\nCo-founder at Oddle</p>\n</div>\n<div class=\"gmail_extra\">\n<div class=\"gmail_signature\" data-smartmail=\"gmail_signature\">\n<div dir=\"ltr\">\n<div>\n<div dir=\"ltr\"></div>\n</div>\n</div>\n</div>\n</div>\n</div>\n<span summary=\"/api/reply/data-ll-tsk_TXmqMxc2wnuoF6m79\"></span><img alt=\"logo\" src=\"https://b2btrack.oddle.me/api/track/open/usr_tN2v4CzXRtSkvwSkg/tsk_TXmqMxc2wnuoF6m79\" height=\"1\" width=\"1\" data-unique-identifier=\"\"></div>\n<br>\n</div>\n</blockquote>\n<br>\n<strong>Warm Regards,</strong> <br>\n<br>\n<h3>Austin Gallagher<br>\n<br>\n</h3>\n<br>\n<p class=\"small\">t&nbsp;0458 100 491&nbsp;e&nbsp; Austin@gallagherhotels.com.au </p>\n<p class=\"small\">&nbsp;<br>\n<br>\nGroup Operations Manager <br>\nGallagher Hotels <br>\n<br>\n<a href=\"https://www.gallagherhotels.com.au/\"><img alt=\"\" height=\"273\" src=\"https://signatures.ghm.net.au/ghm2023-9.jpg\" style=\"border-width: 0;\" width=\"683\"></a>\n</p>\n</body>\n</html>\n",
              "subject": "Re: Is Bistro George overpaying for SevenRooms?",
              "attachments": []
            },
            {
              "_id": "act_NJ8f2MRurDgQTTeKc",
              "type": "emailsSent",
              "messageId": "<CAFaDERixTLiMSYuN_kVNCsAtCpP=VobLiQf_T_rRxKEqp9W0TA@mail.gmail.com>",
              "createdAt": "2026-02-15T03:46:56.586Z",
              "teamId": "tea_gYwPePZxuhFb6QraW",
              "leadId": "lea_49y34p7tQTFqDZf4W",
              "campaignId": "cam_opTZb3C8X9n3htfRM",
              "sequenceId": "seq_cTKSefz5DCvyCEXLY",
              "sequenceStep": 1,
              "sendUserId": "usr_a4ZtLexTdBJtdeSrz",
              "sendUserName": "Alan Goh",
              "sendUserEmail": "alan-goh@oddle.me",
              "sendUserMailboxId": "usm_cqWtW96a78zoiccbe",
              "leadEmail": "info@jacksonsongeorge.com.au",
              "contactId": "ctc_CSA9qBAjqCBG6po9n",
              "message": "<html><div style=\"min-width: 360px\"></div><div dir=\"ltr\"><div dir=\"ltr\">\n    <div><p id=\"isPasted\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\" dir=\"ltr\">Hi Bistro George team,</p><p style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\" dir=\"ltr\">Following up on my last note. Most owners we speak with feel they are being \"double-taxed\", paying a luxury price for SevenRooms and then losing 30% to Uber/Doordash on the delivery side.</p><p style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\" dir=\"ltr\">We focus on the fundamentals: high-conversion bookings and a direct web-store that lets you keep your delivery margins.</p><p style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\" dir=\"ltr\">Is reducing that total digital overhead a priority for you this quarter?</p><p style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\" dir=\"ltr\"><br style=\"box-sizing: border-box;\"></p><p id=\"isPasted\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\" dir=\"ltr\">Best Regards,<br style=\"box-sizing: border-box;\">Alan Goh<br style=\"box-sizing: border-box;\">Co-founder at Oddle</p></div>\n    <div class=\"gmail_extra\">\n      <div class=\"gmail_signature\" data-smartmail=\"gmail_signature\"><div dir=\"ltr\"><div><div dir=\"ltr\"></div></div></div></div>\n      \n    </div>\n    </div>\n<span summary=\"/api/reply/data-ll-tsk_TXmqMxc2wnuoF6m79\"></span>\n<img alt=\"logo\" src=\"https://b2btrack.oddle.me/api/track/open/usr_tN2v4CzXRtSkvwSkg/tsk_TXmqMxc2wnuoF6m79\" height=\"1\" width=\"1\"></div><br></html>",
              "subject": "Is Bistro George overpaying for SevenRooms?",
              "attachments": []
            },
            {
              "_id": "act_bjTjQwyQoM9xrSBvR",
              "type": "emailsSent",
              "messageId": "<CAFaDERhCSMBVFJoFE6g3hiNFYRf604di6OnWT54QSZ7S93=7aw@mail.gmail.com>",
              "createdAt": "2026-02-12T02:27:25.709Z",
              "teamId": "tea_gYwPePZxuhFb6QraW",
              "leadId": "lea_49y34p7tQTFqDZf4W",
              "campaignId": "cam_opTZb3C8X9n3htfRM",
              "sequenceId": "seq_cTKSefz5DCvyCEXLY",
              "sequenceStep": 0,
              "sendUserId": "usr_a4ZtLexTdBJtdeSrz",
              "sendUserName": "Alan Goh",
              "sendUserEmail": "alan-goh@oddle.me",
              "sendUserMailboxId": "usm_cqWtW96a78zoiccbe",
              "leadEmail": "info@jacksonsongeorge.com.au",
              "contactId": "ctc_CSA9qBAjqCBG6po9n",
              "message": "<html><div style=\"min-width: 360px\"></div><div dir=\"ltr\"><div dir=\"ltr\">\n    <div><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\" id=\"isPasted\">Hi Bistro George team,</p><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\">Noticed Bistro George is using SevenRooms.</p><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\">Quick question: are you getting full value from it, or mostly using the core reservation workflows while paying an enterprise price?</p><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\">Oddle Reserve is a simpler alternative. In Australia we are <strong style=\"font-weight: 700; box-sizing: border-box;\">A$249/month per brand</strong>, not per outlet.</p><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\">We are also offering <strong style=\"font-weight: 700; box-sizing: border-box;\">Founder Access</strong> for a limited number of AU brands:</p><ul style=\"margin-top: 0px; margin-bottom: 0px; padding-inline-start: 48px; box-sizing: border-box;\"><li dir=\"ltr\" style=\"list-style-type: disc; font-size: 11pt; font-family: Arial, sans-serif; color: rgb(0, 0, 0); background-color: transparent; font-weight: bold; font-style: normal; font-variant: normal; text-decoration: none; vertical-align: baseline; white-space: pre; box-sizing: border-box;\"><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px 0pt; box-sizing: border-box;\"><strong style=\"font-weight: 700; box-sizing: border-box;\">A$65/month, locked in forever</strong></p></li><li dir=\"ltr\" style=\"list-style-type: disc; font-size: 11pt; font-family: Arial, sans-serif; color: rgb(0, 0, 0); background-color: transparent; font-weight: 400; font-style: normal; font-variant: normal; text-decoration: none; vertical-align: baseline; white-space: pre; box-sizing: border-box;\"><p dir=\"ltr\" style=\"line-height: 1.38; margin: 0pt 0px 12pt; box-sizing: border-box;\">We work closely with early partners to use your data to surface insights and maximise revenue, not just â€œswitch softwareâ€</p></li></ul><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\">Open to a quick 12-minute chat this week to see if it makes sense for Bistro George?</p><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\"><br style=\"box-sizing: border-box;\"></p><p dir=\"ltr\" style=\"line-height: 1.38; margin: 12pt 0px; box-sizing: border-box;\">Best Regards,<br style=\"box-sizing: border-box;\">Alan Goh<br style=\"box-sizing: border-box;\">Co-founder at Oddle</p></div>\n    <div class=\"gmail_extra\">\n      <div class=\"gmail_signature\" data-smartmail=\"gmail_signature\"><div dir=\"ltr\"><div><div dir=\"ltr\"></div></div></div></div>\n      \n    </div>\n    </div>\n<span summary=\"/api/reply/data-ll-tsk_XzwSBE5q9hGvyeakp\"></span>\n<img alt=\"logo\" src=\"https://b2btrack.oddle.me/api/track/open/usr_tN2v4CzXRtSkvwSkg/tsk_XzwSBE5q9hGvyeakp\" height=\"1\" width=\"1\"></div><br></html>",
              "subject": "Question about SevenRooms overhead",
              "attachments": []
            }
          ],
          "pagination": {
            "totalItems": 3,
            "currentPage": 1,
            "nextPage": null,
            "previousPage": null,
            "perPage": 10,
            "totalPages": 1
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Parse Conversation History": [
      {
        "json": {
          "subject": "Re: Is Bistro George overpaying for SevenRooms?",
          "sendUserId": "usr_a4ZtLexTdBJtdeSrz",
          "sendUserEmail": "alan-goh@oddle.me",
          "sendUserMailboxId": "usm_cqWtW96a78zoiccbe",
          "contactId": "ctc_CSA9qBAjqCBG6po9n",
          "leadId": "lea_49y34p7tQTFqDZf4W",
          "cc": [
            {
              "address": "info@jacksonsongeorge.com.au",
              "name": "Info JoG"
            }
          ],
          "leadMessage": "Kindly go away Ty On 15 Feb 2026, at 2:47 pm, Alan Goh <alan-goh@oddle.me> wrote: Hi Bistro George team, Following up on my last note. Most owners we speak with feel they are being \"double-taxed\", paying a luxury price for SevenRooms and then losing 30% to Uber/Doordash on the delivery side. We focus on the fundamentals: high-conversion bookings and a direct web-store that lets you keep your delivery margins. Is reducing that total digital overhead a priority for you this quarter? Best Regards, "
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Parse Slack Payload": [
      {
        "json": {
          "action_id": "approve",
          "slack_channel_id": "C0AB3U5B1D4",
          "slack_channel_name": "noti-sdr-email-agent",
          "slack_user_name": "chloei.garcia",
          "company_name": "Bistro George",
          "lead_identifier": "info@jacksonsongeorge.com.au",
          "reply_from_email": "austin@gallagherhotels.com.au",
          "campaign_name": "[AU] SevenRooms & Delivery MP (Feb 2026)",
          "lead_message": "Kindly go away\nTy\n\nOn 15 Feb 2026, at 2:47â€¯pm, Alan Goh <alan-goh@oddle.me> wrote:\n\n\n\nHi Bistro George team,\n\nFollowing up on my last note. Most owners we speak with feel they are being \"double-taxed\", paying a luxury price for SevenRooms and then losing 30% to Uber/Doordash on the delivery side.\n\n...\n\n[Message truncated - view full reply in Lemlist]",
          "ai_generated_response": "Hi Austin,\n\nThanks for letting me know.\n\nI have updated our records accordingly. If you are ever open to taking a look at what Oddle has to offer in driving revenue growth, feel free to reach out anytime.\n\nCheers,\nAlan",
          "lemlist_contact_id": "ctc_CSA9qBAjqCBG6po9n",
          "lemlist_team_id": "tea_gYwPePZxuhFb6QraW",
          "lemlist_message_id": "<BEFFA2CB-3CD7-4910-B8D8-091E21902EB4@gallagherhotels.com.au>",
          "user_id": "U06UPB4K0AW",
          "response_url": "https://hooks.slack.com/actions/T030ZCV78/10516124283250/HTk00UXUQMyndBSPwz4kfjNo",
          "original_message_ts": "1771128220.011909",
          "team_id": "T030ZCV78"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "969208ea-49ff-498f-949a-3ec6f8a2c56f",
  "activeVersionId": "969208ea-49ff-498f-949a-3ec6f8a2c56f",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-01-14T09:14:31.594Z",
      "createdAt": "2026-01-14T09:14:31.594Z",
      "role": "workflow:owner",
      "workflowId": "Z4BV7uCQ8dSjXR1w",
      "projectId": "tAHBdayTR1Nb6OKK"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-02-16T03:28:41.309Z",
    "createdAt": "2026-02-16T03:28:39.149Z",
    "versionId": "969208ea-49ff-498f-949a-3ec6f8a2c56f",
    "workflowId": "Z4BV7uCQ8dSjXR1w",
    "nodes": [
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.update",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"ts\": \"{{ $('Parse Slack Payload').item.json.original_message_ts }}\",\n  \"text\": \"Prospect reply approved\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Lead Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.lead_identifier }}|{{ $('Parse Slack Payload').item.json.lead_identifier }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Reply-from Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.reply_from_email }}|{{ $('Parse Slack Payload').item.json.reply_from_email }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ $('Parse Slack Payload').item.json.lead_message && $('Parse Slack Payload').item.json.lead_message.length > 500 ? $('Parse Slack Payload').item.json.lead_message.substring(0, 500).replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') + '\\\\n\\\\n[Message truncated - view full reply in Lemlist]' : ($('Parse Slack Payload').item.json.lead_message || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ ($('Parse Slack Payload').item.json.ai_generated_response || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View full conversation in Lemlist>\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \":white_check_mark: *Approved* by <@{{ $('Parse Slack Payload').item.json.user_id }}>\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          720,
          -32
        ],
        "name": "Update Message - Approved",
        "id": "c0bb6280-cc23-4bba-8cde-1993c51dd7ee",
        "credentials": {
          "httpBearerAuth": {
            "id": "A9y0ZdmG00hI8udd",
            "name": "Slack's Email SDR Agent"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.update",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"ts\": \"{{ $('Parse Slack Payload').item.json.original_message_ts }}\",\n  \"text\": \"Prospect reply - send failed\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Lead Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.lead_identifier }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Reply-from Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.reply_from_email }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ \n  (function() {\n    let rawText = $('Parse Slack Payload').item.json.lead_message || '';\n    \n    let truncated = rawText.length > 500 \n      ? rawText.substring(0, 500) + '\\n\\n[Message truncated - view full reply in Lemlist]' \n      : rawText;\n    \n    return JSON.stringify(truncated).slice(1, -1);\n  })()\n}}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ \n  (function() {\n    let agentText = $('Parse Slack Payload').item.json.ai_generated_response || ''; \n    return JSON.stringify(agentText).slice(1, -1);\n  })()\n}}```\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View full conversation in Lemlist>\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \":x: *Email Send Failed* - Approved by <@{{ $('Parse Slack Payload').item.json.user_id }}>\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1936,
          320
        ],
        "name": "Update Message - Error",
        "id": "5e15d02c-1bd0-4e09-b25b-503cc1a61c72",
        "credentials": {
          "httpBearerAuth": {
            "id": "A9y0ZdmG00hI8udd",
            "name": "Slack's Email SDR Agent"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.update",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"ts\": \"{{ $('Parse Slack Payload').item.json.original_message_ts }}\",\n  \"text\": \"Prospect reply rejected\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Lead Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.lead_identifier }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Reply-from Email:*\\n<mailto:{{ $('Parse Slack Payload').item.json.reply_from_email }}>\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ $('Parse Slack Payload').item.json.lead_message && $('Parse Slack Payload').item.json.lead_message.length > 500 ? $('Parse Slack Payload').item.json.lead_message.substring(0, 500).replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') + '\\\\n\\\\n[Message truncated - view full reply in Lemlist]' : ($('Parse Slack Payload').item.json.lead_message || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ ($('Parse Slack Payload').item.json.ai_generated_response || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View full conversation in Lemlist>\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \":no_entry: *Rejected* by <@{{ $('Parse Slack Payload').item.json.user_id }}>\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          720,
          416
        ],
        "name": "Update Message - Rejected",
        "id": "a374ed4a-89e5-41ac-bc27-5b3d2afc32a5",
        "credentials": {
          "httpBearerAuth": {
            "id": "A9y0ZdmG00hI8udd",
            "name": "Slack's Email SDR Agent"
          }
        }
      },
      {
        "parameters": {
          "content": "When a user clicks a button in Slack, Slack sends a webhook payload to n8n workflow and expects a response within 3 seconds. Otherwise, it'll show an operation time-out error "
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          64,
          496
        ],
        "typeVersion": 1,
        "id": "06eed927-712c-458c-9779-cdaba5654b58",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "modelName": "models/gemini-2.0-flash",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          2224,
          352
        ],
        "name": "Google Gemini Chat1",
        "id": "351b911a-8b4a-4d00-8289-4488de226201",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n  \"topic\": \"pricing\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          2496,
          352
        ],
        "name": "Topic Output Parser1",
        "id": "23f02daf-e5c4-460d-9ad2-883318391959"
      },
      {
        "parameters": {
          "modelName": "models/gemini-embedding-001"
        },
        "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
        "typeVersion": 1,
        "position": [
          2832,
          368
        ],
        "name": "Google Gemini Embeddings",
        "id": "045d227b-111b-4782-a8d7-f421af33fb35",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Parse conversation history to extract subject, metadata, and lead message\n\n  const messages = $input.first().json.data || [];\n  const latestMessage = messages[0] || {};\n\n  // Extract subject line\n  let subject = latestMessage.subject || 'Re: Follow-up';\n  if (!subject.toLowerCase().startsWith('re:')) {\n    subject = 'Re: ' + subject;\n  }\n\n  // Find the first email sent by us for metadata\n  const sentMessage = messages.find(msg => msg.type === 'emailsSent') || latestMessage;\n\n  // Find the latest lead message (type: \"emailsReplied\")\n  const leadReply = messages.find(msg => msg.type === 'emailsReplied');\n  let leadMessage = '';\n\n  if (leadReply && leadReply.message) {\n    // Clean up HTML tags and decode entities\n    leadMessage = leadReply.message\n      .replace(/<[^>]*>/g, '')           // Remove HTML tags\n      .replace(/&lt;/g, '<')             // Decode HTML entities\n      .replace(/&gt;/g, '>')\n      .replace(/&amp;/g, '&')\n      .replace(/&nbsp;/g, ' ')\n      .replace(/&#39;/g, \"'\")            // Decode apostrophe\n      .replace(/&quot;/g, '\"')           // Decode quotes\n      .replace(/&#x27;/g, \"'\")           // Decode hex apostrophe\n      .replace(/&apos;/g, \"'\")           // Decode apos\n      .replace(/\\s+/g, ' ')              // Collapse multiple spaces\n      .trim()                            // Remove leading/trailing whitespace\n      .substring(0, 500);                // Truncate to 500 characters\n  }\n\n  // Handle CC\n  let cc = null;\n  if (Array.isArray(sentMessage.cc)) {\n    cc = sentMessage.cc.length > 0 ? sentMessage.cc : null;\n  } else if (Array.isArray(latestMessage.cc)) {\n    cc = latestMessage.cc.length > 0 ? latestMessage.cc : null;\n  }\n\n  return {\n    json: {\n      subject: subject,\n      sendUserId: sentMessage.sendUserId || null,\n      sendUserEmail: sentMessage.sendUserEmail || null,\n      sendUserMailboxId: sentMessage.sendUserMailboxId || null,\n      contactId: latestMessage.contactId || null,\n      leadId: latestMessage.leadId || null,\n      cc: cc,\n      leadMessage: leadMessage  // Cleaned and truncated lead message\n    }\n  };"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          944,
          192
        ],
        "name": "Parse Conversation History",
        "id": "c8f231c4-a50f-47f9-9677-477c2c5d482e"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "slack-reply-approval",
          "responseMode": "responseNode",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1.1,
        "position": [
          -144,
          128
        ],
        "name": "Slack Webhook Trigger",
        "webhookId": "slack-reply-approval",
        "id": "8f0b0f30-e8aa-4f1e-886a-95cfe672fa47"
      },
      {
        "parameters": {
          "respondWith": "text",
          "responseBody": "OK",
          "options": {
            "responseCode": 200
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1,
        "position": [
          64,
          320
        ],
        "name": "Respond to Slack",
        "id": "8262bccd-7e74-46ba-a844-7a1f4d9aabd5"
      },
      {
        "parameters": {
          "jsCode": "// Parse Slack interaction payload for RLHF\nconst payload = $input.first().json.body.payload;\nlet parsedPayload;\n\nif (typeof payload === 'string') {\n  parsedPayload = JSON.parse(payload);\n} else {\n  parsedPayload = payload;\n}\n\n// Helper function to decode Slack HTML entities\nconst decode = (str) => {\n  if (!str) return null;\n  return str\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>');\n};\n\n// Extract basic action details\nconst action = parsedPayload.actions?.[0];\nconst actionId = action?.action_id;\nconst user = parsedPayload.user;\nconst channel = parsedPayload.channel;\nconst responseUrl = parsedPayload.response_url;\n\n// Helper function to extract text from markdown field\nfunction extractFromField(blocks, label) {\n  for (const block of blocks) {\n    if (block.type === 'section' && block.fields) {\n      for (const field of block.fields) {\n        if (field.text && field.text.includes(label)) {\n          const parts = field.text.split('\\n');\n          if (parts.length > 1) {\n            let value = parts[1];\n            const emailMatch = value.match(/<mailto:([^|>]+)\\|/);\n            if (emailMatch) {\n              return emailMatch[1];\n            }\n            return value.trim();\n          }\n        }\n      }\n    }\n  }\n  return null;\n}\n\n// Helper function to extract text from section with specific header\nfunction extractSectionText(blocks, header) {\n  for (const block of blocks) {\n    if (block.type === 'section' && block.text && block.text.text) {\n      if (block.text.text.includes(header)) {\n        const text = block.text.text;\n        const codeBlockMatch = text.match(/```([\\s\\S]*?)```/);\n        if (codeBlockMatch) {\n          return codeBlockMatch[1].trim();\n        }\n        const parts = text.split(header);\n        if (parts.length > 1) {\n          return parts[1].replace(/^\\n/, '').trim();\n        }\n      }\n    }\n  }\n  return null;\n}\n\n// Helper function to extract Lemlist IDs from URL in context block\nfunction extractLemlistIds(blocks) {\n  for (const block of blocks) {\n    if (block.type === 'context' && block.elements) {\n      for (const element of block.elements) {\n        if (element.text && element.text.includes('app.lemlist.com')) {\n          const urlMatch = element.text.match(/https:\\/\\/app\\.lemlist\\.com\\/teams\\/([^\\/]+)\\/inbox\\/list\\/myConversations\\/contacts\\/([^|>]+)/);\n          if (urlMatch) {\n            return {\n              teamId: urlMatch[1],\n              contactId: urlMatch[2]\n            };\n          }\n        }\n      }\n    }\n  }\n  return { teamId: null, contactId: null };\n}\n\nconst blocks = parsedPayload.message?.blocks || [];\n\n// Apply decoding during extraction\nconst companyName = decode(extractFromField(blocks, '*Company:*'));\nconst leadEmail = extractFromField(blocks, '*Lead Email:*');\nconst replyFromEmail = extractFromField(blocks, '*Reply-from Email:*');\nconst outreachCampaign = decode(extractFromField(blocks, '*Outreach Campaign:*'));\nconst prospectReply = decode(extractSectionText(blocks, \"*Prospect's Reply:*\"));\nconst agentResponse = decode(extractSectionText(blocks, '*Agent Generated Response:*'));\nconst lemlistIds = extractLemlistIds(blocks);\nconst lemlistMessageId = action?.value;\n\nreturn {\n  json: {\n    action_id: actionId,\n    slack_channel_id: channel?.id,\n    slack_channel_name: channel?.name,\n    slack_user_name: user?.name || user?.username,\n    company_name: companyName,\n    lead_identifier: leadEmail,\n    reply_from_email: replyFromEmail,\n    campaign_name: outreachCampaign,\n    lead_message: prospectReply,\n    ai_generated_response: agentResponse,\n    lemlist_contact_id: lemlistIds.contactId,\n    lemlist_team_id: lemlistIds.teamId,\n    lemlist_message_id: lemlistMessageId,\n    user_id: user?.id,\n    response_url: responseUrl,\n    original_message_ts: parsedPayload.message?.ts,\n    team_id: parsedPayload.team?.id\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          272,
          320
        ],
        "name": "Parse Slack Payload",
        "id": "0840d52c-e4d6-450e-97a1-ea46837a4936"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "condition-approve",
                "leftValue": "={{ $json.action_id }}",
                "rightValue": "approve",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          496,
          320
        ],
        "name": "Check Action",
        "id": "f8866b04-bfe6-4ddb-9c34-1205e3a37afc"
      },
      {
        "parameters": {
          "url": "=https://api.lemlist.com/api/inbox/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "lemlistApi",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          720,
          192
        ],
        "name": "Retrieve Conversation History",
        "id": "f29fcfaa-b69c-4eb3-9837-c777e32f9ef6",
        "credentials": {
          "lemlistApi": {
            "id": "6dgMHleAsx5bfyF9",
            "name": "Lemlist account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.lemlist.com/api/inbox/email",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBasicAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "sendUserId",
                "value": "={{ $json.sendUserId }}"
              },
              {
                "name": "sendUserEmail",
                "value": "={{ $json.sendUserEmail }}"
              },
              {
                "name": "sendUserMailboxId",
                "value": "={{ $json.sendUserMailboxId }}"
              },
              {
                "name": "contactId",
                "value": "={{ $json.contactId }}"
              },
              {
                "name": "leadId",
                "value": "={{ $json.leadId }}"
              },
              {
                "name": "subject",
                "value": "={{ $json.subject }}"
              },
              {
                "name": "message",
                "value": "={{ '<p>' + $('Parse Slack Payload').item.json.ai_generated_response.split('\\n\\n').map(para => para.replace(/\\n/g, '<br>')).join('</p><p>') + '</p>' }}"
              },
              {
                "name": "cc",
                "value": "={{ $json.cc.map(item => item.address).join(', ') }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1152,
          192
        ],
        "name": "Send Email via Lemlist",
        "id": "80d7a160-204b-4808-b891-1818a837e993",
        "credentials": {
          "lemlistApi": {
            "id": "6dgMHleAsx5bfyF9",
            "name": "Lemlist account"
          },
          "httpBasicAuth": {
            "id": "ErJHjZR0I2frgqLU",
            "name": "Lemlist Account"
          }
        },
        "continueOnFail": true
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "condition-send-success",
                "leftValue": "={{ $json.error }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "isEmpty"
                }
              },
              {
                "id": "a9b819a9-7bac-4399-984e-28e3ddfd0802",
                "leftValue": "={{ $json.ok }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          1200,
          576
        ],
        "name": "Check Send Status",
        "id": "87b3f84c-9d61-4c75-838e-8be311c3810f"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"text\": \"Failed to send email\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":x: Failed to Send Email\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Error Details:*\\n```{{ \n  (function() {\n    let errorText = $json.error.message || ''; \n    \n    return JSON.stringify(errorText).slice(1, -1);\n  })()\n}}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*To:*\\n{{ $('Parse Slack Payload').item.json.reply_from_email }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":warning: Error sending email, please send the reply manually in Lemlist\"\n        }\n      ]\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1680,
          320
        ],
        "name": "Post Error status to Slack",
        "id": "98f56553-2067-46d6-9bc4-1e233be2acd7",
        "credentials": {
          "httpBearerAuth": {
            "id": "A9y0ZdmG00hI8udd",
            "name": "Slack's Email SDR Agent"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Parse Conversation History').item.json.leadMessage }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are an AI assistant that categorizes prospect messages into topics.\n\nAnalyze the prospect's message and categorize it into ONE of the following topics:\n\n**Valid Topics:**\n- pricing: Questions about cost, pricing plans, discounts, payment terms\n- product_feature: Questions about specific features, functionality, capabilities\n- competitor_comparison: Comparisons with competitors, asking why choose us\n- objection: Concerns, doubts, hesitations, or pushback\n- interested: Expressing interest, wanting to learn more, positive signals\n- not_interested: Clearly not interested, politely declining, no need\n- timing: Questions about implementation timeline, when to start, availability\n- technical: Technical questions, integrations, API, security, compliance\n- scheduling: Requesting a demo, meeting, call, or follow-up\n- general_inquiry: General questions that don't fit other categories\n- auto_reply: Auto-replies, bot replies, out of office messages\n\n**Instructions:**\n1. Read the prospect's message carefully\n2. Identify the main intent or topic\n3. Return ONLY the topic keyword (e.g., \"pricing\", \"product_feature\")\n4. Use lowercase and underscores for multi-word topics\n5. Choose the MOST relevant single topic\n\n**Output Format:**\nReturn a JSON object with the topic:\n{\n  \"topic\": \"<topic_keyword>\"\n}\n\n**Examples:**\nMessage: \"How much does this cost?\"\nOutput: {\"topic\": \"pricing\"}\n\nMessage: \"Does it integrate with POS?\"\nOutput: {\"topic\": \"technical\"}\n\nMessage: \"Not interested right now, thanks.\"\nOutput: {\"topic\": \"not_interested\"}\n\nMessage: \"Can you tell me more about the reporting features?\"\nOutput: {\"topic\": \"product_feature\"}"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          2272,
          160
        ],
        "name": "Categorize Lead Message Topic",
        "id": "d2a301d8-dc58-4b20-b37c-001a3994ac36"
      },
      {
        "parameters": {
          "jsCode": "// Retrieve data\nconst leadMessage = $('Parse Conversation History').first().json.leadMessage;\nconst responseSent = $('Parse Slack Payload').first().json.ai_generated_response;\nconst rawTopic = $('Categorize Lead Message Topic').first().json.output?.topic || 'general_inquiry';\n\n// Capitalize the first letter of the topic (e.g., 'objection' -> 'Objection')\nconst topic = rawTopic.charAt(0).toUpperCase() + rawTopic.slice(1);\n\n// Construct the structured pageContent string\n// Note: This uses backticks to maintain the line breaks exactly as they will appear in the DB\nconst formattedContent = `Prospectâ€™s message: \n\"${leadMessage}\"\n\nHow to respond: \n\n${responseSent}`;\n\nreturn {\n  json: {\n    pageContent: formattedContent,\n    metadata: {\n      topic: topic,\n      created_at: new Date().toISOString() // Recommended for DB sorting\n    }\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2656,
          160
        ],
        "name": "Prepare Training Document",
        "id": "823e7e48-60d6-469e-91fe-a159ca48d587"
      },
      {
        "parameters": {
          "mode": "insert",
          "tableName": {
            "__rl": true,
            "value": "response_handling_guide",
            "mode": "list",
            "cachedResultName": "response_handling_guide"
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1,
        "position": [
          2896,
          160
        ],
        "name": "Store Approved Response to DB",
        "id": "fd9b425c-1d74-4b9d-a011-a9784c5709ee",
        "credentials": {
          "supabaseApi": {
            "id": "aJzMx5t2Q4kcZ8EL",
            "name": "Supabase Account"
          }
        }
      },
      {
        "parameters": {
          "jsonMode": "expressionData",
          "jsonData": "={{ $json.pageContent }}",
          "textSplittingMode": "custom",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
        "typeVersion": 1.1,
        "position": [
          3024,
          368
        ],
        "id": "b9f78736-bc0b-4bce-8b18-dfae149e0616",
        "name": "Default Data Loader"
      },
      {
        "parameters": {
          "separator": "*&^%$&*()",
          "chunkSize": 1000000
        },
        "type": "@n8n/n8n-nodes-langchain.textSplitterCharacterTextSplitter",
        "typeVersion": 1,
        "position": [
          3024,
          544
        ],
        "id": "3ea452e2-4307-45f7-a0f3-75a824b97cce",
        "name": "Character Text Splitter"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"{{ $('Parse Slack Payload').item.json.slack_channel_id }}\",\n  \"text\": \"Email sent successfully!\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":white_check_mark: Email Sent Successfully\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*To:*\\n{{ $('Parse Slack Payload').item.json.reply_from_email }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Company:*\\n{{ $('Parse Slack Payload').item.json.company_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Approved by:*\\n{{ $('Parse Slack Payload').item.json.slack_user_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Outreach Campaign:*\\n{{ $('Parse Slack Payload').item.json.campaign_name }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Parse Slack Payload').item.json.lemlist_team_id }}/inbox/list/myConversations/contacts/{{ $('Parse Slack Payload').item.json.lemlist_contact_id }}|View conversation in Lemlist>\"\n        }\n      ]\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1680,
          32
        ],
        "name": "Post Success status to Slack",
        "id": "a859ec25-2b54-40cd-a4b3-f3210f3d7a22",
        "credentials": {
          "httpBearerAuth": {
            "id": "A9y0ZdmG00hI8udd",
            "name": "Slack's Email SDR Agent"
          }
        }
      },
      {
        "parameters": {
          "content": "## Not used for now",
          "height": 720,
          "width": 1344
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          2144,
          16
        ],
        "typeVersion": 1,
        "id": "af35ec51-56f1-4d3f-9406-6b57dc05bca4",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "content": "## Workflow 2: Process human-approved response\n\n",
          "height": 100,
          "width": 640,
          "color": 4
        },
        "id": "a6db13ed-5248-4314-b37a-1ad78fd6d56a",
        "name": "Sticky Note16",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -160,
          -64
        ],
        "typeVersion": 1
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.ok }}",
                      "rightValue": true,
                      "operator": {
                        "type": "boolean",
                        "operation": "equals"
                      },
                      "id": "f8b49112-55c9-470e-9925-5d6aafdf74df"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Send success"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "d10af122-becb-4eb2-bc29-b810356f05df",
                      "leftValue": "={{ $json.error }}",
                      "rightValue": "",
                      "operator": {
                        "type": "object",
                        "operation": "notEmpty",
                        "singleValue": true
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Error sending"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          1376,
          192
        ],
        "id": "be1d0f2d-ceb6-4a57-b8cd-b6fdc61c84df",
        "name": "Switch"
      }
    ],
    "connections": {
      "Google Gemini Chat1": {
        "ai_languageModel": [
          [
            {
              "node": "Categorize Lead Message Topic",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Topic Output Parser1": {
        "ai_outputParser": [
          [
            {
              "node": "Categorize Lead Message Topic",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Embeddings": {
        "ai_embedding": [
          [
            {
              "node": "Store Approved Response to DB",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Parse Conversation History": {
        "main": [
          [
            {
              "node": "Send Email via Lemlist",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Slack Webhook Trigger": {
        "main": [
          [
            {
              "node": "Respond to Slack",
              "type": "main",
              "index": 0
            },
            {
              "node": "Parse Slack Payload",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Slack Payload": {
        "main": [
          [
            {
              "node": "Check Action",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Action": {
        "main": [
          [
            {
              "node": "Retrieve Conversation History",
              "type": "main",
              "index": 0
            },
            {
              "node": "Update Message - Approved",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Update Message - Rejected",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Retrieve Conversation History": {
        "main": [
          [
            {
              "node": "Parse Conversation History",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Email via Lemlist": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Send Status": {
        "main": [
          [],
          []
        ]
      },
      "Post Error status to Slack": {
        "main": [
          [
            {
              "node": "Update Message - Error",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Categorize Lead Message Topic": {
        "main": [
          [
            {
              "node": "Prepare Training Document",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Training Document": {
        "main": [
          [
            {
              "node": "Store Approved Response to DB",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Store Approved Response to DB": {
        "main": [
          []
        ]
      },
      "Default Data Loader": {
        "ai_document": [
          [
            {
              "node": "Store Approved Response to DB",
              "type": "ai_document",
              "index": 0
            }
          ]
        ]
      },
      "Character Text Splitter": {
        "ai_textSplitter": [
          [
            {
              "node": "Default Data Loader",
              "type": "ai_textSplitter",
              "index": 0
            }
          ]
        ]
      },
      "Post Success status to Slack": {
        "main": [
          []
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Post Success status to Slack",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Post Error status to Slack",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Oddle Engineer",
    "name": "Version 969208ea",
    "description": "",
    "autosaved": false
  },
  "tags": []
}