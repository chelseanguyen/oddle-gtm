{
  "updatedAt": "2026-01-15T03:39:42.726Z",
  "createdAt": "2026-01-15T03:16:53.546Z",
  "id": "A5PDymR3ncd1dzpi",
  "name": "Templates for WA agent",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.body.conversation.messages[0].attachments[0].data_url }}"
      },
      "id": "b22b366a-9ab9-40fe-9f4a-5e5ea8a91b10",
      "name": "Get Audio URL1",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        -400,
        -96
      ],
      "typeVersion": 1,
      "webhookId": "fe300906-a266-45b4-b656-f70168ddf640"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.body.conversation.messages[0].attachments[0].data_url }}"
      },
      "id": "dc7dfc54-f387-4a2d-a826-27c2f6708493",
      "name": "Get Image URL1",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        -400,
        176
      ],
      "typeVersion": 1,
      "webhookId": "332ceb06-df84-450b-b88b-320d02dd3569"
    },
    {
      "parameters": {
        "url": "={{ $json.id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "="
            }
          ]
        },
        "options": {}
      },
      "id": "5efc2a70-5f78-4bd8-ac98-c8caa97b5347",
      "name": "Download Audio1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -256,
        -96
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "={{ $json.id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "id": "4f586ac0-5e61-471f-a0d8-477447fc2e03",
      "name": "Download Image1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -256,
        176
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
              "name": "message_text",
              "type": "string",
              "value": "={{ $json.content }}"
            },
            {
              "id": "da4b602a-28ca-4b0d-a747-c3d3698c3731",
              "name": "message_caption",
              "type": "string",
              "value": "={{ $('Redirect Message Types1').item.json.video && $('Redirect Message Types1').item.json.video.caption || '' }}\n{{ $('Redirect Message Types1').item.json.image && $('Redirect Message Types1').item.json.image.caption || ''}}\n{{ $('Redirect Message Types1').item.json.audio && $('Redirect Message Types1').item.json.audio.caption || ''}}"
            }
          ]
        },
        "options": {}
      },
      "id": "1d291dc0-3f59-44af-aa0f-90423dcdf00a",
      "name": "Get User's Message2",
      "type": "n8n-nodes-base.set",
      "position": [
        64,
        176
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.body.conversation.messages[0].attachments[0].file_type == 'audio'}}",
                    "rightValue": "audio",
                    "id": "39210c4d-d9fb-4fb0-a92f-754e018c4ec9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "05b30af4-967b-4824-abdc-84a8292ac0e5",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.body.conversation.messages[0].attachments[0].file_type == 'image' }}",
                    "rightValue": ""
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image Message"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Text Message"
        }
      },
      "id": "57b60c11-5279-47b7-b9f4-a6cef8dfe969",
      "name": "Redirect Message Types1",
      "type": "n8n-nodes-base.switch",
      "position": [
        -752,
        160
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "amount": 0
      },
      "id": "3efa7232-27f7-4800-8352-b7789be82517",
      "name": "Get Text1",
      "type": "n8n-nodes-base.wait",
      "position": [
        -368,
        448
      ],
      "webhookId": "d8eb5361-fdd3-4acd-8ba4-d632048a1c8d",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "9f48daee-e06d-410e-8e8c-243b48e6188b",
      "name": "Format Response",
      "type": "n8n-nodes-base.set",
      "position": [
        64,
        -96
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -96,
        -96
      ],
      "id": "6c227f2d-e924-41cd-be27-4458c851ba7a",
      "name": "OpenAI"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d990cbd6-a408-4ec4-a889-41be698918d9",
              "name": "message_type",
              "type": "string",
              "value": "={{ $json.body.content_type }}"
            },
            {
              "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
              "name": "message_text",
              "type": "string",
              "value": "={{ $json.body.content }}"
            },
            {
              "id": "6e83f9a7-cf75-4182-b2d2-3151e8af76b9",
              "name": "from",
              "type": "string",
              "value": "={{ $json.body.conversation.contact_inbox.source_id }}"
            },
            {
              "id": "da4b602a-28ca-4b0d-a747-c3d3698c3731",
              "name": "message_caption",
              "type": "string",
              "value": "={{ $('Redirect Message Types1').item.json.video && $('Redirect Message Types1').item.json.video.caption || '' }}\n{{ $('Redirect Message Types1').item.json.image && $('Redirect Message Types1').item.json.image.caption || ''}}\n{{ $('Redirect Message Types1').item.json.audio && $('Redirect Message Types1').item.json.audio.caption || ''}}"
            }
          ]
        },
        "options": {}
      },
      "id": "db732aeb-005a-43b7-88cf-ebff4ab66024",
      "name": "Get User's Message3",
      "type": "n8n-nodes-base.set",
      "position": [
        64,
        448
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "text": "Eres un asistente de un doctor, tu trabajo es analizar la imagen a la perfeccion y da especificaciones de lo que hay en la imagen, para que un doctor pueda entender mejor la imagen gracias a tus descripciones.\nNo separes los textos, solo responde corto y ya.\n\nFormato de respuesta:\n\nEl cliente mostro una imagen donde se le ve tal cosa y parece que tiene o se le ve algo\n\nResumido",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -96,
        176
      ],
      "id": "86785bab-5843-4e96-b2dc-13b50f5fb7f6",
      "name": "Analiza Imagenes1"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Entra Nuevo Mensaje').item.json.body.conversation.contact_inbox.source_id }}",
        "messageData": "={{ $json.mensaje_final }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        576,
        176
      ],
      "id": "1343e9fb-dc95-4dc3-b719-97ea9b09b471",
      "name": "Redis3"
    },
    {
      "parameters": {
        "jsCode": "let mensaje_final = \"\";\n\n// Eval√∫a en orden de prioridad cu√°l tiene contenido\nif ($json.text && $json.text.trim() !== \"\") {\n  mensaje_final = $json.text;\n} else if ($json.audio_text && $json.audio_text.trim() !== \"\") {\n  mensaje_final = $json.audio_text;\n} else if ($json.message_text && $json.message_text.trim() !== \"\") {\n  mensaje_final = $json.message_text;\n} else {\n  try {\n    const imagenCaption = $('Numero TEST ACS1').item.json.messages?.[0]?.image?.caption;\n    if (imagenCaption && imagenCaption.trim() !== \"\") {\n      mensaje_final = imagenCaption;\n    }\n  } catch (e) {\n    // No hacer nada si el nodo est√° vac√≠o o falla\n  }\n}\n\n// Retornar siempre con la misma clave\nreturn {\n  json: {\n    mensaje_final\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        176
      ],
      "id": "c547771e-6c4c-43cd-b43f-afb6daf4ef2c",
      "name": "Union de mensajes1"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensajes",
        "key": "={{ $('Entra Nuevo Mensaje').item.json.body.conversation.messages[0].conversation.contact_inbox.source_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        896,
        176
      ],
      "id": "3b8dff89-86bd-4038-9a28-0e6cbcc0ac01",
      "name": "Redis4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1d463773-5493-45a2-987a-2b8a971d73c8",
              "leftValue": "={{ $json.mensajes.last() }}",
              "rightValue": "={{ $('Union de mensajes1').item.json.mensaje_final }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1040,
        176
      ],
      "id": "e3f709ad-019b-4434-8c1f-90a2b87f0822",
      "name": "If1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1200,
        368
      ],
      "id": "516fec5c-f405-40f3-80cf-5dca8a8836ff",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cd304572-0dd7-4b1f-9d85-1d3c5343a6b1",
              "name": "Mensaje",
              "value": "={{ $json.mensajes.join() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        176
      ],
      "id": "2d440123-f8a9-4ca5-bf0c-d49bcad08874",
      "name": "Array de mensajes1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Entra Nuevo Mensaje').item.json.body.conversation.contact_inbox.source_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1344,
        176
      ],
      "id": "23a1d9ca-2ea1-4109-a642-afdc868d8e33",
      "name": "Redis5"
    },
    {
      "parameters": {
        "jsCode": "// Obt√©n el texto original\nlet texto = $input.first().json.text;\n\n// Reemplaza todos los casos de **Texto** por *Texto*\ntexto = texto.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*');\n\n// Elimina todos los s√≠mbolos #\ntexto = texto.replace(/#/g, '');\n\n// Devuelve el resultado\nreturn {\n  json: {\n    output: texto\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        176
      ],
      "id": "1b7770d9-9e63-41e2-badd-4ffbb2963b29",
      "name": "Limpiar Mensaje1"
    },
    {
      "parameters": {
        "amount": 12
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        736,
        176
      ],
      "id": "9348b429-e137-4ab5-b17f-a92118f919f3",
      "name": "Wait1",
      "webhookId": "7863f46f-2299-4c80-9286-e7c275193ff1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "Tu enlace fe flowise",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"question\": \"{{ $json.mensaje.replace(/\\n/g, ' ') }}\",\n  \"overrideConfig\": {\n    \"sessionId\": \"{{ $('Entra Nuevo Mensaje').item.json.body.conversation.contact_inbox.source_id }}\"\n  }\n}\n",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1680,
        176
      ],
      "id": "40bae508-b5ee-48f5-b273-81ede4898872",
      "name": "HTTP Request",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=Tu enlace de chatwoot/api/v1/accounts/{{ $('Entra Nuevo Mensaje').item.json.body.conversation.messages[0].account_id }}/conversations/{{ $('Entra Nuevo Mensaje').item.json.body.conversation.messages[0].conversation_id }}/messages\n\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "Lfas6k8QJrGPHpdD3TQXnYsD"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2064,
        176
      ],
      "id": "3d1e45c2-b74a-48f0-91e9-df6883435241",
      "name": "Enviar Mensaje",
      "retryOnFail": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1056,
        400
      ],
      "id": "cd95fb50-de88-4869-9586-d222b955f310",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "df3cc619-934d-4d62-9bff-db91d69107e5",
              "leftValue": "={{ $json.body.conversation.messages[0].sender.type === 'agent_bot' }}",
              "rightValue": "contact",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1248,
        208
      ],
      "id": "9019fc15-890e-41fc-98af-70a0e4c01758",
      "name": "Agente IA o Humano"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.sender.custom_attributes.bot || \"On\"}}",
                    "rightValue": "On",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "On"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                    "leftValue": "={{ $json.body.sender.custom_attributes.bot || \"On\"}}",
                    "rightValue": "Off",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Off"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -992,
        192
      ],
      "id": "efb5d762-3e9c-4a03-80b0-dc0b664ff78b",
      "name": "Bot On or Off"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "c954c6cb-f6f5-4733-8fbd-9b5dd1e439fa",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1520,
        208
      ],
      "id": "759c3403-64a5-4841-80c7-7542699ef67c",
      "name": "Entra Nuevo Mensaje",
      "webhookId": "c954c6cb-f6f5-4733-8fbd-9b5dd1e439fa"
    },
    {
      "parameters": {
        "jsCode": "// Obtenemos la fecha y hora actual\nconst ahora = new Date();\n\n// Formateamos la hora local (HH:MM:SS)\nconst hora = ahora.toLocaleTimeString('es-NI', {\n  timeZone: 'America/Managua',\n  hour12: false\n});\n\n// Formateamos la fecha local (DD/MM/YYYY)\nconst fecha = ahora.toLocaleDateString('es-NI', {\n  timeZone: 'America/Managua'\n});\n\n// Mensaje base\nconst mensaje = $input.first().json.Mensaje;\n\n// Concatenamos mensaje con fecha y hora\nconst mensajeFinal = `${mensaje} --- No le prestes atenci√≥n a la fecha y a la hora, ya que esa se utilizar√° para nada mas cuando el usuario quiera agendar una cita. Fecha y Hora del mensaje ${fecha} a la ${hora} (hora actual)`;\n\n// Retornamos todo como campos separados\nreturn [{\n  mensaje: mensajeFinal,\n  fecha,\n  hora\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        176
      ],
      "id": "060dc15c-8c5c-4a33-b571-50ef9c629ed8",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "Tu enlace de flowise/api/v1/prediction/23722019-35d2-4f66-be2d-1d77ca9a3202",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"question\": \"{{ $json.mensajeFinal.replace(/\\n/g, ' ') }}\",\n  \"overrideConfig\": {\n    \"sessionId\": \"{{ $('Entra Nuevo Mensaje').item.json.body.conversation.contact_inbox.source_id }}\"\n  }\n}\n",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2128,
        400
      ],
      "id": "be61025a-59b6-459e-a3a4-ae4c6a438d09",
      "name": "Seguimiento de Pacientes - Agente de Flowise"
    },
    {
      "parameters": {
        "jsCode": "const mensajePaciente = $('Entra Nuevo Mensaje').first().json.body.content; \nconst mensajeAgente = $input.first().json.text; \nconst numeroTelefono = $('Entra Nuevo Mensaje').first().json.body.conversation.messages[0].sender.phone_number;\n\n// Crear texto final combinando toda la informaci√≥n\nconst mensajeFinal = `\nEste es el mensaje que envi√≥ el paciente: ${mensajePaciente}.\n\nEste es el mensaje que respondi√≥ la atenci√≥n al cliente: ${mensajeAgente}.\n\nN√∫mero del paciente: ${numeroTelefono}.\n`;\n\n// Retornar como JSON para que lo lean otros nodos (por ejemplo, OpenAI)\nreturn {\n  json: {\n    mensajeFinal\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1936,
        400
      ],
      "id": "f86b0da2-c633-4be5-b46c-74102ed29d23",
      "name": "Unir Informacion del cliente"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el texto del input\nlet texto = $input.first().json.text;\n\n// --- üßπ LIMPIEZA DEL TEXTO ---\n// Quita los posibles bloques markdown (```json, ```), saltos innecesarios y espacios\ntexto = texto\n  .replace(/```json/g, '')\n  .replace(/```/g, '')\n  .replace(/\\n/g, '')\n  .trim();\n\n// --- üîÑ CONVERTIR TEXTO EN JSON ---\nlet datos;\ntry {\n  datos = JSON.parse(texto);\n} catch (error) {\n  // Si no es un JSON v√°lido, devolvemos mensaje de error\n  return {\n    json: {\n      error: \"El texto no es un JSON v√°lido\",\n      texto_original: texto\n    }\n  };\n}\n\nlet todosValidos;\n\n// --- üîç VALIDACIONES CON RETURN DENTRO DEL IF ---\nif (datos.Agendo === true) {\n  const otrasClaves = Object.keys(datos).filter(k => k !== 'Agendo');\n  todosValidos = otrasClaves.every(k => datos[k] !== false && datos[k] !== '');\n}\n\nlet Agendo = false;\n\nif (todosValidos) {\n    // ‚úÖ Si agend√≥ y todo est√° correcto\n    return {\n      json: {\n        ...datos,\n        resultado: \"Agend√≥ la cita correctamente\"\n      }\n    };\n  } if (!todosValidos) {\n    // ‚ö†Ô∏è Si agend√≥ pero faltan datos\n    return {\n      json: {\n        Agendo\n      }\n    };\n  }\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2320,
        400
      ],
      "id": "b154e4e1-61e9-4047-8205-e65a92c6e5d9",
      "name": "Covert To Json"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "62ca1100-339c-462b-87b7-b2b23a2ec53f",
              "leftValue": "={{ $json.Agendo }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2496,
        400
      ],
      "id": "9b5db78e-a51d-4787-a8f6-5605edc1498d",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2704,
        480
      ],
      "id": "399e711e-2851-424c-80c6-67755a82cc19",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "dEH1ICpt9Nn8MTOQ",
          "mode": "list",
          "cachedResultName": "Agenda Calendario Cl√≠nica Oasis",
          "cachedResultUrl": "/projects/LqabXlRaK6LbD2Zq/datatables/dEH1ICpt9Nn8MTOQ"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "Numero",
              "keyValue": "={{ $json['Numero de telefono'] }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Nombre": "={{ $json['Nombre del paciente'] }}",
            "Numero": "={{ $json['Numero de telefono'] }}",
            "Cita": "={{ $json['Tipo de cita m√©dica'] }}",
            "Hora": "={{ $json['Hora de la cita'] }}",
            "Fecha": "={{ $json['Fecha de la cita'] }}",
            "Cede": "={{ $json.Sede }}",
            "Seguimiento": false
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Numero",
              "displayName": "Numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Cita",
              "displayName": "Cita",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Fecha",
              "displayName": "Fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Hora",
              "displayName": "Hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Cede",
              "displayName": "Cede",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "Seguimiento",
              "displayName": "Seguimiento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        2704,
        288
      ],
      "id": "078c734c-dfcf-4671-8a6b-4e00d20581bf",
      "name": "Upsert row(s)"
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "id": "f559a410-a2f2-4123-a176-72e7c64a90d4",
      "name": "WhatsApp Trigger",
      "type": "n8n-nodes-base.whatsAppTrigger",
      "position": [
        -1008,
        1760
      ],
      "webhookId": "0b1b3a9b-2f6a-4f5a-8385-6365d96f4802",
      "typeVersion": 1
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.audio.id }}"
      },
      "id": "09171f50-8804-4c4a-ab5d-2479ad5b2e23",
      "name": "Get Audio URL",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        -208,
        1296
      ],
      "typeVersion": 1,
      "webhookId": "e185ac67-d5c4-4d19-84e3-f2d66d99a17a"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.video.id }}"
      },
      "id": "26eeac65-038f-4c78-a4bd-78c158e97864",
      "name": "Get Video URL",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        -208,
        1648
      ],
      "typeVersion": 1,
      "webhookId": "0bed46d2-8d16-4b14-94fb-bbe246881b84"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.image.id }}"
      },
      "id": "3ae24540-ad26-49a2-9d37-b3339263aa4d",
      "name": "Get Image URL",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        -208,
        2000
      ],
      "typeVersion": 1,
      "webhookId": "48cc5e38-d273-4675-b209-ef1987ce01f5"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "id": "372b3604-1db8-44b5-85a0-ee4ce455487a",
      "name": "Download Video",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -48,
        1648
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "id": "8a03ddd5-735f-445f-ac73-179f4c40e0b3",
      "name": "Download Audio",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -48,
        1296
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "id": "24ad5cf4-b6b5-48f4-9e70-99d02e4ccfff",
      "name": "Download Image",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -48,
        2000
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=whatsapp-tutorial-{{ $json.from }}"
      },
      "id": "3917096c-0d5d-43eb-8495-4a071519705b",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        1152,
        2016
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d990cbd6-a408-4ec4-a889-41be698918d9",
              "name": "message_type",
              "type": "string",
              "value": "={{ $('Split Out Message Parts').item.json.type }}"
            },
            {
              "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
              "name": "message_text",
              "type": "string",
              "value": "={{ $json.text }}"
            },
            {
              "id": "6e83f9a7-cf75-4182-b2d2-3151e8af76b9",
              "name": "from",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}"
            },
            {
              "id": "da4b602a-28ca-4b0d-a747-c3d3698c3731",
              "name": "message_caption",
              "type": "string",
              "value": "={{ $('Redirect Message Types').item.json.video && $('Redirect Message Types').item.json.video.caption || '' }}\n{{ $('Redirect Message Types').item.json.image && $('Redirect Message Types').item.json.image.caption || ''}}\n{{ $('Redirect Message Types').item.json.audio && $('Redirect Message Types').item.json.audio.caption || ''}}"
            }
          ]
        },
        "options": {}
      },
      "id": "1839b6ce-fcb0-485e-8a4c-ea885bc073fa",
      "name": "Get User's Message",
      "type": "n8n-nodes-base.set",
      "position": [
        864,
        1840
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "fieldToSplitOut": "messages",
        "options": {}
      },
      "id": "a752b75f-f9c5-476b-9fe1-69d71c118fb3",
      "name": "Split Out Message Parts",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        -768,
        1760
      ],
      "typeVersion": 1
    },
    {
      "parameters": {},
      "id": "85f600fb-3655-465d-8a5a-32e98186eeef",
      "name": "Wikipedia",
      "type": "@n8n/n8n-nodes-langchain.toolWikipedia",
      "position": [
        1280,
        2016
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.type == 'audio' && Boolean($json.audio) }}",
                    "rightValue": "audio"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Audio Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "82aa5ff4-c9b6-4187-a27e-c7c5d9bfdda0",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.type == 'video' && Boolean($json.video) }}",
                    "rightValue": ""
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Video Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "05b30af4-967b-4824-abdc-84a8292ac0e5",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.type == 'image' && Boolean($json.image) }}",
                    "rightValue": ""
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Image Message"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Text Message"
        }
      },
      "id": "4662d3e6-5f1d-442d-8e06-7e567df5a455",
      "name": "Redirect Message Types",
      "type": "n8n-nodes-base.switch",
      "position": [
        -480,
        1840
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "content": "## 1. WhatsApp Trigger\n[Learn more about the WhatsApp Trigger](https://docs.n8n.io/integrations/builtin/trigger-nodes/n8n-nodes-base.whatsapptrigger)\n\nTo start receiving WhatsApp messages in your workflow, there are quite a few steps involved so be sure to follow the n8n documentation. When we recieve WhatsApp messages, we'll split out the messages part of the payload and handle them depending on the message type using the Switch node.",
        "height": 245.72612197928734,
        "width": 335.8011507479863,
        "color": 7
      },
      "id": "42ac7b99-0921-4148-9a4f-99063e851c89",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1008,
        1472
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### 2. Transcribe Audio Messages üí¨\nFor audio messages or voice notes, we can use GPT4o to transcribe the message for our AI Agent.",
        "height": 97.23360184119679,
        "width": 356.65822784810103,
        "color": 7
      },
      "id": "d1f65685-aabe-4f02-8b0b-9f31806c8293",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -208,
        1168
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### 3. Describe Video Messages üé¨\nFor video messages, one approach is to use a Multimodal Model that supports parsing video. Currently, Google Gemini is a well-tested service for this task. We'll need to use the HTTP request node as currrently n8n's LLM node doesn't currently support video binary types.",
        "height": 127.13555811277331,
        "width": 492.5258918296896,
        "color": 7
      },
      "id": "20d6af63-83e2-4d34-9f4b-c7ab919ef6ec",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -208,
        1488
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### 4. Analyse Image Messages üèûÔ∏è\nFor image messages, we can use GPT4o to explain what is going on in the message for our AI Agent.",
        "height": 97.23360184119679,
        "width": 356.65822784810103,
        "color": 7
      },
      "id": "7fe9ab22-07fa-4ead-bee4-d7f5ba711b4b",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -208,
        1872
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### 5. Text summarizer üìò\nFor text messages, we don't need to do much transformation but it's nice to summarize for easier understanding.",
        "height": 97.23360184119679,
        "width": 428.24395857307246,
        "color": 7
      },
      "id": "2e85b0d7-93c8-4184-b528-f352f969d2a9",
      "name": "Sticky Note4",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -208,
        2176
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "amount": 0
      },
      "id": "dcf7bc73-8b36-4697-8614-1ead774314a5",
      "name": "Get Text",
      "type": "n8n-nodes-base.wait",
      "position": [
        -208,
        2288
      ],
      "webhookId": "99b49c83-d956-46d2-b8d3-d65622121ad9",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "content": "## 6. Generate Response with AI Agent\n[Read more about the AI Agent node](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\n\nNow that we'll able to handle all message types from WhatsApp, we could do pretty much anything we want with it by giving it our AI agent. Examples could include handling customer support, helping to book appointments or verifying documents.\n\nIn this demonstration, we'll just create a simple AI Agent which responds to our WhatsApp user's message and returns a simple response.",
        "height": 273.14522439585744,
        "width": 500.7797468354428,
        "color": 7
      },
      "id": "1f65b95d-fcc7-4edc-973a-85915654874b",
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1056,
        1520
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## 7. Respond to WhatsApp User\n[Read more about the Whatsapp node](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.whatsapp/)\n\nTo close out this demonstration, we'll simple send a simple text message back to the user. Note that this WhatsApp node also allows you to send images, audio, videos, documents as well as location!",
        "height": 211.45776754890682,
        "width": 384.12151898734186,
        "color": 7
      },
      "id": "cf91354d-5588-457f-a334-ab00fbcccd2d",
      "name": "Sticky Note6",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1520,
        2112
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "477115632141067",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "id": "62e0b58b-c2f6-4990-872b-6719e121d399",
      "name": "Respond to User",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        1520,
        1936
      ],
      "typeVersion": 1,
      "webhookId": "f6fb445a-7174-4513-b7bb-7627112b6b81"
    },
    {
      "parameters": {
        "content": "## Try It Out!\n\n### This n8n template demonstrates the beginnings of building your own n8n-powered WhatsApp chatbot! Under the hood, utilise n8n's powerful AI features to handle different message types and use an AI agent to respond to the user. A powerful tool for any use-case!\n\n* Incoming WhatsApp Trigger provides a way to get messages into the workflow.\n* The message received is extracted and sent through 1 of 4 branches for processing.\n* Each processing branch uses AI to analyse, summarize or transcribe the message so that the AI agent can understand it.\n* The AI Agent is used to generate a response generally and uses a wikipedia tool for more complex queries.\n* Finally, the response message is sent back to the WhatsApp user using the WhatsApp node.\n\n### Need Help?\nJoin the [Discord](https://discord.com/invite/XPKeKXeB7d) or ask in the [Forum](https://community.n8n.io/)!",
        "height": 562.8608514850005,
        "width": 470.66513233601853
      },
      "id": "b9934a48-ae5b-41cf-9fb1-bcbe0caf4ca2",
      "name": "Sticky Note7",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1568,
        1312
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### Activate workflow to use!\nYou must activate the workflow to use this WhatsApp Chabot. If you are self-hosting, ensure WhatsApp is able to connect to your server.",
        "height": 96.0144533433243,
        "width": 473.28063885246377,
        "color": 5
      },
      "id": "49f636ac-6245-4f11-88a6-54bc5ac2a216",
      "name": "Sticky Note8",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1568,
        1888
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Here is an image sent by the user. Describe the image and transcribe any text visible in the image.",
        "messages": {
          "messageValues": [
            {
              "type": "HumanMessagePromptTemplate",
              "messageType": "imageBinary"
            }
          ]
        }
      },
      "id": "f79a9c82-5293-4548-976c-a799ced5fdef",
      "name": "Image Explainer",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        480,
        2000
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "content": "\n\n\n\n\n\n\n\n\n\n\n\n\n\n### üö® Google Gemini Required!\nNot using Gemini? Feel free to swap this out for any Multimodal Model that supports Video.",
        "height": 305.35604142692785,
        "width": 260
      },
      "id": "060d537c-4823-4713-80d9-b4f52dea4fee",
      "name": "Sticky Note9",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        320,
        1632
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "modelName": "models/gemini-1.5-pro-002",
        "options": {}
      },
      "id": "84c9a2ad-09b3-4800-8a2c-edf9f7a93b2d",
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        1024,
        2016
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "\n\n\n\n\n\n\n\n\n\n\n\n\n\n### üö® Google Gemini Required!\nNot using Gemini? Feel free to swap this out for any Multimodal Model that supports Audio.",
        "height": 294.22048331415436,
        "width": 260
      },
      "id": "fef5d5ef-b40b-4901-9f32-c6b654d14c49",
      "name": "Sticky Note10",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        320,
        1280
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-002:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n{\n  \"contents\": [{\n    \"parts\":[\n      {\"text\": \"Transcribe this audio\"},\n      {\"inlineData\": {\n        \"mimeType\": `audio/${$binary.data.fileExtension}`,\n        \"data\": $input.item.binary.data.data }\n      }\n    ]\n  }]\n}\n}}",
        "options": {}
      },
      "id": "2acb0598-3431-4ba9-bdc8-c3269bef4dca",
      "name": "Google Gemini Audio",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        400,
        1296
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-002:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n{\n  \"contents\": [{\n    \"parts\":[\n      {\"text\": \"Describe this video\"},\n      {\"inlineData\": {\n        \"mimeType\": `video/${$binary.data.fileExtension}`,\n        \"data\": $input.item.binary.data.data }\n      }\n    ]\n  }]\n}\n}}",
        "options": {}
      },
      "id": "e83d06eb-84f8-41ac-855a-131d9fbcca3b",
      "name": "Google Gemini Video",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        400,
        1648
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "modelName": "models/gemini-1.5-pro-002",
        "options": {}
      },
      "id": "e4b242c8-9b5f-4e3d-bb8d-aed9ae6263a3",
      "name": "Google Gemini Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        464,
        2128
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "modelName": "models/gemini-1.5-pro-002",
        "options": {}
      },
      "id": "ebf4f13b-4b93-422c-9ec6-8378d88a4fb9",
      "name": "Google Gemini Chat Model2",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        464,
        2432
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.candidates[0].content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "aa578275-4b5c-46e5-af2a-3aa15eff32f0",
      "name": "Format Response1",
      "type": "n8n-nodes-base.set",
      "position": [
        640,
        1296
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text.body || $json.text }}",
        "messages": {
          "messageValues": [
            {
              "message": "Summarize the user's message succinctly."
            }
          ]
        }
      },
      "id": "35333eb6-c20d-49aa-97e3-bf158db07e36",
      "name": "Text Summarizer",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        480,
        2288
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=The user sent the following message\nmessage type: {{ $json.message_type }}\nmessage text or description:\n```{{ $json.message_text }}```\n{{ $json.message_caption ? `message caption: ${$json.message_caption.trim()}` : '' }}",
        "options": {
          "systemMessage": "You are a general knowledge assistant made available to the public via whatsapp. Help answer the user's query succiently and factually."
        }
      },
      "id": "cfe1467f-c515-483a-a298-af7f7e3fd56b",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        1056,
        1840
      ],
      "typeVersion": 1.6
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.candidates[0].content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "6dd478c8-0e2d-49ca-9f9d-5ed1c1157df7",
      "name": "Format Response2",
      "type": "n8n-nodes-base.set",
      "position": [
        640,
        1648
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "content": "## Template 2"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1552,
        1056
      ],
      "typeVersion": 1,
      "id": "b041d984-79df-44c2-a127-189599e57cd6",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "## Template 1"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1520,
        -96
      ],
      "typeVersion": 1,
      "id": "882d5f2e-7144-4358-bddc-b3f57cb6820d",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "=You are an advanced image description AI assistant . Your primary function is to provide detailed, accurate descriptions of images submitted through WhatsApp.\n\nCORE FUNCTIONALITY:\n- When presented with an image, you will analyze it thoroughly and provide a comprehensive description in English.\n- Your descriptions should capture both the obvious and subtle elements within the image.\n\nIMAGE DESCRIPTION GUIDELINES:\n- Begin with a broad overview of what the image contains\n- Describe key subjects, people, objects, and their relationships\n- Note significant visual elements such as colors, lighting, composition, and perspective\n- Identify any text visible in the image\n- Describe the setting or environment\n- Mention any notable actions or events taking place\n- Comment on mood, tone, or atmosphere when relevant\n- If applicable, identify landmarks, famous people, or cultural references\n\nRESPONSE FORMAT:\n- Start with \"Image Description:\" followed by your analysis\n- Structure your description in a logical manner (general to specific)\n- Use clear, precise language appropriate for visual description\n- Format longer descriptions with paragraphs to enhance readability\n- End with any notable observations that might require special attention\n\nLIMITATIONS:\n- If the image is blurry, low resolution, or difficult to interpret, acknowledge these limitations\n- If an image contains potentially sensitive content, provide a factual description without judgment\n- Do not make assumptions about elements that cannot be clearly determined\n\nYour descriptions should be informative, objective, and thorough, enabling someone who cannot see the image to form an accurate mental picture of its contents.",
        "inputType": "base64",
        "options": {
          "detail": "auto"
        }
      },
      "id": "a2f9d66a-3fe6-452c-bba2-5e561a6263cc",
      "name": "Analyze Image",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [
        960,
        4752
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "b7597b99-6089-4d71-b361-c0a4ce98f6be",
      "name": "Transcribe Audio",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [
        960,
        4448
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "id": "a9d38cde-0b79-4272-a4af-1bf6b8dfd92b",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        160,
        6080
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text }}",
        "options": {
          "systemMessage": "You are an intelligent assistant. Your purpose is to analyze various types of input and provide helpful, accurate responses.\n\nCAPABILITIES:\n- Process and respond to text messages\n- Analyze uploaded files\n- Interpret and describe images\n- Transcribe and understand voice messages\n\nINPUT HANDLING:\n1. For text messages: Analyze the content, understand the intent, and provide a relevant response.\n2. For file analysis: Examine the file content, extract key information, and summarize important points also based on the questions asked.\n3. For image analysis: Describe what you see in the image, identify key elements, and respond to any questions about the image.\n4. For voice messages: Transcribe the audio, understand the message, and respond appropriately.\n\nRESPONSE GUIDELINES:\n- Be concise but thorough\n- Prioritize accuracy over speculation\n- Maintain a professional and helpful tone\n- When uncertain, acknowledge limitations\n- Format responses for easy reading on mobile devices\n- Include actionable information when appropriate\n\nLIMITATIONS:\n- Mention if you're unable to process certain file formats\n- Indicate if an image is unclear or if details are difficult to discern\n- Note if audio quality impacts transcription accuracy\n\nSECURITY & PRIVACY:\n- Do not store or remember sensitive information shared in files, images, or voice notes\n- Do not share personal information across different user interactions\n- Inform users about data privacy limitations when relevant\n\nAnalyze all inputs carefully before responding. Your goal is to provide value through accurate information and helpful assistance."
        }
      },
      "id": "f0d2ac85-a24a-43c0-91ce-e0de5b869967",
      "name": "AI Agent1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        160,
        5856
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "81949809-6e5f-42b6-bb71-3e40d1d11df1",
      "name": "Download File",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        720,
        5088
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "e2b43d0f-adda-4dc7-87fe-04213ea3e63f",
      "name": "Extract from File",
      "type": "n8n-nodes-base.extractFromFile",
      "position": [
        976,
        5088
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=memory_{{ $('WhatsApp Trigger1').item.json.contacts[0].wa_id }}",
        "contextWindowLength": 10
      },
      "id": "ce694e98-dba1-4ccb-be51-842e07db58f8",
      "name": "Simple Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        304,
        6080
      ],
      "typeVersion": 1.3
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('WhatsApp Trigger1').item.json.messages[0].document.id }}"
      },
      "id": "96957441-cd8a-47fd-b81b-a1ad2e7d6dcf",
      "name": "Get File Url",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        496,
        5088
      ],
      "webhookId": "280bd5de-32d7-4d8f-93d2-e91e3b0bc161",
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "f52d2aaa-e0b2-45e5-8c4b-ceef42182a0d",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.messages[0].document.mime_type }}",
              "rightValue": "application/pdf"
            }
          ]
        },
        "options": {}
      },
      "id": "ac843687-9834-4f2b-a986-63b77f522af5",
      "name": "Only PDF File",
      "type": "n8n-nodes-base.if",
      "position": [
        224,
        5120
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  if (item.binary) {\n    const binaryPropertyNames = Object.keys(item.binary);\n    for (const propName of binaryPropertyNames) {\n      if (item.binary[propName].mimeType === 'audio/mp3') {\n        item.binary[propName].mimeType = 'audio/mpeg';\n      }\n    }\n  }\n}\n\nreturn $input.all();"
      },
      "id": "d5ec2da9-022e-4007-b47d-e7ae50e601d5",
      "name": "Fix mimeType for Audio",
      "type": "n8n-nodes-base.code",
      "position": [
        1040,
        5712
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "470271332838881",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger1').item.json.messages[0].from }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "id": "29f65f30-05ef-4a40-9c48-84a3057422bb",
      "name": "Send message",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        848,
        6000
      ],
      "webhookId": "23834751-5066-48ba-8e19-549680df2b27",
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "470271332838881",
        "recipientPhoneNumber": "={{ $('Input type').item.json.contacts[0].wa_id }}",
        "messageType": "audio",
        "mediaPath": "useMedian8n",
        "additionalFields": {}
      },
      "id": "fd4d6778-74bb-4303-8def-537041d9ffe7",
      "name": "Send audio",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        1264,
        5712
      ],
      "webhookId": "d18b2c98-84e4-43cf-a532-0c47d5161684",
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "470271332838881",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger1').item.json.messages[0].from }}",
        "textBody": "=Sorry but you can only send PDF files",
        "additionalFields": {}
      },
      "id": "64a2cab0-40d4-47e4-9d3b-22819f1ee471",
      "name": "Incorrect format",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        496,
        5328
      ],
      "webhookId": "23834751-5066-48ba-8e19-549680df2b27",
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c53cd9f9-77c1-4331-98ff-bfc9bdf95a3c",
              "name": "text",
              "type": "string",
              "value": "={{ $('WhatsApp Trigger1').item.json.messages[0].text.body }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4bbb471e-853e-4d51-8d7c-ff15d31ed49f",
      "name": "Text",
      "type": "n8n-nodes-base.set",
      "position": [
        1248,
        4112
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "219577d5-b028-48fc-90be-980f4171ab68",
              "name": "text",
              "type": "string",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4a7b8479-48ea-402b-9ae3-43d5a9d56aca",
      "name": "Audio",
      "type": "n8n-nodes-base.set",
      "position": [
        1248,
        4448
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "67552183-de2e-494a-878e-c2948e8cb6bb",
              "name": "text",
              "type": "string",
              "value": "=User request on the image:\n{{ \"Describe the following image\" || $('WhatsApp Trigger1').item.json.messages[0].image.caption }}\n\nImage description:\n{{ $json.content }}"
            }
          ]
        },
        "options": {}
      },
      "id": "0ca43848-5163-4eed-9966-6ff33f0b2ebf",
      "name": "Image",
      "type": "n8n-nodes-base.set",
      "position": [
        1216,
        4752
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "67552183-de2e-494a-878e-c2948e8cb6bb",
              "name": "text",
              "type": "string",
              "value": "=User request on the file:\n{{ \"Describe this file\" || $('Only PDF File').item.json.messages[0].document.caption }}\n\nFile content:\n{{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d6230b7a-88c4-4c5e-88b6-518373972655",
      "name": "File",
      "type": "n8n-nodes-base.set",
      "position": [
        1248,
        5088
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "470271332838881",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger1').item.json.messages[0].from }}",
        "textBody": "=You can only send text messages, images, audio files and PDF documents.",
        "additionalFields": {}
      },
      "id": "9109d150-35d0-467f-ad4d-079041bc014e",
      "name": "Not supported",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        -256,
        4992
      ],
      "webhookId": "23834751-5066-48ba-8e19-549680df2b27",
      "typeVersion": 1
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('WhatsApp Trigger1').item.json.messages[0].image.id }}"
      },
      "id": "989a9cfc-41e5-434f-af5b-3d34a850a6f0",
      "name": "Get Image Url",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        480,
        4752
      ],
      "webhookId": "280bd5de-32d7-4d8f-93d2-e91e3b0bc161",
      "typeVersion": 1
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('WhatsApp Trigger1').item.json.messages[0].audio.id }}"
      },
      "id": "6f7e336b-8fc5-495e-9d8e-4396d7cb7d71",
      "name": "Get Audio Url",
      "type": "n8n-nodes-base.whatsApp",
      "position": [
        464,
        4448
      ],
      "webhookId": "87caa300-7204-47b5-959a-94f4a8fbf8cf",
      "typeVersion": 1
    },
    {
      "parameters": {
        "resource": "audio",
        "input": "={{ $('AI Agent1').item.json.output }}",
        "voice": "onyx",
        "options": {}
      },
      "id": "20566420-0fc6-49d4-9c52-14d7cc486fec",
      "name": "Generate Audio Response",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [
        848,
        5712
      ],
      "typeVersion": 1.8
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "b9d1d759-f585-4791-a743-b9d72951e77c",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              },
              "leftValue": "={{ $('WhatsApp Trigger1').item.json.messages[0].audio }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "a7f4c3d1-90bd-45a2-8cff-dfc9cbacc722",
      "name": "From audio to audio?",
      "type": "n8n-nodes-base.if",
      "position": [
        576,
        5856
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "08fd0c80-307e-4f45-b1de-35192ee4ec5e",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.messages[0].text.body }}",
                    "rightValue": ""
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "b7b64446-f1ea-4622-990c-22f3999a8269",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.messages[0].audio }}",
                    "rightValue": ""
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "202af928-a324-411a-bf15-68a349e7bf9e",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.messages[0].image }}",
                    "rightValue": ""
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Image"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "c63299e9-6069-4bc6-afb9-7beebf6e3d69",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "leftValue": "={{ $json.messages[0].document }}",
                    "rightValue": ""
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "Document"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "6617ffea-13a5-4479-90a5-2f558238750e",
      "name": "Input type",
      "type": "n8n-nodes-base.switch",
      "position": [
        -416,
        4672
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "id": "635ae4eb-77cc-42e4-bf81-a9573021d4a4",
      "name": "WhatsApp Trigger1",
      "type": "n8n-nodes-base.whatsAppTrigger",
      "position": [
        -704,
        4720
      ],
      "webhookId": "d3978cae-2aca-4553-8ac7-ab89068deabc",
      "typeVersion": 1
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "dd2f0602-c94a-4dbe-a625-884b0eb1738c",
      "name": "Download Image2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        720,
        4752
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "97a61899-3330-456a-9773-17511460b3f8",
      "name": "Download Audio2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        720,
        4448
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "content": "## Text",
        "height": 240,
        "width": 1340
      },
      "id": "d5c05935-4d17-4e7f-9ca4-cfe5955df11b",
      "name": "Sticky Note13",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        128,
        4080
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Voice",
        "height": 240,
        "width": 1340
      },
      "id": "6dd50307-0c82-4701-b4f0-5f57504cc863",
      "name": "Sticky Note14",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        128,
        4400
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Image",
        "height": 240,
        "width": 1340
      },
      "id": "40848caa-0f69-4da2-acf9-d491eb1831f5",
      "name": "Sticky Note15",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        128,
        4720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Document",
        "height": 240,
        "width": 1340
      },
      "id": "cb54b7c9-9b95-4ae0-85b8-159a49e1fd6e",
      "name": "Sticky Note16",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        128,
        5056
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Response",
        "height": 600,
        "width": 1340,
        "color": 5
      },
      "id": "82d3138d-5257-46e1-98a4-70e126458baa",
      "name": "Sticky Note17",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        128,
        5600
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "How to obtain Whatsapp API?\n\n\n### ‚úÖ Prerequisites\nBefore you begin, make sure you have:\n- A **Meta Business Account**\n- A **Facebook Developer Account**\n- A **Verified Business**\n- A **Phone Number** to link to WhatsApp\n- Access to **Meta's Graph API Explorer** or **Meta for Developers portal**\n\n---\n\n### ü™ú STEP 1: Create a Meta App\n\n1. Go to [https://developers.facebook.com/apps](https://developers.facebook.com/apps)\n2. Click **‚ÄúCreate App‚Äù**\n3. Choose **\"Business\"** as the app type, then click **Next**\n4. Give your app a name and enter a contact email\n5. Choose your Business Account (or create one)\n6. Click **Create App**\n\n---\n\n### ü™ú STEP 2: Add WhatsApp Product\n\n1. In your app dashboard, scroll down to **\"Add a Product\"**\n2. Find **\"WhatsApp\"** and click **‚ÄúSet Up‚Äù**\n3. Link your **Business Manager Account**\n\n---\n\n### ü™ú STEP 3: Create a WhatsApp Business Account (if needed)\n\n1. If you haven‚Äôt already, go to [https://business.facebook.com/](https://business.facebook.com/)\n2. Click **‚ÄúCreate Account‚Äù**, and complete your business information\n3. Go to **Business Settings > Accounts > WhatsApp Accounts**\n4. Add a **Phone Number** (you'll receive a verification code)\n\n---\n\n### ü™ú STEP 4: Generate a Temporary Access Token (for development)\n\n1. In the **App Dashboard**, go to **WhatsApp > Getting Started**\n2. Choose your test phone number\n3. Copy the **temporary access token** (valid for 24 hours)\n4. Copy the **Phone Number ID** and **WhatsApp Business Account ID**\n\n‚úÖ Save these 3 values:\n- **Access Token**\n- **Phone Number ID**\n- **WABA ID**\n\nüìù Tip: For production, you will later need to create a **permanent token** (see step 7).\n\n---\n\n### ü™ú STEP 5: Set Up a Webhook URL (n8n)\n\n1. In n8n, set up a **Webhook node** (or use the `WhatsApp Trigger` node)\n2. Copy the webhook URL\n3. In the Meta Developer Dashboard:\n   - Go to **WhatsApp > Configuration**\n   - Click **‚ÄúEdit Callback URL‚Äù**\n   - Paste your n8n webhook URL and add a random **verify token**\n4. In n8n, configure your webhook to respond to the verification request\n\n---\n\n### ü™ú STEP 6: Subscribe to Webhook Fields\n\n1. Still under **WhatsApp > Configuration**, click **\"Manage Subscriptions\"**\n2. Enable:\n   - `messages`\n   - `message_status`\n   - (Optionally `message_template_status_update`)\n\n---\n\n### ü™ú STEP 7: (Optional but recommended) Generate a Permanent Token\n\n1. Go to [https://developers.facebook.com/tools/access_token/](https://developers.facebook.com/tools/access_token/)\n2. Select your app\n3. Click **Get Token > System User Token**\n4. Select the permissions:\n   - `whatsapp_business_management`\n   - `whatsapp_business_messaging`\n   - `business_management`\n5. Click **Generate Token**\n6. Copy and securely store this token\n\n---\n\n### ü™ú STEP 8: Configure Credentials in n8n\n\n1. Go to **n8n > Settings > Credentials**\n2. Create new credentials of type **HTTP Header Auth**\n   - **Name:** WhatsApp\n   - **Header Name:** `Authorization`\n   - **Value:** `Bearer <your_access_token>`\n3. Save\n\nThen, in your workflows:\n- Use the HTTP Request node or WhatsApp node\n- Set the `phone_number_id` in the node parameters\n- Connect it to your WhatsApp credential\n\n---\n\n### üß™ STEP 9: Test the Connection\n\n1. Use a WhatsApp number to send a message to your business phone\n2. Your n8n workflow should be triggered\n3. You can now send and receive messages programmatically üéâ\n",
        "height": 2680,
        "width": 780,
        "color": 3
      },
      "id": "a35f9244-3050-4040-a57d-452320191dbe",
      "name": "Sticky Note18",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1584,
        3488
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Template 3"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1568,
        3200
      ],
      "typeVersion": 1,
      "id": "b65db620-40e0-4b8f-a277-7dec33b5f795",
      "name": "Sticky Note19"
    }
  ],
  "connections": {
    "Get Audio URL1": {
      "main": [
        [
          {
            "node": "Download Audio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Image URL1": {
      "main": [
        [
          {
            "node": "Download Image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio1": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image1": {
      "main": [
        [
          {
            "node": "Analiza Imagenes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User's Message2": {
      "main": [
        [
          {
            "node": "Union de mensajes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redirect Message Types1": {
      "main": [
        [
          {
            "node": "Get Audio URL1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Image URL1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Text1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Text1": {
      "main": [
        [
          {
            "node": "Get User's Message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Union de mensajes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User's Message3": {
      "main": [
        [
          {
            "node": "Union de mensajes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analiza Imagenes1": {
      "main": [
        [
          {
            "node": "Get User's Message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis3": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Union de mensajes1": {
      "main": [
        [
          {
            "node": "Redis3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis4": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Array de mensajes1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Array de mensajes1": {
      "main": [
        [
          {
            "node": "Redis5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis5": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Mensaje1": {
      "main": [
        [
          {
            "node": "Enviar Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Redis4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Limpiar Mensaje1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Unir Informacion del cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agente IA o Humano": {
      "main": [
        [
          {
            "node": "Bot On or Off",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bot On or Off": {
      "main": [
        [
          {
            "node": "Redirect Message Types1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Entra Nuevo Mensaje": {
      "main": [
        [
          {
            "node": "Agente IA o Humano",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Informacion del cliente": {
      "main": [
        [
          {
            "node": "Seguimiento de Pacientes - Agente de Flowise",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seguimiento de Pacientes - Agente de Flowise": {
      "main": [
        [
          {
            "node": "Covert To Json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Covert To Json": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Upsert row(s)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Respond to User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Text": {
      "main": [
        [
          {
            "node": "Text Summarizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wikipedia": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get Audio URL": {
      "main": [
        [
          {
            "node": "Download Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Image URL": {
      "main": [
        [
          {
            "node": "Download Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Video URL": {
      "main": [
        [
          {
            "node": "Download Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio": {
      "main": [
        [
          {
            "node": "Google Gemini Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image": {
      "main": [
        [
          {
            "node": "Image Explainer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Video": {
      "main": [
        [
          {
            "node": "Google Gemini Video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Image Explainer": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text Summarizer": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response1": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Split Out Message Parts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User's Message": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Audio": {
      "main": [
        [
          {
            "node": "Format Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Video": {
      "main": [
        [
          {
            "node": "Format Response2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Redirect Message Types": {
      "main": [
        [
          {
            "node": "Get Audio URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Video URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Image URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out Message Parts": {
      "main": [
        [
          {
            "node": "Redirect Message Types",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Image Explainer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Text Summarizer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Format Response2": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Image": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "From audio to audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input type": {
      "main": [
        [
          {
            "node": "Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Audio Url",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Image Url",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Only PDF File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Not supported",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get File Url": {
      "main": [
        [
          {
            "node": "Download File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Image": {
      "main": [
        [
          {
            "node": "Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Audio Url": {
      "main": [
        [
          {
            "node": "Download Audio2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Image Url": {
      "main": [
        [
          {
            "node": "Download Image2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Only PDF File": {
      "main": [
        [
          {
            "node": "Get File Url",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Incorrect format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio": {
      "main": [
        [
          {
            "node": "Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "From audio to audio?": {
      "main": [
        [
          {
            "node": "Generate Audio Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix mimeType for Audio": {
      "main": [
        [
          {
            "node": "Send audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Audio Response": {
      "main": [
        [
          {
            "node": "Fix mimeType for Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger1": {
      "main": [
        [
          {
            "node": "Input type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image2": {
      "main": [
        [
          {
            "node": "Analyze Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio2": {
      "main": [
        [
          {
            "node": "Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "b82d4a41-cfaf-40ce-8ae6-d3745614bcb4",
  "activeVersionId": null,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2026-01-15T03:16:53.546Z",
      "createdAt": "2026-01-15T03:16:53.546Z",
      "role": "workflow:owner",
      "workflowId": "A5PDymR3ncd1dzpi",
      "projectId": "tAHBdayTR1Nb6OKK"
    }
  ],
  "activeVersion": null,
  "tags": []
}