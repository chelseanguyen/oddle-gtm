{
  "updatedAt": "2026-01-16T07:46:28.980Z",
  "createdAt": "2026-01-15T03:39:59.529Z",
  "id": "dgCCa2SjvGETsfVC",
  "name": "[Whapi] Trap Agent - Veronica",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -384,
        480
      ],
      "id": "53709328-0ac8-40ae-93b8-63fc3c1bb259",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d990cbd6-a408-4ec4-a889-41be698918d9",
              "name": "message_type",
              "type": "string",
              "value": "={{ $('Receive Reply').item.json.body.messages[0].type }}"
            },
            {
              "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
              "name": "message_text",
              "type": "string",
              "value": "={{ $json.text }}"
            },
            {
              "id": "da4b602a-28ca-4b0d-a747-c3d3698c3731",
              "name": "message_caption",
              "type": "string",
              "value": "={{ $('Redirect Message Types').item.json.body.messages[0].video?.caption || $('Redirect Message Types').item.json.body.messages[0].image?.caption || $('Redirect Message Types').item.json.body.messages[0].audio?.caption || \"\" }}"
            },
            {
              "id": "9612af65-3421-4b94-b3c3-4231c762b351",
              "name": "chat_id",
              "value": "={{ $('Receive Reply').item.json.body.messages[0].chat_id }}",
              "type": "string"
            },
            {
              "id": "5a8f313b-0472-44a5-ba73-0907a983f351",
              "name": "channel_id",
              "value": "={{ $('Receive Reply').item.json.body.channel_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "f7aa5d03-d1c8-4106-934e-4aca86b067c8",
      "name": "Get User's Message",
      "type": "n8n-nodes-base.set",
      "position": [
        1728,
        -96
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ec5e944c-7656-4860-adb7-edcfa8b95ed0",
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "05b30af4-967b-4824-abdc-84a8292ac0e5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "image"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "75e367cd-3913-4ea4-a2ea-b0442b3325fb",
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "voice",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "audio",
                    "id": "1113da73-5d4e-450e-90b3-960e6bec2e3c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "82aa5ff4-c9b6-4187-a27e-c7c5d9bfdda0",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "video"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Video Message"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Other Message Type"
        }
      },
      "id": "a2447531-cbf9-4836-b1f3-8e3d5f431276",
      "name": "Redirect Message Types",
      "type": "n8n-nodes-base.switch",
      "position": [
        144,
        -96
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "id": "76507da5-802c-428b-a176-1f93a9ebae58",
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        2416,
        96
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "a590dac3-2647-4ca9-87d6-444c5422a4e5",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -640,
        0
      ],
      "id": "162614d4-536a-489e-befd-8ff06d06b0b3",
      "name": "Receive Reply",
      "webhookId": "a590dac3-2647-4ca9-87d6-444c5422a4e5"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.messages[0].from_me }}",
                    "rightValue": "On",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    },
                    "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "On"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                    "leftValue": "={{ $json.body.messages[0].from_me }}",
                    "rightValue": "Off",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Off"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -128,
        -16
      ],
      "id": "ec7b28a1-a84e-4069-b6da-b5cd0ecc73a5",
      "name": "Check if Prospect's Message"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"classification\": \"human\",\n  \"reason\": \"The user is asking about pricing and used informal language.\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        848,
        -400
      ],
      "name": "Topic Output Parser",
      "id": "62bdc315-f3ff-40fe-a223-e3a5c1ff6c3c"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Receive Reply').item.json.body.messages[0].text.body }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a message classifier for a WhatsApp message.\n\nTask: Analyze the incoming message and determine if it was sent by a human or an automated bot/system.\n\nClassification Criteria:\n- auto_bot: Identify as this if the message contains standard automated patterns such as \"Thank you for contacting us,\" \"An agent will be with you shortly,\" \"Select an option from the menu,\" or if it is a rigid, repetitive system notification.\n\n- human: Identify as this if the message contains natural language, slang, typos, specific questions, or conversational intent that varies from a script.\n\nConstraint: Your output must ONLY be a valid JSON object. Do not include any other text, greetings, or explanations.\n\nOutput Format: { \"classification\": \"human\" | \"auto_bot\", \"reason\": \"Brief explanation of why within 100 characters limit\" }"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        672,
        -592
      ],
      "name": "Check if Bot Message",
      "id": "5deaf20d-ae9e-4fef-8f71-5245e1f2d28d"
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        624,
        -400
      ],
      "name": "Google Gemini LLM",
      "id": "a32abe91-4a04-4c46-a318-e96b5f004a61",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://gate.whapi.cloud/messages/list/{{ $json.chat_id }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "count",
              "value": "20"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer XRrTS2TMfTogsCgLuVQ2xrZLkBIw8OIR"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1968,
        -96
      ],
      "id": "e02f4a2d-5811-4da1-943a-78e1a2516cd3",
      "name": "Get Chat History"
    },
    {
      "parameters": {
        "jsCode": "// Helper function to format timestamp\nfunction formatTimestamp(timestamp) {\n  const date = new Date(timestamp * 1000);\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const hours = String(date.getHours()).padStart(2, '0');\n  const minutes = String(date.getMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hours}:${minutes}`;\n}\n\n// 1. GET DATA FROM PREVIOUS NODES\nconst inputData = $input.all();\nconst latestInput = $(\"Get User's Message\").first().json; \nlet rawMessages = [];\n\nif (Array.isArray(inputData) && inputData.length > 0) {\n  const firstItem = inputData[0].json;\n  if (firstItem?.messages) {\n    rawMessages = firstItem.messages.filter(msg => msg.type !== 'action' && msg.type !== 'reaction');\n  }\n}\n\n// 2. DEFINE THE LEAD MESSAGE (Caption first, then Media Description)\nlet leadMessage = \"\";\n\nif (latestInput.message_type === 'text') {\n    leadMessage = latestInput.message_text;\n} else {\n    // Media Message Logic\n    const caption = latestInput.message_caption ? `Prospect's Caption: \"${latestInput.message_caption}\"` : \"User sent a media file with no caption.\";\n    const description = latestInput.message_text ? `\\n\\n[Explanation of the ${latestInput.message_type}]:\\n${latestInput.message_text}` : \"\";\n    \n    leadMessage = `${caption}${description}`;\n}\n\n// 3. PROCESS THE CHAT HISTORY THREAD\nconst processedMessages = rawMessages.map(item => {\n  const isFromMe = item.from_me === true;\n  const role = isFromMe ? 'SDR' : 'Prospect';\n  let text = item.text?.body || (item.caption ? item.caption : `[${item.type} file]`);\n  \n  return {\n    timestamp: item.timestamp,\n    formattedTime: formatTimestamp(item.timestamp),\n    role: role,\n    message: text.substring(0, 1000)\n  };\n});\n\n// Sort chronological\nconst chronologicalMessages = [...processedMessages].sort((a, b) => a.timestamp - b.timestamp);\n\n// Format as a string\nconst conversationThread = chronologicalMessages.map(msg => {\n  return `[${msg.formattedTime}] ${msg.role}: ${msg.message}`;\n}).join('\\n\\n');\n\nreturn {\n  json: {\n    leadMessage: leadMessage, \n    chatId: latestInput.chat_id,\n    conversationThreadFormatted: conversationThread,\n    summary: {\n      totalMessages: chronologicalMessages.length,\n      latestRole: latestInput.message_type === 'text' ? 'Prospect' : `Prospect (${latestInput.message_type})`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2176,
        -96
      ],
      "name": "Parse Chat History",
      "id": "ba1d60e5-0e01-4ac0-a782-0d21ec1efc1b"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\t\"text\": \"Hi, do you take reservation for 10-12 pax?\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2672,
        96
      ],
      "id": "5b3ea7d8-1dcb-44a9-bdd6-abbd5840fb6d",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.event.type }}",
                    "rightValue": "messages",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                    "leftValue": "={{ $json.body.event.type }}",
                    "rightValue": "statuses",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Status"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -416,
        0
      ],
      "id": "7495747d-c0b1-40fb-b346-6a56c74358b9",
      "name": "Check event type"
    },
    {
      "parameters": {
        "jsCode": "// This node extracts image URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst imagesFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is image and has a link\n    if (msg.type === 'image' && msg.image && msg.image.link) {\n      imagesFound.push({\n        imageUrl: msg.image.link,\n        caption: msg.image.caption || \"\",\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// If no images were found, you might want to return an empty item \n// or a specific message to avoid errors in later nodes\nreturn imagesFound.length > 0 ? imagesFound : [{ imageUrl: null, status: \"no image found\" }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        -176
      ],
      "id": "4f5056e1-ef1a-4397-930c-437bb5fdbbd9",
      "name": "Get image URL"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "df3cc619-934d-4d62-9bff-db91d69107e5",
              "leftValue": "={{ $json.body.conversation.messages[0].sender.type === 'agent_bot' }}",
              "rightValue": "contact",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -656,
        464
      ],
      "id": "3bd44f31-147a-4dc8-9234-fd1ad64fc4e7",
      "name": "Check if human or bot"
    },
    {
      "parameters": {
        "jsCode": "// This node extracts voice/audio URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst audioFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Whapi uses 'voice' for voice notes and 'audio' for uploaded files\n    const audioData = msg.voice || msg.audio;\n    \n    if ((msg.type === 'voice' || msg.type === 'audio') && audioData && audioData.link) {\n      audioFound.push({\n        audioUrl: audioData.link,\n        chatId: msg.chat_id,\n        sender: msg.from_name,\n        seconds: audioData.seconds || 0,\n        mime_type: audioData.mime_type\n      });\n    }\n  }\n}\n\n// If no audio was found, return a null object to prevent workflow crashes\nreturn audioFound.length > 0 ? audioFound : [{ audioUrl: null, status: \"no audio found\" }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        32
      ],
      "id": "62328a45-e5a9-422d-9442-f2a0d7f55d54",
      "name": "Get Voice URL"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-3-flash-preview",
          "mode": "list",
          "cachedResultName": "models/gemini-3-flash-preview"
        },
        "audioUrls": "={{ $json.audioUrl }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        848,
        32
      ],
      "id": "20717694-7e4f-417b-ab47-64c29425f2b7",
      "name": "Transcribe voice message",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.0-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.0-flash"
        },
        "text": "Here is an image sent by the user. Describe the image and transcribe any text visible in the image.",
        "imageUrls": "={{ $json.imageUrl }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        848,
        -176
      ],
      "id": "3158ca77-0569-4a28-92c1-bae7aae909fa",
      "name": "Analyze image",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// This node extracts video URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst videosFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is video and has a link\n    if (msg.type === 'video' && msg.video && msg.video.link) {\n      videosFound.push({\n        videoUrl: msg.video.link,\n        caption: msg.video.caption || \"\",\n        seconds: msg.video.seconds || 0,\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// Return video data or a null object to keep the workflow from breaking\nreturn videosFound.length > 0 ? videosFound : [{ videoUrl: null, status: \"no video found\" }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        240
      ],
      "id": "e4515859-021c-4cb8-a048-c6bfd47d8583",
      "name": "Get video URL"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f812a969-c037-4744-bb67-c02217381623",
      "name": "Format image description",
      "type": "n8n-nodes-base.set",
      "position": [
        1104,
        -176
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-3-flash-preview",
          "mode": "list",
          "cachedResultName": "models/gemini-3-flash-preview"
        },
        "text": "Here is an video sent by the user. Describe the video briefly and transcribe any voice/audio message in the video.",
        "videoUrls": "={{ $json.videoUrl }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        848,
        240
      ],
      "id": "5d862cad-1054-47dd-87bc-0cbbc776ede2",
      "name": "Analyze video",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e23d094f-916b-4a62-b3aa-f106e9a245b6",
      "name": "Format video description",
      "type": "n8n-nodes-base.set",
      "position": [
        1104,
        240
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "504f3642-18fe-4786-a761-17b2b20c548a",
      "name": "Format voice transcription",
      "type": "n8n-nodes-base.set",
      "position": [
        1104,
        32
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $('Redirect Message Types').item.json.body.messages[0].text.body }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5c87fdcd-ba87-4874-9ac9-ccba7d6ababe",
      "name": "Format response",
      "type": "n8n-nodes-base.set",
      "position": [
        1104,
        -592
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"New prospect reply needs approval\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Name:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].type }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ JSON.stringify(($('Get User\\'s Message').item.json.message_text || '').length > 300 ? $('Get User\\'s Message').item.json.message_text.substring(0, 300) + '...' : ($('Get User\\'s Message').item.json.message_text || '')).slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Media caption:*\\n```{{ $('Get User\\'s Message').item.json.message_caption ? JSON.stringify($('Get User\\'s Message').item.json.message_caption).slice(1, -1) : 'NA' }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ JSON.stringify($json.output.text || '').slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"actions\",\n      \"block_id\": \"approval_actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \":white_check_mark: Approve & Send\",\n            \"emoji\": true\n          },\n          \"style\": \"primary\",\n          \"action_id\": \"approve\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \"✏ Reject & Send manually\",\n            \"emoji\": true\n          },\n          \"style\": \"danger\",\n          \"action_id\": \"reject\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2912,
        -96
      ],
      "id": "c34e3519-3ef4-4b34-9951-0abddc0f5690",
      "name": "Send to Slack for Approval",
      "credentials": {
        "httpBearerAuth": {
          "id": "jByqEazESu9xXEeO",
          "name": "Slack's WhatsApp Agent"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"Unrecognized message type received\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":warning: Unrecognized Message Type\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Name:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n`{{ $('Redirect Message Types').item.json.body.messages[0].type }}`\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Status:* The AI Agent cannot process this file or message type automatically.\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Action Required:* Please check this conversation directly on WhatsApp to reply to the prospect.\"\n      }\n    },\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        352,
        304
      ],
      "id": "4a31ad8d-d319-4a88-863a-0c126b88dcbe",
      "name": "Notify in Slack",
      "credentials": {
        "httpBearerAuth": {
          "id": "jByqEazESu9xXEeO",
          "name": "Slack's WhatsApp Agent"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=- Prospect's latest message: {{ $json.leadMessage }}\n- Message type: {{ $('Receive Reply').item.json.body.messages[0].type }}\n- Chat history: {{ $json.conversationThreadFormatted }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a Singaporean tourist who is visiting Australia with your family and looking for a restaurant to make a reservation for 10-12 pax. You've already asked the restaurant whether they're taking reservation and now they are responding to you. \n\nYour job is to follow up, answer their questions about your booking, ask if they have a reservation website for you to book by yourself, and if they don't, suggest them to use a reservation system to make it convenient for consumers like you.\n\nGuidelines:\n- Keep your response natural, casual, conversational, short and concise.\n- You don't need to tell the restaurant all details about your reservation all at once, provide the information when asked.\n- This is a conversation via WhatsApp text messages, so make it natural for text messages context.\n- Refer to the chat history to generate an appropriate response.\n\nDetails about your reservation:\n- You're with a family of 10, 8 adults and 2 kids (5 and 7 years old)\n- You're looking to make a reservation some time this week for next week, either lunch or dinner, you're unsure about the exact date and are flexible depending on the restaurant's availability\n- You & your family have no diet restriction & no allergy"
        }
      },
      "id": "eb062c5d-4a08-4647-9e3e-17e2f93d0217",
      "name": "Response Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        2480,
        -96
      ],
      "typeVersion": 1.6
    }
  ],
  "connections": {
    "Get User's Message": {
      "main": [
        [
          {
            "node": "Get Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redirect Message Types": {
      "main": [
        [
          {
            "node": "Check if Bot Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get image URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Voice URL",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Get video URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify in Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Response Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Receive Reply": {
      "main": [
        [
          {
            "node": "Check event type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Topic Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Check if Bot Message",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Check if Prospect's Message": {
      "main": [
        [
          {
            "node": "Redirect Message Types",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini LLM": {
      "ai_languageModel": [
        [
          {
            "node": "Check if Bot Message",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Check if Bot Message": {
      "main": [
        [
          {
            "node": "Format response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Chat History": {
      "main": [
        [
          {
            "node": "Parse Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Chat History": {
      "main": [
        [
          {
            "node": "Response Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Response Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Check event type": {
      "main": [
        [
          {
            "node": "Check if Prospect's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get image URL": {
      "main": [
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if human or bot": {
      "main": [
        [],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Voice URL": {
      "main": [
        [
          {
            "node": "Transcribe voice message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Format image description",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe voice message": {
      "main": [
        [
          {
            "node": "Format voice transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format image description": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get video URL": {
      "main": [
        [
          {
            "node": "Analyze video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze video": {
      "main": [
        [
          {
            "node": "Format video description",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format video description": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format voice transcription": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format response": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response Agent": {
      "main": [
        [
          {
            "node": "Send to Slack for Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "timeSavedPerExecution": 60
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Receive Reply": [
      {
        "json": {
          "headers": {
            "host": "workflow.oddle.center",
            "accept": "application/json",
            "content-type": "application/json",
            "content-length": "321",
            "sentry-trace": "d13f690a64c06f61208c952a25fb58c3-e1b22b0d4b53667f",
            "baggage": "sentry-environment=prod,sentry-public_key=22217dc31eef5d21afad60404664acb9,sentry-trace_id=d13f690a64c06f61208c952a25fb58c3",
            "x-cloud-trace-context": "38d5b67378a4ce60c575abc1bca1180f/3867005645660084958",
            "x-forwarded-proto": "https",
            "traceparent": "00-38d5b67378a4ce60c575abc1bca1180f-35aa5d257dffdade-00",
            "x-forwarded-for": "65.108.194.158",
            "forwarded": "for=\"65.108.194.158\";proto=https"
          },
          "params": {},
          "query": {},
          "body": {
            "messages": [
              {
                "id": "Os6ArS2po.JU1A-gEgBiNQgng",
                "from_me": false,
                "type": "text",
                "chat_id": "6590570654@s.whatsapp.net",
                "timestamp": 1768465746,
                "source": "mobile",
                "text": {
                  "body": "Thank you! That’s all for now"
                },
                "from": "6590570654",
                "from_name": "Chelsea"
              }
            ],
            "event": {
              "type": "messages",
              "event": "post"
            },
            "channel_id": "DEADPL-MVUH7"
          },
          "webhookUrl": "https://workflow.oddle.center/webhook-test/a590dac3-2647-4ca9-87d6-444c5422a4e5",
          "executionMode": "test"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "218c6105-d83e-499e-9ec1-c7f2d2ab8829",
  "activeVersionId": "218c6105-d83e-499e-9ec1-c7f2d2ab8829",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-01-15T03:39:59.529Z",
      "createdAt": "2026-01-15T03:39:59.529Z",
      "role": "workflow:owner",
      "workflowId": "dgCCa2SjvGETsfVC",
      "projectId": "tAHBdayTR1Nb6OKK"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-16T06:11:55.450Z",
    "createdAt": "2026-01-16T03:30:58.197Z",
    "versionId": "218c6105-d83e-499e-9ec1-c7f2d2ab8829",
    "workflowId": "dgCCa2SjvGETsfVC",
    "nodes": [
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -384,
          480
        ],
        "id": "53709328-0ac8-40ae-93b8-63fc3c1bb259",
        "name": "No Operation, do nothing"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "d990cbd6-a408-4ec4-a889-41be698918d9",
                "name": "message_type",
                "type": "string",
                "value": "={{ $('Receive Reply').item.json.body.messages[0].type }}"
              },
              {
                "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
                "name": "message_text",
                "type": "string",
                "value": "={{ $json.text }}"
              },
              {
                "id": "da4b602a-28ca-4b0d-a747-c3d3698c3731",
                "name": "message_caption",
                "type": "string",
                "value": "={{ $('Redirect Message Types').item.json.body.messages[0].video?.caption || $('Redirect Message Types').item.json.body.messages[0].image?.caption || $('Redirect Message Types').item.json.body.messages[0].audio?.caption || \"\" }}"
              },
              {
                "id": "9612af65-3421-4b94-b3c3-4231c762b351",
                "name": "chat_id",
                "value": "={{ $('Receive Reply').item.json.body.messages[0].chat_id }}",
                "type": "string"
              },
              {
                "id": "5a8f313b-0472-44a5-ba73-0907a983f351",
                "name": "channel_id",
                "value": "={{ $('Receive Reply').item.json.body.channel_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "f7aa5d03-d1c8-4106-934e-4aca86b067c8",
        "name": "Get User's Message",
        "type": "n8n-nodes-base.set",
        "position": [
          1728,
          -96
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "ec5e944c-7656-4860-adb7-edcfa8b95ed0",
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "text",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Text Message"
              },
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "05b30af4-967b-4824-abdc-84a8292ac0e5",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "image"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Image Message"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "75e367cd-3913-4ea4-a2ea-b0442b3325fb",
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "voice",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Voice Message"
              },
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "audio",
                      "id": "1113da73-5d4e-450e-90b3-960e6bec2e3c"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Audio Message"
              },
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "82aa5ff4-c9b6-4187-a27e-c7c5d9bfdda0",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "video"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Video Message"
              }
            ]
          },
          "options": {
            "fallbackOutput": "extra",
            "renameFallbackOutput": "Other Message Type"
          }
        },
        "id": "a2447531-cbf9-4836-b1f3-8e3d5f431276",
        "name": "Redirect Message Types",
        "type": "n8n-nodes-base.switch",
        "position": [
          144,
          -96
        ],
        "typeVersion": 3.2
      },
      {
        "parameters": {
          "modelName": "models/gemini-3-flash-preview",
          "options": {}
        },
        "id": "76507da5-802c-428b-a176-1f93a9ebae58",
        "name": "Google Gemini Chat Model",
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "position": [
          2416,
          96
        ],
        "typeVersion": 1,
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "a590dac3-2647-4ca9-87d6-444c5422a4e5",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -640,
          0
        ],
        "id": "162614d4-536a-489e-befd-8ff06d06b0b3",
        "name": "Receive Reply",
        "webhookId": "a590dac3-2647-4ca9-87d6-444c5422a4e5"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.body.messages[0].from_me }}",
                      "rightValue": "On",
                      "operator": {
                        "type": "boolean",
                        "operation": "false",
                        "singleValue": true
                      },
                      "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "On"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                      "leftValue": "={{ $json.body.messages[0].from_me }}",
                      "rightValue": "Off",
                      "operator": {
                        "type": "boolean",
                        "operation": "true",
                        "singleValue": true
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Off"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -128,
          -16
        ],
        "id": "ec7b28a1-a84e-4069-b6da-b5cd0ecc73a5",
        "name": "Check if Prospect's Message"
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n  \"classification\": \"human\",\n  \"reason\": \"The user is asking about pricing and used informal language.\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          848,
          -400
        ],
        "name": "Topic Output Parser",
        "id": "62bdc315-f3ff-40fe-a223-e3a5c1ff6c3c"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Receive Reply').item.json.body.messages[0].text.body }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are a message classifier for a WhatsApp message.\n\nTask: Analyze the incoming message and determine if it was sent by a human or an automated bot/system.\n\nClassification Criteria:\n- auto_bot: Identify as this if the message contains standard automated patterns such as \"Thank you for contacting us,\" \"An agent will be with you shortly,\" \"Select an option from the menu,\" or if it is a rigid, repetitive system notification.\n\n- human: Identify as this if the message contains natural language, slang, typos, specific questions, or conversational intent that varies from a script.\n\nConstraint: Your output must ONLY be a valid JSON object. Do not include any other text, greetings, or explanations.\n\nOutput Format: { \"classification\": \"human\" | \"auto_bot\", \"reason\": \"Brief explanation of why within 100 characters limit\" }"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          672,
          -592
        ],
        "name": "Check if Bot Message",
        "id": "5deaf20d-ae9e-4fef-8f71-5245e1f2d28d"
      },
      {
        "parameters": {
          "modelName": "models/gemini-3-flash-preview",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          624,
          -400
        ],
        "name": "Google Gemini LLM",
        "id": "a32abe91-4a04-4c46-a318-e96b5f004a61",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://gate.whapi.cloud/messages/list/{{ $json.chat_id }}",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "count",
                "value": "20"
              }
            ]
          },
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "accept",
                "value": "application/json"
              },
              {
                "name": "authorization",
                "value": "Bearer XRrTS2TMfTogsCgLuVQ2xrZLkBIw8OIR"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          1968,
          -96
        ],
        "id": "e02f4a2d-5811-4da1-943a-78e1a2516cd3",
        "name": "Get Chat History"
      },
      {
        "parameters": {
          "jsCode": "// Helper function to format timestamp\nfunction formatTimestamp(timestamp) {\n  const date = new Date(timestamp * 1000);\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const hours = String(date.getHours()).padStart(2, '0');\n  const minutes = String(date.getMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hours}:${minutes}`;\n}\n\n// 1. GET DATA FROM PREVIOUS NODES\nconst inputData = $input.all();\nconst latestInput = $(\"Get User's Message\").first().json; \nlet rawMessages = [];\n\nif (Array.isArray(inputData) && inputData.length > 0) {\n  const firstItem = inputData[0].json;\n  if (firstItem?.messages) {\n    rawMessages = firstItem.messages.filter(msg => msg.type !== 'action' && msg.type !== 'reaction');\n  }\n}\n\n// 2. DEFINE THE LEAD MESSAGE (Caption first, then Media Description)\nlet leadMessage = \"\";\n\nif (latestInput.message_type === 'text') {\n    leadMessage = latestInput.message_text;\n} else {\n    // Media Message Logic\n    const caption = latestInput.message_caption ? `Prospect's Caption: \"${latestInput.message_caption}\"` : \"User sent a media file with no caption.\";\n    const description = latestInput.message_text ? `\\n\\n[Explanation of the ${latestInput.message_type}]:\\n${latestInput.message_text}` : \"\";\n    \n    leadMessage = `${caption}${description}`;\n}\n\n// 3. PROCESS THE CHAT HISTORY THREAD\nconst processedMessages = rawMessages.map(item => {\n  const isFromMe = item.from_me === true;\n  const role = isFromMe ? 'SDR' : 'Prospect';\n  let text = item.text?.body || (item.caption ? item.caption : `[${item.type} file]`);\n  \n  return {\n    timestamp: item.timestamp,\n    formattedTime: formatTimestamp(item.timestamp),\n    role: role,\n    message: text.substring(0, 1000)\n  };\n});\n\n// Sort chronological\nconst chronologicalMessages = [...processedMessages].sort((a, b) => a.timestamp - b.timestamp);\n\n// Format as a string\nconst conversationThread = chronologicalMessages.map(msg => {\n  return `[${msg.formattedTime}] ${msg.role}: ${msg.message}`;\n}).join('\\n\\n');\n\nreturn {\n  json: {\n    leadMessage: leadMessage, \n    chatId: latestInput.chat_id,\n    conversationThreadFormatted: conversationThread,\n    summary: {\n      totalMessages: chronologicalMessages.length,\n      latestRole: latestInput.message_type === 'text' ? 'Prospect' : `Prospect (${latestInput.message_type})`\n    }\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2176,
          -96
        ],
        "name": "Parse Chat History",
        "id": "ba1d60e5-0e01-4ac0-a782-0d21ec1efc1b"
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n\t\"text\": \"Hi, do you take reservation for 10-12 pax?\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          2672,
          96
        ],
        "id": "5b3ea7d8-1dcb-44a9-bdd6-abbd5840fb6d",
        "name": "Structured Output Parser"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.body.event.type }}",
                      "rightValue": "messages",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Message"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                      "leftValue": "={{ $json.body.event.type }}",
                      "rightValue": "statuses",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Status"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -416,
          0
        ],
        "id": "7495747d-c0b1-40fb-b346-6a56c74358b9",
        "name": "Check event type"
      },
      {
        "parameters": {
          "jsCode": "// This node extracts image URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst imagesFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is image and has a link\n    if (msg.type === 'image' && msg.image && msg.image.link) {\n      imagesFound.push({\n        imageUrl: msg.image.link,\n        caption: msg.image.caption || \"\",\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// If no images were found, you might want to return an empty item \n// or a specific message to avoid errors in later nodes\nreturn imagesFound.length > 0 ? imagesFound : [{ imageUrl: null, status: \"no image found\" }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          624,
          -176
        ],
        "id": "4f5056e1-ef1a-4397-930c-437bb5fdbbd9",
        "name": "Get image URL"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "df3cc619-934d-4d62-9bff-db91d69107e5",
                "leftValue": "={{ $json.body.conversation.messages[0].sender.type === 'agent_bot' }}",
                "rightValue": "contact",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -656,
          464
        ],
        "id": "3bd44f31-147a-4dc8-9234-fd1ad64fc4e7",
        "name": "Check if human or bot"
      },
      {
        "parameters": {
          "jsCode": "// This node extracts voice/audio URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst audioFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Whapi uses 'voice' for voice notes and 'audio' for uploaded files\n    const audioData = msg.voice || msg.audio;\n    \n    if ((msg.type === 'voice' || msg.type === 'audio') && audioData && audioData.link) {\n      audioFound.push({\n        audioUrl: audioData.link,\n        chatId: msg.chat_id,\n        sender: msg.from_name,\n        seconds: audioData.seconds || 0,\n        mime_type: audioData.mime_type\n      });\n    }\n  }\n}\n\n// If no audio was found, return a null object to prevent workflow crashes\nreturn audioFound.length > 0 ? audioFound : [{ audioUrl: null, status: \"no audio found\" }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          624,
          32
        ],
        "id": "62328a45-e5a9-422d-9442-f2a0d7f55d54",
        "name": "Get Voice URL"
      },
      {
        "parameters": {
          "resource": "audio",
          "modelId": {
            "__rl": true,
            "value": "models/gemini-3-flash-preview",
            "mode": "list",
            "cachedResultName": "models/gemini-3-flash-preview"
          },
          "audioUrls": "={{ $json.audioUrl }}",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.googleGemini",
        "typeVersion": 1.1,
        "position": [
          848,
          32
        ],
        "id": "20717694-7e4f-417b-ab47-64c29425f2b7",
        "name": "Transcribe voice message",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "resource": "image",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "value": "models/gemini-2.0-flash",
            "mode": "list",
            "cachedResultName": "models/gemini-2.0-flash"
          },
          "text": "Here is an image sent by the user. Describe the image and transcribe any text visible in the image.",
          "imageUrls": "={{ $json.imageUrl }}",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.googleGemini",
        "typeVersion": 1.1,
        "position": [
          848,
          -176
        ],
        "id": "3158ca77-0569-4a28-92c1-bae7aae909fa",
        "name": "Analyze image",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// This node extracts video URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst videosFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is video and has a link\n    if (msg.type === 'video' && msg.video && msg.video.link) {\n      videosFound.push({\n        videoUrl: msg.video.link,\n        caption: msg.video.caption || \"\",\n        seconds: msg.video.seconds || 0,\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// Return video data or a null object to keep the workflow from breaking\nreturn videosFound.length > 0 ? videosFound : [{ videoUrl: null, status: \"no video found\" }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          624,
          240
        ],
        "id": "e4515859-021c-4cb8-a048-c6bfd47d8583",
        "name": "Get video URL"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $json.content.parts[0].text }}"
              }
            ]
          },
          "options": {}
        },
        "id": "f812a969-c037-4744-bb67-c02217381623",
        "name": "Format image description",
        "type": "n8n-nodes-base.set",
        "position": [
          1104,
          -176
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "resource": "video",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "value": "models/gemini-3-flash-preview",
            "mode": "list",
            "cachedResultName": "models/gemini-3-flash-preview"
          },
          "text": "Here is an video sent by the user. Describe the video briefly and transcribe any voice/audio message in the video.",
          "videoUrls": "={{ $json.videoUrl }}",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.googleGemini",
        "typeVersion": 1.1,
        "position": [
          848,
          240
        ],
        "id": "5d862cad-1054-47dd-87bc-0cbbc776ede2",
        "name": "Analyze video",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $json.content.parts[0].text }}"
              }
            ]
          },
          "options": {}
        },
        "id": "e23d094f-916b-4a62-b3aa-f106e9a245b6",
        "name": "Format video description",
        "type": "n8n-nodes-base.set",
        "position": [
          1104,
          240
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $json.content.parts[0].text }}"
              }
            ]
          },
          "options": {}
        },
        "id": "504f3642-18fe-4786-a761-17b2b20c548a",
        "name": "Format voice transcription",
        "type": "n8n-nodes-base.set",
        "position": [
          1104,
          32
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $('Redirect Message Types').item.json.body.messages[0].text.body }}"
              }
            ]
          },
          "options": {}
        },
        "id": "5c87fdcd-ba87-4874-9ac9-ccba7d6ababe",
        "name": "Format response",
        "type": "n8n-nodes-base.set",
        "position": [
          1104,
          -592
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"New prospect reply needs approval\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Name:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].type }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ JSON.stringify(($('Get User\\'s Message').item.json.message_text || '').length > 300 ? $('Get User\\'s Message').item.json.message_text.substring(0, 300) + '...' : ($('Get User\\'s Message').item.json.message_text || '')).slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Media caption:*\\n```{{ $('Get User\\'s Message').item.json.message_caption ? JSON.stringify($('Get User\\'s Message').item.json.message_caption).slice(1, -1) : 'NA' }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ JSON.stringify($json.output.text || '').slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"actions\",\n      \"block_id\": \"approval_actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \":white_check_mark: Approve & Send\",\n            \"emoji\": true\n          },\n          \"style\": \"primary\",\n          \"action_id\": \"approve\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \"✏ Reject & Send manually\",\n            \"emoji\": true\n          },\n          \"style\": \"danger\",\n          \"action_id\": \"reject\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        }\n      ]\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          2912,
          -96
        ],
        "id": "c34e3519-3ef4-4b34-9951-0abddc0f5690",
        "name": "Send to Slack for Approval",
        "credentials": {
          "httpBearerAuth": {
            "id": "jByqEazESu9xXEeO",
            "name": "Slack's WhatsApp Agent"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"Unrecognized message type received\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":warning: Unrecognized Message Type\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Name:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from_name }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n`{{ $('Redirect Message Types').item.json.body.messages[0].type }}`\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Status:* The AI Agent cannot process this file or message type automatically.\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Action Required:* Please check this conversation directly on WhatsApp to reply to the prospect.\"\n      }\n    },\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          352,
          304
        ],
        "id": "4a31ad8d-d319-4a88-863a-0c126b88dcbe",
        "name": "Notify in Slack",
        "credentials": {
          "httpBearerAuth": {
            "id": "jByqEazESu9xXEeO",
            "name": "Slack's WhatsApp Agent"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=- Prospect's latest message: {{ $json.leadMessage }}\n- Message type: {{ $('Receive Reply').item.json.body.messages[0].type }}\n- Chat history: {{ $json.conversationThreadFormatted }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are a Singaporean tourist who is visiting Australia with your family and looking for a restaurant to make a reservation for 10-12 pax. You've already asked the restaurant whether they're taking reservation and now they are responding to you. \n\nYour job is to follow up, answer their questions about your booking, ask if they have a reservation website for you to book by yourself, and if they don't, suggest them to use a reservation system to make it convenient for consumers like you.\n\nGuidelines:\n- Keep your response natural, casual, conversational, short and concise.\n- You don't need to tell the restaurant all details about your reservation all at once, provide the information when asked.\n- This is a conversation via WhatsApp text messages, so make it natural for text messages context.\n- Refer to the chat history to generate an appropriate response.\n\nDetails about your reservation:\n- You're with a family of 10, 8 adults and 2 kids (5 and 7 years old)\n- You're looking to make a reservation some time this week for next week, either lunch or dinner, you're unsure about the exact date and are flexible depending on the restaurant's availability\n- You & your family have no diet restriction & no allergy"
          }
        },
        "id": "eb062c5d-4a08-4647-9e3e-17e2f93d0217",
        "name": "Response Agent",
        "type": "@n8n/n8n-nodes-langchain.agent",
        "position": [
          2480,
          -96
        ],
        "typeVersion": 1.6
      }
    ],
    "connections": {
      "Get User's Message": {
        "main": [
          [
            {
              "node": "Get Chat History",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Redirect Message Types": {
        "main": [
          [
            {
              "node": "Check if Bot Message",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get image URL",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get Voice URL",
              "type": "main",
              "index": 0
            }
          ],
          [],
          [
            {
              "node": "Get video URL",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Notify in Slack",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "Response Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Receive Reply": {
        "main": [
          [
            {
              "node": "Check event type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Topic Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Check if Bot Message",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Check if Prospect's Message": {
        "main": [
          [
            {
              "node": "Redirect Message Types",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini LLM": {
        "ai_languageModel": [
          [
            {
              "node": "Check if Bot Message",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Check if Bot Message": {
        "main": [
          [
            {
              "node": "Format response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Chat History": {
        "main": [
          [
            {
              "node": "Parse Chat History",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Chat History": {
        "main": [
          [
            {
              "node": "Response Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Response Agent",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Check event type": {
        "main": [
          [
            {
              "node": "Check if Prospect's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get image URL": {
        "main": [
          [
            {
              "node": "Analyze image",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check if human or bot": {
        "main": [
          [],
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Voice URL": {
        "main": [
          [
            {
              "node": "Transcribe voice message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Analyze image": {
        "main": [
          [
            {
              "node": "Format image description",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Transcribe voice message": {
        "main": [
          [
            {
              "node": "Format voice transcription",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format image description": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get video URL": {
        "main": [
          [
            {
              "node": "Analyze video",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Analyze video": {
        "main": [
          [
            {
              "node": "Format video description",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format video description": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format voice transcription": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format response": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Response Agent": {
        "main": [
          [
            {
              "node": "Send to Slack for Approval",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Oddle Engineer",
    "name": "Version 218c6105",
    "description": "",
    "autosaved": false
  },
  "tags": []
}