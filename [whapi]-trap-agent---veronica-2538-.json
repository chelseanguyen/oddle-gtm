{
  "updatedAt": "2026-02-02T08:23:17.040Z",
  "createdAt": "2026-01-21T09:15:28.211Z",
  "id": "QAsTHdspRA6bfxQr",
  "name": "[Whapi] Trap Agent - Veronica 2538",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d990cbd6-a408-4ec4-a889-41be698918d9",
              "name": "message_type",
              "type": "string",
              "value": "={{ $('Receive Reply').item.json.body.messages[0].type }}"
            },
            {
              "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
              "name": "message_text",
              "type": "string",
              "value": "={{ $json.text }}"
            },
            {
              "id": "da4b602a-28ca-4b0d-a747-c3d3698c3731",
              "name": "message_caption",
              "type": "string",
              "value": "={{ $('Redirect Message Types').item.json.body.messages[0].video?.caption || $('Redirect Message Types').item.json.body.messages[0].image?.caption || $('Redirect Message Types').item.json.body.messages[0].audio?.caption || \"\" }}"
            },
            {
              "id": "9612af65-3421-4b94-b3c3-4231c762b351",
              "name": "chat_id",
              "value": "={{ $('Receive Reply').item.json.body.messages[0].chat_id }}",
              "type": "string"
            },
            {
              "id": "5a8f313b-0472-44a5-ba73-0907a983f351",
              "name": "channel_id",
              "value": "={{ $('Receive Reply').item.json.body.channel_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "6f1ee898-0a86-441d-ac56-2a69cf481686",
      "name": "Get User's Message",
      "type": "n8n-nodes-base.set",
      "position": [
        1824,
        -96
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ec5e944c-7656-4860-adb7-edcfa8b95ed0",
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "05b30af4-967b-4824-abdc-84a8292ac0e5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "image"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "75e367cd-3913-4ea4-a2ea-b0442b3325fb",
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "voice",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "audio",
                    "id": "1113da73-5d4e-450e-90b3-960e6bec2e3c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio Message"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "id": "82aa5ff4-c9b6-4187-a27e-c7c5d9bfdda0",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "video"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Video Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "89131ef6-0956-449c-b0ea-31fffced6303",
                    "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                    "rightValue": "link_preview",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Link provided"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Other Message Type"
        }
      },
      "id": "30acc774-0e90-4e26-888c-6b442ea6bfdc",
      "name": "Redirect Message Types",
      "type": "n8n-nodes-base.switch",
      "position": [
        144,
        -96
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "id": "a6c65e76-213e-440f-8f21-9858df194e45",
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        3488,
        944
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "wa-reply-received-3001",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -736,
        16
      ],
      "id": "6eb1c56f-2acb-4013-87df-a500439641f2",
      "name": "Receive Reply",
      "webhookId": "62be604b-79c8-4cf6-8108-5d4dbe37aea4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.messages[0].from_me }}",
                    "rightValue": "On",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    },
                    "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "From contact"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                    "leftValue": "={{ $json.body.messages[0].from_me }}",
                    "rightValue": "Off",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "From me"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -272,
        0
      ],
      "id": "8948c6d1-c7d3-40eb-b30d-f517618ab0ad",
      "name": "Check if Prospect's Message"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"classification\": \"human\",\n  \"reason\": \"The user is asking about pricing and used informal language.\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        960,
        -400
      ],
      "name": "Topic Output Parser",
      "id": "3ff13d42-2bc9-4f08-b973-d90669439525"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Receive Reply').item.json.body.messages[0].text.body }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a message classifier for a WhatsApp message.\n\nTask: Analyze the incoming message and determine if it was sent by a human or an automated bot/system.\n\nClassification Criteria:\n- auto_bot: Identify as this if the message contains standard automated patterns such as \"Thank you for contacting us,\" \"We will get back to you shortly,\" \"Select an option from the menu,\" or if it is a rigid, repetitive system notification.\n\n- human: Identify as this if the message contains natural language, slang, typos, specific questions, or conversational intent that varies from a script.\n\nConstraint: Your output must ONLY be a valid JSON object. Do not include any other text, greetings, or explanations.\n\nOutput Format: { \"classification\": \"human\" | \"auto_bot\", \"reason\": \"Brief explanation of why within 100 characters limit\" }"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        784,
        -560
      ],
      "name": "Check if Bot Message",
      "id": "403ebf38-f8e8-455f-b07f-e7c43fe17fd4"
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        736,
        -400
      ],
      "name": "Google Gemini LLM",
      "id": "c5d932c4-39ae-40b6-880a-651b963c2191",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://gate.whapi.cloud/messages/list/{{ $json.chat_id }}",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "count",
              "value": "20"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "authorization",
              "value": "Bearer XRrTS2TMfTogsCgLuVQ2xrZLkBIw8OIR"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2064,
        -96
      ],
      "id": "4cf72ab8-db2d-4889-940b-2fb086ad8494",
      "name": "Get Chat History"
    },
    {
      "parameters": {
        "jsCode": "// Helper function to format timestamp\nfunction formatTimestamp(timestamp) {\n  const date = new Date(timestamp * 1000);\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const hours = String(date.getHours()).padStart(2, '0');\n  const minutes = String(date.getMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hours}:${minutes}`;\n}\n\n// 1. GET DATA FROM PREVIOUS NODES\nconst inputData = $input.all();\nconst latestInput = $(\"Get User's Message\").first().json; \nlet rawMessages = [];\n\nif (Array.isArray(inputData) && inputData.length > 0) {\n  const firstItem = inputData[0].json;\n  if (firstItem?.messages) {\n    // Filter out system actions/reactions\n    rawMessages = firstItem.messages.filter(msg => msg.type !== 'action' && msg.type !== 'reaction');\n  }\n}\n\n// 2. DEFINE THE LEAD MESSAGE (Caption first, then Media Description)\nlet leadMessage = \"\";\n\nif (latestInput.message_type === 'text') {\n    leadMessage = latestInput.message_text;\n} else {\n    // Media Message Logic\n    const caption = latestInput.message_caption ? `Restaurant's Caption: \"${latestInput.message_caption}\"` : \"User sent a media file with no caption.\";\n    const description = latestInput.message_text ? `\\n\\n[Explanation of the ${latestInput.message_type}]:\\n${latestInput.message_text}` : \"\";\n    \n    leadMessage = `${caption}${description}`;\n}\n\n// 3. PROCESS THE CHAT HISTORY THREAD\nconst processedMessages = rawMessages.map(item => {\n  const isFromMe = item.from_me === true;\n  const role = isFromMe ? 'Veronica' : 'Restaurant';\n  let text = item.text?.body || (item.caption ? item.caption : `[${item.type} file]`);\n  \n  return {\n    timestamp: item.timestamp,\n    formattedTime: formatTimestamp(item.timestamp),\n    role: role,\n    isFromMe: isFromMe,\n    message: text.substring(0, 1000)\n  };\n});\n\n// Sort chronological (Oldest to Newest)\nconst chronologicalMessages = [...processedMessages].sort((a, b) => a.timestamp - b.timestamp);\n\n// 4. CALCULATE RESPONSE TIME (Numeric)\nlet responseTimeMinutes = 0; // Default to 0 for the IF node\n\nconst lastMsgIndex = chronologicalMessages.length - 1;\n\n// Only calculate if there are at least 2 messages and the latest is from the Contact\nif (lastMsgIndex > 0) {\n  const lastMsg = chronologicalMessages[lastMsgIndex];\n  \n  if (!lastMsg.isFromMe) {\n    // Look backwards for the first message from \"Me\" (Veronica)\n    for (let i = lastMsgIndex - 1; i >= 0; i--) {\n      if (chronologicalMessages[i].isFromMe) {\n        const diffInSeconds = lastMsg.timestamp - chronologicalMessages[i].timestamp;\n        const diffInMinutes = diffInSeconds / 60;\n        \n        // Logic: less than 1 min = 1, otherwise Round Up\n        if (diffInMinutes <= 1) {\n          responseTimeMinutes = 1;\n        } else {\n          responseTimeMinutes = Math.ceil(diffInMinutes);\n        }\n        break; // Found the latest response pair, exit loop\n      }\n    }\n  }\n}\n\n// 5. FORMAT THREAD FOR DISPLAY\nconst conversationThread = chronologicalMessages.map(msg => {\n  return `[${msg.formattedTime}] ${msg.role}: ${msg.message}`;\n}).join('\\n\\n');\n\n// 6. RETURN RESULTS\nreturn {\n  json: {\n    leadMessage: leadMessage, \n    chatId: latestInput.chat_id,\n    conversationThreadFormatted: conversationThread,\n    responseTimeMinutes: responseTimeMinutes,\n    summary: {\n      totalMessages: chronologicalMessages.length,\n      latestRole: latestInput.message_type === 'text' ? 'Restaurant' : `Restaurant (${latestInput.message_type})`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2272,
        -96
      ],
      "name": "Parse Chat History",
      "id": "748636e1-1cff-4063-a824-6bb31621301a"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\t\"text\": \"Hi, do you take reservation for 10-12 pax?\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        3744,
        944
      ],
      "id": "868f4d2d-a359-48ae-bec6-bed831eeea38",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.event.type }}",
                    "rightValue": "messages",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                    "leftValue": "={{ $json.body.event.type }}",
                    "rightValue": "statuses",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Status"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -512,
        16
      ],
      "id": "d1970b6a-1338-4cb8-ac9c-a684a5093c6c",
      "name": "Check event type"
    },
    {
      "parameters": {
        "jsCode": "// This node extracts image URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst imagesFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is image and has a link\n    if (msg.type === 'image' && msg.image && msg.image.link) {\n      imagesFound.push({\n        imageUrl: msg.image.link,\n        caption: msg.image.caption || \"\",\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// If no images were found, you might want to return an empty item \n// or a specific message to avoid errors in later nodes\nreturn imagesFound.length > 0 ? imagesFound : [{ imageUrl: null, status: \"no image found\" }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        736,
        -176
      ],
      "id": "ebcadf9b-f68f-42d8-bfe8-da9455d8c12e",
      "name": "Get image URL"
    },
    {
      "parameters": {
        "jsCode": "// This node extracts voice/audio URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst audioFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Whapi uses 'voice' for voice notes and 'audio' for uploaded files\n    const audioData = msg.voice || msg.audio;\n    \n    if ((msg.type === 'voice' || msg.type === 'audio') && audioData && audioData.link) {\n      audioFound.push({\n        audioUrl: audioData.link,\n        chatId: msg.chat_id,\n        sender: msg.from_name,\n        seconds: audioData.seconds || 0,\n        mime_type: audioData.mime_type\n      });\n    }\n  }\n}\n\n// If no audio was found, return a null object to prevent workflow crashes\nreturn audioFound.length > 0 ? audioFound : [{ audioUrl: null, status: \"no audio found\" }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        736,
        32
      ],
      "id": "a1460336-0758-44c6-986c-e5f5210a47b6",
      "name": "Get Voice URL"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-3-flash-preview",
          "mode": "list",
          "cachedResultName": "models/gemini-3-flash-preview"
        },
        "audioUrls": "={{ $json.audioUrl }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        960,
        32
      ],
      "id": "fb55441c-3ccf-44b0-8b8e-e40218a055fe",
      "name": "Transcribe voice message",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.0-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.0-flash"
        },
        "text": "Here is an image sent by the user. Describe the image and transcribe any text visible in the image.",
        "imageUrls": "={{ $json.imageUrl }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        960,
        -176
      ],
      "id": "3eba2ee1-8f4d-440a-8786-be718e28e62c",
      "name": "Analyze image",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// This node extracts video URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst videosFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is video and has a link\n    if (msg.type === 'video' && msg.video && msg.video.link) {\n      videosFound.push({\n        videoUrl: msg.video.link,\n        caption: msg.video.caption || \"\",\n        seconds: msg.video.seconds || 0,\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// Return video data or a null object to keep the workflow from breaking\nreturn videosFound.length > 0 ? videosFound : [{ videoUrl: null, status: \"no video found\" }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        736,
        240
      ],
      "id": "24f4d553-89e1-485c-a599-48760fd88e13",
      "name": "Get video URL"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "34181da2-61bb-401e-b6c5-22e2f49fae6c",
      "name": "Format image description",
      "type": "n8n-nodes-base.set",
      "position": [
        1216,
        -176
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-3-flash-preview",
          "mode": "list",
          "cachedResultName": "models/gemini-3-flash-preview"
        },
        "text": "Here is an video sent by the user. Describe the video briefly and transcribe any voice/audio message in the video.",
        "videoUrls": "={{ $json.videoUrl }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        960,
        240
      ],
      "id": "8d73e4c0-840b-482c-aeb8-95f3692f1b0f",
      "name": "Analyze video",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "60dc0d38-ff49-477e-996d-f9842990a96f",
      "name": "Format video description",
      "type": "n8n-nodes-base.set",
      "position": [
        1216,
        240
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "0038d780-dd2a-4525-ace0-d577c1b6730f",
      "name": "Format voice transcription",
      "type": "n8n-nodes-base.set",
      "position": [
        1216,
        32
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
              "name": "text",
              "type": "string",
              "value": "={{ $('Redirect Message Types').item.json.body.messages[0].text.body }}"
            }
          ]
        },
        "options": {}
      },
      "id": "b731c34c-572b-4d4c-97bd-332b787a6222",
      "name": "Format response",
      "type": "n8n-nodes-base.set",
      "position": [
        1344,
        -576
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"New prospect reply needs approval\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].type }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ JSON.stringify(($('Get User\\'s Message').item.json.message_text || '').length > 300 ? $('Get User\\'s Message').item.json.message_text.substring(0, 300) + '...' : ($('Get User\\'s Message').item.json.message_text || '')).slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Media caption:*\\n```{{ $('Get User\\'s Message').item.json.message_caption ? JSON.stringify($('Get User\\'s Message').item.json.message_caption).slice(1, -1) : 'NA' }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ JSON.stringify($json.output.text || '').slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"actions\",\n      \"block_id\": \"approval_actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \":white_check_mark: Approve & Send\",\n            \"emoji\": true\n          },\n          \"style\": \"primary\",\n          \"action_id\": \"approve\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \"‚úè Reject & Send manually\",\n            \"emoji\": true\n          },\n          \"style\": \"danger\",\n          \"action_id\": \"reject\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4256,
        736
      ],
      "id": "92a065a2-a86f-4be5-bb5e-8547e04914f3",
      "name": "Send to Slack for Approval",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"Unrecognized message type received\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":warning: Unrecognized Message Type\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n`{{ $('Redirect Message Types').item.json.body.messages[0].type }}`\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Status:* The AI Agent cannot process this file or message type automatically.\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Action Required:* Please check this conversation directly on WhatsApp to reply to the prospect.\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        736,
        768
      ],
      "id": "700da0fa-0a99-4004-8d46-66a0da18d94e",
      "name": "Notify in Slack",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3fb404a2-ac30-43cb-8535-60b7b4cc78bb",
              "leftValue": "={{ $json.responseTimeMinutes }}",
              "rightValue": 30,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2480,
        -96
      ],
      "id": "d1e35512-2e94-4e00-9971-0185ea899d8b",
      "name": "Check if respond after 30 mins"
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "id": "6ef6aa02-9ecf-4c1d-a299-3c95c50d6e9c",
      "name": "Google Gemini Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        3472,
        -288
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\t\"text\": \"Hi, do you take reservation for 10-12 pax?\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        3728,
        -288
      ],
      "id": "449f7720-f0e2-40c9-b2f2-f2cd5dbb93eb",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"New prospect reply needs approval\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].type }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ JSON.stringify(($('Get User\\'s Message').item.json.message_text || '').length > 300 ? $('Get User\\'s Message').item.json.message_text.substring(0, 300) + '...' : ($('Get User\\'s Message').item.json.message_text || '')).slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Media caption:*\\n```{{ $('Get User\\'s Message').item.json.message_caption ? JSON.stringify($('Get User\\'s Message').item.json.message_caption).slice(1, -1) : 'NA' }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ JSON.stringify($json.output.text || '').slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"actions\",\n      \"block_id\": \"approval_actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \":white_check_mark: Approve & Send\",\n            \"emoji\": true\n          },\n          \"style\": \"primary\",\n          \"action_id\": \"approve\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \"‚úè Reject & Send manually\",\n            \"emoji\": true\n          },\n          \"style\": \"danger\",\n          \"action_id\": \"reject\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4240,
        -496
      ],
      "id": "46e98a1e-847a-4baa-8fd8-7646d4f7ef12",
      "name": "Send to Slack for Approval1",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=- Prospect's latest message: {{ $('Parse Chat History').item.json.leadMessage }}\n- Message type: {{ $('Receive Reply').item.json.body.messages[0].type }}\n- Chat history: {{ $('Parse Chat History').item.json.conversationThreadFormatted }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are Veronica, a tourist from Singapore who is visiting Australia and contacting the restaurant to make a reservation for 10 pax.\n\nYou've already sent this WhatsApp message to the restaurant and are waiting for their response.\n\"Hi, is this {restaurant name} restaurant? I'd like to make a reservation for 10 pax, is there anyway I can book this online?\"\n\nGuidelines:\n- Speak proper English, do not use Singapore slang.\n- Keep your response natural, casual, conversational, short and concise in 1-2 short sentenced\n- This is a conversation via WhatsApp text messages, so make it natural for text messages context.\n- Refer to the chat history to generate an appropriate response.\nScenarios & Instruction to reply\n- If they reply this message, it means that they've replied more than half an hour later, then just reply this \"Sorry, we decided to go ahead with another restaurant cos we couldn't find a way to book a table with you online. You should really consider getting an online reservation system üòÖ\"\n- If you already replied them with the message above from the chat history, then STOP replying them"
        }
      },
      "id": "09232325-b82f-4203-9d8d-77822a8564af",
      "name": "Response Agent #1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        3536,
        -480
      ],
      "typeVersion": 1.6
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=- Prospect's latest message: {{ $('Parse Chat History').item.json.leadMessage }}\n- Message type: {{ $('Receive Reply').item.json.body.messages[0].type }}\n- Chat history: {{ $('Parse Chat History').item.json.conversationThreadFormatted }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are Veronica, a tourist from Singapore who is visiting Australia and contacting the restaurant to make a reservation for 10 pax.\n\nYou've already sent this WhatsApp message to the restaurant and are waiting for their response.\n\"Hi, is this {restaurant name} restaurant? I'd like to make a reservation for 10 pax, is there anyway I can book this online?\"\n\nGuidelines:\n- Speak proper English, do not use Singapore slang.\n- Keep your response natural, casual, conversational, short and concise in 1-2 short sentences\n- This is a conversation via WhatsApp text messages, so make it natural for text messages context.\n- Refer to the chat history to generate an appropriate response.\n\nScenarios & Instruction to reply\n- If the restaurant says they can take reservation, ask if they have a reservation link to book online because you need to coordinate some details with your friends.\n- If the restaurant asks why you need to reserve online, say that it's because I need to coordinate with your friends before you could make a reservation.\n- If the restaurant asks for your booking date or details, say that you're not sure yet and still checking with your friends, then ask if they have a booking link.\n- If the restaurant asks for other details of your reservation, answer according to your knowledge and if you don't know, come up with something generic.\n- If the restaurant says the have online booking or that you can book from their website, you say \"Okay great, can you send me the link?\" and stop replying from here onwards.\n- If restaurant says there is no online booking, you say \"Let me check with my friends, I'll get back to you\" and stop replying from here onwards.\n- If you already said \"Okay great, can you send me the link?\" or \"Let me check with my friends, I'll get back to you\" from the chat history, then STOP replying them"
        }
      },
      "id": "5920b91c-e3f4-45bd-8a23-a6f33850bcd3",
      "name": "Response Agent #2",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        3552,
        752
      ],
      "typeVersion": 1.6
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -272,
        208
      ],
      "id": "d2b6b2e6-0a4f-4339-90ba-a77f4aeced24",
      "name": "Skip status"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -16,
        208
      ],
      "id": "14f8b96d-300f-4dce-bb14-f3c2d2df73a3",
      "name": "Skip my message"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4240,
        -256
      ],
      "id": "7fdd977e-db00-40c1-b100-cef54bb2da8f",
      "name": "Skip agent 1's response"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4272,
        976
      ],
      "id": "5d361054-229b-4361-8ad0-36cecb1d66af",
      "name": "Skip agent 2's response"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "462e3c61-8795-4b23-8431-8d3769d961a4",
              "leftValue": "={{ $json.output.text }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3936,
        -480
      ],
      "id": "518b04af-f0e5-49a3-a37c-7af870989ad1",
      "name": "If agent 1 continues to respond"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "462e3c61-8795-4b23-8431-8d3769d961a4",
              "leftValue": "={{ $json.output.text }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3968,
        752
      ],
      "id": "83bfdd63-8231-4972-a05e-cc06c2d6934f",
      "name": "If agent 2 continues to respond"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "78141ca4-f380-4d9a-908a-2f9db44e9c88",
              "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
              "rightValue": "([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2944,
        -496
      ],
      "id": "5a1c4c48-9d20-4a4f-bc8f-61b9e8ebfd38",
      "name": "Check for booking link"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "78141ca4-f380-4d9a-908a-2f9db44e9c88",
              "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
              "rightValue": "([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2944,
        336
      ],
      "id": "db0c5db7-97bd-4172-9683-7c5ebb41cfcd",
      "name": "Check for booking link_2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Booking Link Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:calendar: New Booking Link Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Reservation Booking Link:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].link_preview.url }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Redirect Message Types').item.json.body.messages[0].link_preview?.body ? JSON.stringify($('Redirect Message Types').item.json.body.messages[0].link_preview.body).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        736,
        544
      ],
      "id": "fe622d85-393d-4b32-99e2-3876fae8415e",
      "name": "Send link to Slack",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Booking Link Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:calendar: New Booking Link Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Reservation Booking Link:*\\n{{ $json.extractedBookingUrl }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4048,
        -768
      ],
      "id": "8b7f90ef-6c93-4bcc-94f1-dc81fe6353a3",
      "name": "Send booking link to Slack 2",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Booking Link Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:calendar: New Booking Link Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Reservation Booking Link:*\\n{{ $json.extractedBookingUrl }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4080,
        448
      ],
      "id": "3f8602c9-e005-435f-a626-5327a3cb058c",
      "name": "Send booking link to Slack 3",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.output.classification }}",
                    "rightValue": "human",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f620673b-58a0-4990-b57d-aeceafc007f7"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Human reply"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "ef99233a-2a44-4831-b14d-9a6928d5afce",
                    "leftValue": "={{ $json.output.classification }}",
                    "rightValue": "auto_bot",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Auto reply"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1104,
        -560
      ],
      "id": "8e58f025-1a57-457f-b236-b2d423ff9158",
      "name": "Switch"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1344,
        -384
      ],
      "id": "a8033eb2-6f7d-4e5a-a192-944cb70db859",
      "name": "Skip auto reply"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
          "mode": "list",
          "cachedResultName": "AU OR Outreach - 2026",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1716060325,
          "mode": "list",
          "cachedResultName": "Target_List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Reservation Link": "={{ $('Redirect Message Types').item.json.body.messages[0].link_preview.url }}",
            "Number": "={{ $json.body.messages[0].from }}"
          },
          "matchingColumns": [
            "Number"
          ],
          "schema": [
            {
              "id": "Number",
              "displayName": "Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "1st Msg",
              "displayName": "1st Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "2nd Msg",
              "displayName": "2nd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "3rd Msg",
              "displayName": "3rd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Queue Status",
              "displayName": "Message Queue Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Delivery Status",
              "displayName": "Message Delivery Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "First Response",
              "displayName": "First Response",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Sender",
              "displayName": "Sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Restaurant Name",
              "displayName": "Restaurant Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Batch Number",
              "displayName": "Batch Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Remarks",
              "displayName": "Remarks",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 1",
              "displayName": "Message 1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 2",
              "displayName": "Message 2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 3",
              "displayName": "Message 3",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Entry ID",
              "displayName": "Entry ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Place ID",
              "displayName": "Place ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Record ID",
              "displayName": "Record ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "record (attio)",
              "displayName": "record (attio)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Reservation Link",
              "displayName": "Reservation Link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        944,
        544
      ],
      "id": "e4cbb2d9-bf52-4daa-93db-cd838f478a24",
      "name": "Add reservation link to Google Sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H3k1lZEtuCVhMzHl",
          "name": "Google Sheets account 1"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
          "mode": "list",
          "cachedResultName": "AU OR Outreach - 2026",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1716060325,
          "mode": "list",
          "cachedResultName": "Target_List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
            "Reservation Link": "={{ $('Extract booking link1').item.json.extractedBookingUrl }}"
          },
          "matchingColumns": [
            "Number"
          ],
          "schema": [
            {
              "id": "Number",
              "displayName": "Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "1st Msg",
              "displayName": "1st Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "2nd Msg",
              "displayName": "2nd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "3rd Msg",
              "displayName": "3rd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Queue Status",
              "displayName": "Message Queue Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Delivery Status",
              "displayName": "Message Delivery Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "First Response",
              "displayName": "First Response",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Sender",
              "displayName": "Sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Restaurant Name",
              "displayName": "Restaurant Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Batch Number",
              "displayName": "Batch Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Remarks",
              "displayName": "Remarks",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 1",
              "displayName": "Message 1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 2",
              "displayName": "Message 2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 3",
              "displayName": "Message 3",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Entry ID",
              "displayName": "Entry ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Place ID",
              "displayName": "Place ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Record ID",
              "displayName": "Record ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "record (attio)",
              "displayName": "record (attio)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Reservation Link",
              "displayName": "Reservation Link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4272,
        -768
      ],
      "id": "5e51507f-f611-4ddb-937e-f76e92dfa007",
      "name": "Add reservation link to Google Sheet_2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H3k1lZEtuCVhMzHl",
          "name": "Google Sheets account 1"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Regex to capture domains/URLs even without http/https\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n  \n  const match = message.match(urlRegex);\n  \n  if (match) {\n    let extractedUrl = match[0];\n    \n    // Prepend https:// if the lead only provided the domain (e.g., barregio.com.au)\n    if (!extractedUrl.startsWith('http')) {\n      extractedUrl = 'https://' + extractedUrl;\n    }\n    \n    item.json.extractedBookingUrl = extractedUrl;\n  } else {\n    item.json.extractedBookingUrl = 'No URL found';\n  }\n\n  // Remove the conversationThreadFormatted field\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3856,
        448
      ],
      "id": "9757e4cb-9a2a-4098-b90f-c7bb5daaea85",
      "name": "Extract booking link"
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Regex to capture domains/URLs even without http/https\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n  \n  const match = message.match(urlRegex);\n  \n  if (match) {\n    let extractedUrl = match[0];\n    \n    // Prepend https:// if the lead only provided the domain (e.g., barregio.com.au)\n    if (!extractedUrl.startsWith('http')) {\n      extractedUrl = 'https://' + extractedUrl;\n    }\n    \n    item.json.extractedBookingUrl = extractedUrl;\n  } else {\n    item.json.extractedBookingUrl = 'No URL found';\n  }\n\n  // Remove the conversationThreadFormatted field\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3808,
        -768
      ],
      "id": "adfb34ec-fc52-493e-9bfa-ea6caa80cb3e",
      "name": "Extract booking link1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
          "mode": "list",
          "cachedResultName": "AU OR Outreach - 2026",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1716060325,
          "mode": "list",
          "cachedResultName": "Target_List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Reservation Link": "={{ $('Extract booking link').item.json.extractedBookingUrl }}",
            "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
            "Trap Set": "NA"
          },
          "matchingColumns": [
            "Number"
          ],
          "schema": [
            {
              "id": "Number",
              "displayName": "Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "1st Msg",
              "displayName": "1st Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "2nd Msg",
              "displayName": "2nd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "3rd Msg",
              "displayName": "3rd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Queue Status",
              "displayName": "Message Queue Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Delivery Status",
              "displayName": "Message Delivery Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "First Response",
              "displayName": "First Response",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Sender",
              "displayName": "Sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Restaurant Name",
              "displayName": "Restaurant Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Batch Number",
              "displayName": "Batch Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Remarks",
              "displayName": "Remarks",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 1",
              "displayName": "Message 1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 2",
              "displayName": "Message 2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 3",
              "displayName": "Message 3",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Entry ID",
              "displayName": "Entry ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Place ID",
              "displayName": "Place ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Record ID",
              "displayName": "Record ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "record (attio)",
              "displayName": "record (attio)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Reservation Link",
              "displayName": "Reservation Link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Trap Set",
              "displayName": "Trap Set",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4288,
        448
      ],
      "id": "fa778326-99a2-45f4-8da3-246a65bd895e",
      "name": "Add reservation link to Google Sheet_3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H3k1lZEtuCVhMzHl",
          "name": "Google Sheets account 1"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Define specific regex for both types\n  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/i;\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n\n  const emailMatch = message.match(emailRegex);\n  const urlMatch = message.match(urlRegex);\n\n  // Logic: Check for email first to prevent overlap\n  if (emailMatch) {\n    item.json.extractedType = 'email';\n    item.json.extractedValue = emailMatch[0];\n  } else if (urlMatch) {\n    item.json.extractedType = 'url';\n    let url = urlMatch[0];\n    // Prepend https:// if it's a naked domain like barregio.com.au\n    item.json.extractedValue = url.startsWith('http') ? url : 'https://' + url;\n  } else {\n    item.json.extractedValue = 'No match found';\n  }\n\n  // Remove the conversationThreadFormatted field to keep output clean\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3856,
        224
      ],
      "id": "326ba0e4-485a-47e6-b3a7-4d3a6a1fa6cd",
      "name": "Extract email"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
          "mode": "list",
          "cachedResultName": "AU OR Outreach - 2026",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1716060325,
          "mode": "list",
          "cachedResultName": "Target_List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
            "Reservation Link": "Manual",
            "Trap Set": "NA",
            "Email": "={{ $json.extractedValue }}"
          },
          "matchingColumns": [
            "Number"
          ],
          "schema": [
            {
              "id": "Number",
              "displayName": "Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "1st Msg",
              "displayName": "1st Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "2nd Msg",
              "displayName": "2nd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "3rd Msg",
              "displayName": "3rd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Queue Status",
              "displayName": "Message Queue Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Delivery Status",
              "displayName": "Message Delivery Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "First Response",
              "displayName": "First Response",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Sender",
              "displayName": "Sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Restaurant Name",
              "displayName": "Restaurant Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Batch Number",
              "displayName": "Batch Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Remarks",
              "displayName": "Remarks",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 1",
              "displayName": "Message 1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 2",
              "displayName": "Message 2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 3",
              "displayName": "Message 3",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Entry ID",
              "displayName": "Entry ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Place ID",
              "displayName": "Place ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Record ID",
              "displayName": "Record ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "record (attio)",
              "displayName": "record (attio)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Reservation Link",
              "displayName": "Reservation Link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Trap Set",
              "displayName": "Trap Set",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4096,
        224
      ],
      "id": "82cb2c55-dce5-4526-955e-3e20bbca8913",
      "name": "Add email to Gsheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H3k1lZEtuCVhMzHl",
          "name": "Google Sheets account 1"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Define specific regex for both types\n  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/i;\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n\n  const emailMatch = message.match(emailRegex);\n  const urlMatch = message.match(urlRegex);\n\n  // Logic: Check for email first to prevent overlap\n  if (emailMatch) {\n    item.json.extractedType = 'email';\n    item.json.extractedValue = emailMatch[0];\n  } else if (urlMatch) {\n    item.json.extractedType = 'url';\n    let url = urlMatch[0];\n    // Prepend https:// if it's a naked domain like barregio.com.au\n    item.json.extractedValue = url.startsWith('http') ? url : 'https://' + url;\n  } else {\n    item.json.extractedValue = 'No match found';\n  }\n\n  // Remove the conversationThreadFormatted field to keep output clean\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3808,
        -976
      ],
      "id": "5e0f7a97-a5a2-4f80-8585-406c97159885",
      "name": "Extract email1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
          "mode": "list",
          "cachedResultName": "AU OR Outreach - 2026",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1716060325,
          "mode": "list",
          "cachedResultName": "Target_List",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
            "Reservation Link": "Manual",
            "Trap Set": "Done",
            "Email": "={{ $json.extractedValue }}"
          },
          "matchingColumns": [
            "Number"
          ],
          "schema": [
            {
              "id": "Number",
              "displayName": "Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "1st Msg",
              "displayName": "1st Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "2nd Msg",
              "displayName": "2nd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "3rd Msg",
              "displayName": "3rd Msg",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Queue Status",
              "displayName": "Message Queue Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message Delivery Status",
              "displayName": "Message Delivery Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "First Response",
              "displayName": "First Response",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Sender",
              "displayName": "Sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Restaurant Name",
              "displayName": "Restaurant Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Batch Number",
              "displayName": "Batch Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Remarks",
              "displayName": "Remarks",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 1",
              "displayName": "Message 1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 2",
              "displayName": "Message 2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Message 3",
              "displayName": "Message 3",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Entry ID",
              "displayName": "Entry ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Place ID",
              "displayName": "Place ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Record ID",
              "displayName": "Record ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "record (attio)",
              "displayName": "record (attio)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Reservation Link",
              "displayName": "Reservation Link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Trap Set",
              "displayName": "Trap Set",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4144,
        -976
      ],
      "id": "e2e45e0d-26b7-437c-b5ff-ec1ebfc8545b",
      "name": "Add email to Gsheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H3k1lZEtuCVhMzHl",
          "name": "Google Sheets account 1"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "5c09f968-7624-4e62-813b-f197da23608f",
              "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
              "rightValue": "@",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3552,
        320
      ],
      "id": "3677762b-2c3c-42b0-a95e-83f0a9ea91d8",
      "name": "Check for email"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "5c09f968-7624-4e62-813b-f197da23608f",
              "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
              "rightValue": "@",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3536,
        -896
      ],
      "id": "451c5edd-39d2-4ebf-8b7b-2cff512664d7",
      "name": "Check for email1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Email address Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:e-mail: New Email Address Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Email Address:*\\n{{ $json.extractedValue }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4144,
        -1184
      ],
      "id": "f581f915-8185-4f0e-989a-f3bdfc8d5a22",
      "name": "Send email to Slack ",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Email address Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:e-mail: New Email Address Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Email Address:*\\n{{ $json.extractedValue }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4096,
        48
      ],
      "id": "ddb456dd-a568-438a-98dd-d025ea857227",
      "name": "Send email to Slack 1",
      "credentials": {
        "httpBearerAuth": {
          "id": "SWDEgTIP3Iofj3Ek",
          "name": "Slack's WhatsApp Agent 2538"
        }
      }
    },
    {
      "parameters": {
        "content": "## Receive & categorize message\n- Whether it's incoming message from prospect or outgoing message from our number\n- Message type: text, image, video, voice or others ",
        "height": 640,
        "width": 1168
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -784,
        -224
      ],
      "typeVersion": 1,
      "id": "d1cba349-7b48-4895-829b-945b7f0c3455",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### Record booking link provided\nIf prospect provides a link for their reservation, record it in the designated google sheet",
        "height": 256,
        "width": 1328,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        656,
        464
      ],
      "typeVersion": 1,
      "id": "b9a6edfc-d15b-413c-b39c-c89787d82d77",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "### Process incoming message & standardize into text",
        "height": 1040,
        "width": 1328,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        656,
        -624
      ],
      "typeVersion": 1,
      "id": "64066dcd-3b5d-4673-af23-ed85e1a5042f",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "### Retrive chat history\nAs a context for AI agent to generate response",
        "height": 352,
        "width": 432,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2016,
        -240
      ],
      "typeVersion": 1,
      "id": "f8dc4900-e8e6-4381-96f5-785cf722f986",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "### Record booking link/email provided\nIf prospect provides a link or email address for their reservation, record it in the designated google sheet",
        "height": 704,
        "width": 1104,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3424,
        -1280
      ],
      "typeVersion": 1,
      "id": "23729247-8a0d-4e62-8b58-ad5297ee55fe",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "### Record booking link/email provided\nIf prospect provides a link or email address for their reservation, record it in the designated google sheet",
        "height": 704,
        "width": 1104,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3424,
        -48
      ],
      "typeVersion": 1,
      "id": "0aeabfa3-e700-4b41-96c1-cfca5fbe2242",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "### Generate a response & send to human for approval in Slack",
        "height": 480,
        "width": 1104,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3424,
        688
      ],
      "typeVersion": 1,
      "id": "84b49ae9-655a-4f49-81de-422af6d5a043",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "### Generate a response & send to human for approval in Slack",
        "height": 448,
        "width": 1104,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3424,
        -544
      ],
      "typeVersion": 1,
      "id": "441af4da-28de-47d1-9e47-8d5d930c68d7",
      "name": "Sticky Note7"
    }
  ],
  "connections": {
    "Get User's Message": {
      "main": [
        [
          {
            "node": "Get Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redirect Message Types": {
      "main": [
        [
          {
            "node": "Check if Bot Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get image URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Voice URL",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Get video URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send link to Slack",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify in Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Response Agent #2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Receive Reply": {
      "main": [
        [
          {
            "node": "Check event type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Topic Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Check if Bot Message",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Check if Prospect's Message": {
      "main": [
        [
          {
            "node": "Redirect Message Types",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip my message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini LLM": {
      "ai_languageModel": [
        [
          {
            "node": "Check if Bot Message",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Check if Bot Message": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Chat History": {
      "main": [
        [
          {
            "node": "Parse Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Chat History": {
      "main": [
        [
          {
            "node": "Check if respond after 30 mins",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Response Agent #2",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Check event type": {
      "main": [
        [
          {
            "node": "Check if Prospect's Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get image URL": {
      "main": [
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Voice URL": {
      "main": [
        [
          {
            "node": "Transcribe voice message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Format image description",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe voice message": {
      "main": [
        [
          {
            "node": "Format voice transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format image description": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get video URL": {
      "main": [
        [
          {
            "node": "Analyze video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze video": {
      "main": [
        [
          {
            "node": "Format video description",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format video description": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format voice transcription": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format response": {
      "main": [
        [
          {
            "node": "Get User's Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if respond after 30 mins": {
      "main": [
        [
          {
            "node": "Check for booking link",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check for booking link_2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Response Agent #1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Response Agent #1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Response Agent #1": {
      "main": [
        [
          {
            "node": "If agent 1 continues to respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response Agent #2": {
      "main": [
        [
          {
            "node": "If agent 2 continues to respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If agent 1 continues to respond": {
      "main": [
        [
          {
            "node": "Send to Slack for Approval1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip agent 1's response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If agent 2 continues to respond": {
      "main": [
        [
          {
            "node": "Send to Slack for Approval",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip agent 2's response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip agent 1's response": {
      "main": [
        []
      ]
    },
    "Check for booking link": {
      "main": [
        [
          {
            "node": "Check for email1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Agent #1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for booking link_2": {
      "main": [
        [
          {
            "node": "Check for email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Agent #2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Format response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip auto reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send link to Slack": {
      "main": [
        [
          {
            "node": "Add reservation link to Google Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send booking link to Slack 2": {
      "main": [
        [
          {
            "node": "Add reservation link to Google Sheet_2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract booking link": {
      "main": [
        [
          {
            "node": "Send booking link to Slack 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send booking link to Slack 3": {
      "main": [
        [
          {
            "node": "Add reservation link to Google Sheet_3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract booking link1": {
      "main": [
        [
          {
            "node": "Send booking link to Slack 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract email": {
      "main": [
        [
          {
            "node": "Add email to Gsheet",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send email to Slack 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract email1": {
      "main": [
        [
          {
            "node": "Add email to Gsheet1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send email to Slack ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for email": {
      "main": [
        [
          {
            "node": "Extract email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract booking link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for email1": {
      "main": [
        [
          {
            "node": "Extract email1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract booking link1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "timeSavedPerExecution": 5
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Receive Reply": [
      {
        "json": {
          "headers": {
            "host": "workflow.oddle.center",
            "accept": "application/json",
            "content-type": "application/json",
            "content-length": "315",
            "sentry-trace": "55b74b8fe3bbbc9af8dbbe9d362a3a5a-028eae7badb7921c",
            "baggage": "sentry-environment=prod,sentry-public_key=22217dc31eef5d21afad60404664acb9,sentry-trace_id=55b74b8fe3bbbc9af8dbbe9d362a3a5a",
            "x-cloud-trace-context": "3f0cd0d7704e9e64a8ed4923d65bd812/6368666425047097093",
            "x-forwarded-proto": "https",
            "traceparent": "00-3f0cd0d7704e9e64a8ed4923d65bd812-58620c5ef5e39f05-00",
            "x-forwarded-for": "37.27.52.231",
            "forwarded": "for=\"37.27.52.231\";proto=https"
          },
          "params": {},
          "query": {},
          "body": {
            "messages": [
              {
                "id": "OknaKhRcICuq_w-gMgBiNQgng",
                "from_me": false,
                "type": "text",
                "chat_id": "6590570654@s.whatsapp.net",
                "timestamp": 1768981350,
                "source": "mobile",
                "text": {
                  "body": "Book at abckeht@gmail.com"
                },
                "from": "6590570654",
                "from_name": "Chelsea"
              }
            ],
            "event": {
              "type": "messages",
              "event": "post"
            },
            "channel_id": "NIGHTW-AH7E6"
          },
          "webhookUrl": "https://workflow.oddle.center/webhook-test/wa-reply-received",
          "executionMode": "test"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "5ae1fae7-8f6e-48b4-b849-bb1da0586b40",
  "activeVersionId": "ffc7ed94-ac99-4994-a121-c07fa7f58350",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-01-21T09:15:28.211Z",
      "createdAt": "2026-01-21T09:15:28.211Z",
      "role": "workflow:owner",
      "workflowId": "QAsTHdspRA6bfxQr",
      "projectId": "tAHBdayTR1Nb6OKK"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-21T09:19:05.688Z",
    "createdAt": "2026-01-21T09:19:01.420Z",
    "versionId": "ffc7ed94-ac99-4994-a121-c07fa7f58350",
    "workflowId": "QAsTHdspRA6bfxQr",
    "nodes": [
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -384,
          480
        ],
        "id": "32f03db8-f2de-4672-a60b-8d3d7756f27d",
        "name": "No Operation, do nothing"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "d990cbd6-a408-4ec4-a889-41be698918d9",
                "name": "message_type",
                "type": "string",
                "value": "={{ $('Receive Reply').item.json.body.messages[0].type }}"
              },
              {
                "id": "23b785c3-f38e-4706-80b7-51f333bba3bd",
                "name": "message_text",
                "type": "string",
                "value": "={{ $json.text }}"
              },
              {
                "id": "da4b602a-28ca-4b0d-a747-c3d3698c3731",
                "name": "message_caption",
                "type": "string",
                "value": "={{ $('Redirect Message Types').item.json.body.messages[0].video?.caption || $('Redirect Message Types').item.json.body.messages[0].image?.caption || $('Redirect Message Types').item.json.body.messages[0].audio?.caption || \"\" }}"
              },
              {
                "id": "9612af65-3421-4b94-b3c3-4231c762b351",
                "name": "chat_id",
                "value": "={{ $('Receive Reply').item.json.body.messages[0].chat_id }}",
                "type": "string"
              },
              {
                "id": "5a8f313b-0472-44a5-ba73-0907a983f351",
                "name": "channel_id",
                "value": "={{ $('Receive Reply').item.json.body.channel_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "6f1ee898-0a86-441d-ac56-2a69cf481686",
        "name": "Get User's Message",
        "type": "n8n-nodes-base.set",
        "position": [
          1824,
          -96
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "ec5e944c-7656-4860-adb7-edcfa8b95ed0",
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "text",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Text Message"
              },
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "05b30af4-967b-4824-abdc-84a8292ac0e5",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "image"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Image Message"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "75e367cd-3913-4ea4-a2ea-b0442b3325fb",
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "voice",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Voice Message"
              },
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "audio",
                      "id": "1113da73-5d4e-450e-90b3-960e6bec2e3c"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Audio Message"
              },
              {
                "conditions": {
                  "options": {
                    "version": 2,
                    "leftValue": "",
                    "caseSensitive": true,
                    "typeValidation": "strict"
                  },
                  "conditions": [
                    {
                      "id": "82aa5ff4-c9b6-4187-a27e-c7c5d9bfdda0",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "video"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Video Message"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "89131ef6-0956-449c-b0ea-31fffced6303",
                      "leftValue": "={{ $('Receive Reply').item.json.body.messages[0].type }}",
                      "rightValue": "link_preview",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Link provided"
              }
            ]
          },
          "options": {
            "fallbackOutput": "extra",
            "renameFallbackOutput": "Other Message Type"
          }
        },
        "id": "30acc774-0e90-4e26-888c-6b442ea6bfdc",
        "name": "Redirect Message Types",
        "type": "n8n-nodes-base.switch",
        "position": [
          144,
          -96
        ],
        "typeVersion": 3.2
      },
      {
        "parameters": {
          "modelName": "models/gemini-3-flash-preview",
          "options": {}
        },
        "id": "a6c65e76-213e-440f-8f21-9858df194e45",
        "name": "Google Gemini Chat Model",
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "position": [
          3168,
          928
        ],
        "typeVersion": 1,
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "wa-reply-received-3001",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2.1,
        "position": [
          -736,
          16
        ],
        "id": "6eb1c56f-2acb-4013-87df-a500439641f2",
        "name": "Receive Reply",
        "webhookId": "62be604b-79c8-4cf6-8108-5d4dbe37aea4"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.body.messages[0].from_me }}",
                      "rightValue": "On",
                      "operator": {
                        "type": "boolean",
                        "operation": "false",
                        "singleValue": true
                      },
                      "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "From contact"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                      "leftValue": "={{ $json.body.messages[0].from_me }}",
                      "rightValue": "Off",
                      "operator": {
                        "type": "boolean",
                        "operation": "true",
                        "singleValue": true
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "From me"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -272,
          0
        ],
        "id": "8948c6d1-c7d3-40eb-b30d-f517618ab0ad",
        "name": "Check if Prospect's Message"
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n  \"classification\": \"human\",\n  \"reason\": \"The user is asking about pricing and used informal language.\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          960,
          -400
        ],
        "name": "Topic Output Parser",
        "id": "3ff13d42-2bc9-4f08-b973-d90669439525"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Receive Reply').item.json.body.messages[0].text.body }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are a message classifier for a WhatsApp message.\n\nTask: Analyze the incoming message and determine if it was sent by a human or an automated bot/system.\n\nClassification Criteria:\n- auto_bot: Identify as this if the message contains standard automated patterns such as \"Thank you for contacting us,\" \"We will get back to you shortly,\" \"Select an option from the menu,\" or if it is a rigid, repetitive system notification.\n\n- human: Identify as this if the message contains natural language, slang, typos, specific questions, or conversational intent that varies from a script.\n\nConstraint: Your output must ONLY be a valid JSON object. Do not include any other text, greetings, or explanations.\n\nOutput Format: { \"classification\": \"human\" | \"auto_bot\", \"reason\": \"Brief explanation of why within 100 characters limit\" }"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          784,
          -560
        ],
        "name": "Check if Bot Message",
        "id": "403ebf38-f8e8-455f-b07f-e7c43fe17fd4"
      },
      {
        "parameters": {
          "modelName": "models/gemini-3-flash-preview",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          736,
          -400
        ],
        "name": "Google Gemini LLM",
        "id": "c5d932c4-39ae-40b6-880a-651b963c2191",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://gate.whapi.cloud/messages/list/{{ $json.chat_id }}",
          "sendQuery": true,
          "queryParameters": {
            "parameters": [
              {
                "name": "count",
                "value": "20"
              }
            ]
          },
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "accept",
                "value": "application/json"
              },
              {
                "name": "authorization",
                "value": "Bearer XRrTS2TMfTogsCgLuVQ2xrZLkBIw8OIR"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          2064,
          -96
        ],
        "id": "4cf72ab8-db2d-4889-940b-2fb086ad8494",
        "name": "Get Chat History"
      },
      {
        "parameters": {
          "jsCode": "// Helper function to format timestamp\nfunction formatTimestamp(timestamp) {\n  const date = new Date(timestamp * 1000);\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const hours = String(date.getHours()).padStart(2, '0');\n  const minutes = String(date.getMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hours}:${minutes}`;\n}\n\n// 1. GET DATA FROM PREVIOUS NODES\nconst inputData = $input.all();\nconst latestInput = $(\"Get User's Message\").first().json; \nlet rawMessages = [];\n\nif (Array.isArray(inputData) && inputData.length > 0) {\n  const firstItem = inputData[0].json;\n  if (firstItem?.messages) {\n    // Filter out system actions/reactions\n    rawMessages = firstItem.messages.filter(msg => msg.type !== 'action' && msg.type !== 'reaction');\n  }\n}\n\n// 2. DEFINE THE LEAD MESSAGE (Caption first, then Media Description)\nlet leadMessage = \"\";\n\nif (latestInput.message_type === 'text') {\n    leadMessage = latestInput.message_text;\n} else {\n    // Media Message Logic\n    const caption = latestInput.message_caption ? `Restaurant's Caption: \"${latestInput.message_caption}\"` : \"User sent a media file with no caption.\";\n    const description = latestInput.message_text ? `\\n\\n[Explanation of the ${latestInput.message_type}]:\\n${latestInput.message_text}` : \"\";\n    \n    leadMessage = `${caption}${description}`;\n}\n\n// 3. PROCESS THE CHAT HISTORY THREAD\nconst processedMessages = rawMessages.map(item => {\n  const isFromMe = item.from_me === true;\n  const role = isFromMe ? 'Veronica' : 'Restaurant';\n  let text = item.text?.body || (item.caption ? item.caption : `[${item.type} file]`);\n  \n  return {\n    timestamp: item.timestamp,\n    formattedTime: formatTimestamp(item.timestamp),\n    role: role,\n    isFromMe: isFromMe,\n    message: text.substring(0, 1000)\n  };\n});\n\n// Sort chronological (Oldest to Newest)\nconst chronologicalMessages = [...processedMessages].sort((a, b) => a.timestamp - b.timestamp);\n\n// 4. CALCULATE RESPONSE TIME (Numeric)\nlet responseTimeMinutes = 0; // Default to 0 for the IF node\n\nconst lastMsgIndex = chronologicalMessages.length - 1;\n\n// Only calculate if there are at least 2 messages and the latest is from the Contact\nif (lastMsgIndex > 0) {\n  const lastMsg = chronologicalMessages[lastMsgIndex];\n  \n  if (!lastMsg.isFromMe) {\n    // Look backwards for the first message from \"Me\" (Veronica)\n    for (let i = lastMsgIndex - 1; i >= 0; i--) {\n      if (chronologicalMessages[i].isFromMe) {\n        const diffInSeconds = lastMsg.timestamp - chronologicalMessages[i].timestamp;\n        const diffInMinutes = diffInSeconds / 60;\n        \n        // Logic: less than 1 min = 1, otherwise Round Up\n        if (diffInMinutes <= 1) {\n          responseTimeMinutes = 1;\n        } else {\n          responseTimeMinutes = Math.ceil(diffInMinutes);\n        }\n        break; // Found the latest response pair, exit loop\n      }\n    }\n  }\n}\n\n// 5. FORMAT THREAD FOR DISPLAY\nconst conversationThread = chronologicalMessages.map(msg => {\n  return `[${msg.formattedTime}] ${msg.role}: ${msg.message}`;\n}).join('\\n\\n');\n\n// 6. RETURN RESULTS\nreturn {\n  json: {\n    leadMessage: leadMessage, \n    chatId: latestInput.chat_id,\n    conversationThreadFormatted: conversationThread,\n    responseTimeMinutes: responseTimeMinutes,\n    summary: {\n      totalMessages: chronologicalMessages.length,\n      latestRole: latestInput.message_type === 'text' ? 'Restaurant' : `Restaurant (${latestInput.message_type})`\n    }\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2272,
          -96
        ],
        "name": "Parse Chat History",
        "id": "748636e1-1cff-4063-a824-6bb31621301a"
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n\t\"text\": \"Hi, do you take reservation for 10-12 pax?\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          3424,
          928
        ],
        "id": "868f4d2d-a359-48ae-bec6-bed831eeea38",
        "name": "Structured Output Parser"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.body.event.type }}",
                      "rightValue": "messages",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "ab26fedb-0084-4da5-bc2b-6e68da36b114"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Message"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "f4448833-b7b8-43a9-9110-c9cc6ba8c044",
                      "leftValue": "={{ $json.body.event.type }}",
                      "rightValue": "statuses",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Status"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -512,
          16
        ],
        "id": "d1970b6a-1338-4cb8-ac9c-a684a5093c6c",
        "name": "Check event type"
      },
      {
        "parameters": {
          "jsCode": "// This node extracts image URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst imagesFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is image and has a link\n    if (msg.type === 'image' && msg.image && msg.image.link) {\n      imagesFound.push({\n        imageUrl: msg.image.link,\n        caption: msg.image.caption || \"\",\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// If no images were found, you might want to return an empty item \n// or a specific message to avoid errors in later nodes\nreturn imagesFound.length > 0 ? imagesFound : [{ imageUrl: null, status: \"no image found\" }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          736,
          -176
        ],
        "id": "ebcadf9b-f68f-42d8-bfe8-da9455d8c12e",
        "name": "Get image URL"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "df3cc619-934d-4d62-9bff-db91d69107e5",
                "leftValue": "={{ $json.body.conversation.messages[0].sender.type === 'agent_bot' }}",
                "rightValue": "contact",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -656,
          464
        ],
        "id": "c7094572-5e84-41ee-a305-13a4ff351e9b",
        "name": "Check if human or bot"
      },
      {
        "parameters": {
          "jsCode": "// This node extracts voice/audio URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst audioFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Whapi uses 'voice' for voice notes and 'audio' for uploaded files\n    const audioData = msg.voice || msg.audio;\n    \n    if ((msg.type === 'voice' || msg.type === 'audio') && audioData && audioData.link) {\n      audioFound.push({\n        audioUrl: audioData.link,\n        chatId: msg.chat_id,\n        sender: msg.from_name,\n        seconds: audioData.seconds || 0,\n        mime_type: audioData.mime_type\n      });\n    }\n  }\n}\n\n// If no audio was found, return a null object to prevent workflow crashes\nreturn audioFound.length > 0 ? audioFound : [{ audioUrl: null, status: \"no audio found\" }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          736,
          32
        ],
        "id": "a1460336-0758-44c6-986c-e5f5210a47b6",
        "name": "Get Voice URL"
      },
      {
        "parameters": {
          "resource": "audio",
          "modelId": {
            "__rl": true,
            "value": "models/gemini-3-flash-preview",
            "mode": "list",
            "cachedResultName": "models/gemini-3-flash-preview"
          },
          "audioUrls": "={{ $json.audioUrl }}",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.googleGemini",
        "typeVersion": 1.1,
        "position": [
          960,
          32
        ],
        "id": "fb55441c-3ccf-44b0-8b8e-e40218a055fe",
        "name": "Transcribe voice message",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "resource": "image",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "value": "models/gemini-2.0-flash",
            "mode": "list",
            "cachedResultName": "models/gemini-2.0-flash"
          },
          "text": "Here is an image sent by the user. Describe the image and transcribe any text visible in the image.",
          "imageUrls": "={{ $json.imageUrl }}",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.googleGemini",
        "typeVersion": 1.1,
        "position": [
          960,
          -176
        ],
        "id": "3eba2ee1-8f4d-440a-8786-be718e28e62c",
        "name": "Analyze image",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// This node extracts video URLs from the Whapi payload\nconst messages = $input.item.json.body.messages;\nconst videosFound = [];\n\nif (messages && Array.isArray(messages)) {\n  for (const msg of messages) {\n    // Check if the message type is video and has a link\n    if (msg.type === 'video' && msg.video && msg.video.link) {\n      videosFound.push({\n        videoUrl: msg.video.link,\n        caption: msg.video.caption || \"\",\n        seconds: msg.video.seconds || 0,\n        chatId: msg.chat_id,\n        sender: msg.from_name\n      });\n    }\n  }\n}\n\n// Return video data or a null object to keep the workflow from breaking\nreturn videosFound.length > 0 ? videosFound : [{ videoUrl: null, status: \"no video found\" }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          736,
          240
        ],
        "id": "24f4d553-89e1-485c-a599-48760fd88e13",
        "name": "Get video URL"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $json.content.parts[0].text }}"
              }
            ]
          },
          "options": {}
        },
        "id": "34181da2-61bb-401e-b6c5-22e2f49fae6c",
        "name": "Format image description",
        "type": "n8n-nodes-base.set",
        "position": [
          1216,
          -176
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "resource": "video",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "value": "models/gemini-3-flash-preview",
            "mode": "list",
            "cachedResultName": "models/gemini-3-flash-preview"
          },
          "text": "Here is an video sent by the user. Describe the video briefly and transcribe any voice/audio message in the video.",
          "videoUrls": "={{ $json.videoUrl }}",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.googleGemini",
        "typeVersion": 1.1,
        "position": [
          960,
          240
        ],
        "id": "8d73e4c0-840b-482c-aeb8-95f3692f1b0f",
        "name": "Analyze video",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $json.content.parts[0].text }}"
              }
            ]
          },
          "options": {}
        },
        "id": "60dc0d38-ff49-477e-996d-f9842990a96f",
        "name": "Format video description",
        "type": "n8n-nodes-base.set",
        "position": [
          1216,
          240
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $json.content.parts[0].text }}"
              }
            ]
          },
          "options": {}
        },
        "id": "0038d780-dd2a-4525-ace0-d577c1b6730f",
        "name": "Format voice transcription",
        "type": "n8n-nodes-base.set",
        "position": [
          1216,
          32
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2ec0e573-373b-4692-bfae-86b6d3b9aa9a",
                "name": "text",
                "type": "string",
                "value": "={{ $('Redirect Message Types').item.json.body.messages[0].text.body }}"
              }
            ]
          },
          "options": {}
        },
        "id": "b731c34c-572b-4d4c-97bd-332b787a6222",
        "name": "Format response",
        "type": "n8n-nodes-base.set",
        "position": [
          1344,
          -576
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"New prospect reply needs approval\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].type }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ JSON.stringify(($('Get User\\'s Message').item.json.message_text || '').length > 300 ? $('Get User\\'s Message').item.json.message_text.substring(0, 300) + '...' : ($('Get User\\'s Message').item.json.message_text || '')).slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Media caption:*\\n```{{ $('Get User\\'s Message').item.json.message_caption ? JSON.stringify($('Get User\\'s Message').item.json.message_caption).slice(1, -1) : 'NA' }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ JSON.stringify($json.output.text || '').slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"actions\",\n      \"block_id\": \"approval_actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \":white_check_mark: Approve & Send\",\n            \"emoji\": true\n          },\n          \"style\": \"primary\",\n          \"action_id\": \"approve\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \"‚úè Reject & Send manually\",\n            \"emoji\": true\n          },\n          \"style\": \"danger\",\n          \"action_id\": \"reject\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        }\n      ]\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          3936,
          720
        ],
        "id": "92a065a2-a86f-4be5-bb5e-8547e04914f3",
        "name": "Send to Slack for Approval",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"Unrecognized message type received\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":warning: Unrecognized Message Type\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n`{{ $('Redirect Message Types').item.json.body.messages[0].type }}`\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Status:* The AI Agent cannot process this file or message type automatically.\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Action Required:* Please check this conversation directly on WhatsApp to reply to the prospect.\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          736,
          656
        ],
        "id": "700da0fa-0a99-4004-8d46-66a0da18d94e",
        "name": "Notify in Slack",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "3fb404a2-ac30-43cb-8535-60b7b4cc78bb",
                "leftValue": "={{ $json.responseTimeMinutes }}",
                "rightValue": 30,
                "operator": {
                  "type": "number",
                  "operation": "gt"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          2480,
          -96
        ],
        "id": "d1e35512-2e94-4e00-9971-0185ea899d8b",
        "name": "Check if respond after 30 mins"
      },
      {
        "parameters": {
          "modelName": "models/gemini-3-flash-preview",
          "options": {}
        },
        "id": "6ef6aa02-9ecf-4c1d-a299-3c95c50d6e9c",
        "name": "Google Gemini Chat Model1",
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "position": [
          3152,
          -208
        ],
        "typeVersion": 1,
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n\t\"text\": \"Hi, do you take reservation for 10-12 pax?\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          3408,
          -208
        ],
        "id": "449f7720-f0e2-40c9-b2f2-f2cd5dbb93eb",
        "name": "Structured Output Parser1"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"New prospect reply needs approval\",\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \":bell: New Prospect Reply\",\n        \"emoji\": true\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Message type:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].type }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Prospect's Reply:*\\n```{{ JSON.stringify(($('Get User\\'s Message').item.json.message_text || '').length > 300 ? $('Get User\\'s Message').item.json.message_text.substring(0, 300) + '...' : ($('Get User\\'s Message').item.json.message_text || '')).slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Media caption:*\\n```{{ $('Get User\\'s Message').item.json.message_caption ? JSON.stringify($('Get User\\'s Message').item.json.message_caption).slice(1, -1) : 'NA' }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Agent Generated Response:*\\n```{{ JSON.stringify($json.output.text || '').slice(1, -1) }}```\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"actions\",\n      \"block_id\": \"approval_actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \":white_check_mark: Approve & Send\",\n            \"emoji\": true\n          },\n          \"style\": \"primary\",\n          \"action_id\": \"approve\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": {\n            \"type\": \"plain_text\",\n            \"text\": \"‚úè Reject & Send manually\",\n            \"emoji\": true\n          },\n          \"style\": \"danger\",\n          \"action_id\": \"reject\",\n          \"value\": \"{{ $('Redirect Message Types').item.json.body.messages[0].chat_id }}\"\n        }\n      ]\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          3920,
          -416
        ],
        "id": "46e98a1e-847a-4baa-8fd8-7646d4f7ef12",
        "name": "Send to Slack for Approval1",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=- Prospect's latest message: {{ $('Parse Chat History').item.json.leadMessage }}\n- Message type: {{ $('Receive Reply').item.json.body.messages[0].type }}\n- Chat history: {{ $('Parse Chat History').item.json.conversationThreadFormatted }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are Veronica, a tourist from Singapore who is visiting Australia and contacting the restaurant to make a reservation for 10 pax.\n\nYou've already sent this WhatsApp message to the restaurant and are waiting for their response.\n\"Hi, is this {restaurant name} restaurant? I'd like to make a reservation for 10 pax, is there anyway I can book this online?\"\n\nGuidelines:\n- Speak proper English, do not use Singapore slang.\n- Keep your response natural, casual, conversational, short and concise in 1-2 short sentenced\n- This is a conversation via WhatsApp text messages, so make it natural for text messages context.\n- Refer to the chat history to generate an appropriate response.\nScenarios & Instruction to reply\n- If they reply this message, it means that they've replied more than half an hour later, then just reply this \"Sorry, we decided to go ahead with another restaurant cos we couldn't find a way to book a table with you online. You should really consider getting an online reservation system üòÖ\"\n- If you already replied them with the message above from the chat history, then STOP replying them"
          }
        },
        "id": "09232325-b82f-4203-9d8d-77822a8564af",
        "name": "Response Agent #1",
        "type": "@n8n/n8n-nodes-langchain.agent",
        "position": [
          3216,
          -400
        ],
        "typeVersion": 1.6
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=- Prospect's latest message: {{ $('Parse Chat History').item.json.leadMessage }}\n- Message type: {{ $('Receive Reply').item.json.body.messages[0].type }}\n- Chat history: {{ $('Parse Chat History').item.json.conversationThreadFormatted }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are Veronica, a tourist from Singapore who is visiting Australia and contacting the restaurant to make a reservation for 10 pax.\n\nYou've already sent this WhatsApp message to the restaurant and are waiting for their response.\n\"Hi, is this {restaurant name} restaurant? I'd like to make a reservation for 10 pax, is there anyway I can book this online?\"\n\nGuidelines:\n- Speak proper English, do not use Singapore slang.\n- Keep your response natural, casual, conversational, short and concise in 1-2 short sentences\n- This is a conversation via WhatsApp text messages, so make it natural for text messages context.\n- Refer to the chat history to generate an appropriate response.\n\nScenarios & Instruction to reply\n- If the restaurant says they can take reservation, ask if they have a reservation link to book online because you need to coordinate some details with your friends.\n- If the restaurant asks why you need to reserve online, say that it's because I need to coordinate with your friends before you could make a reservation.\n- If the restaurant asks when is your booking date, say that you're not sure yet and still checking with your friends, then ask if they have a booking link\n- If the restaurant asks for other details of your reservation, answer according to your knowledge and if you don't know, come up with something generic\n- If the restaurant says the have online booking, you say \"Okay great, can you send me the link\" and stop replying from here onwards.\n- If restaurant says there is no online booking, you say \"Ok, let me check with my friends, I'll get back to you\" and stop replying from here onwards.\n- If you already said \"Okay great, can you send me the link\" or \"Ok, let me check with my friends, I'll get back to you\" from the chat history, then STOP replying them"
          }
        },
        "id": "5920b91c-e3f4-45bd-8a23-a6f33850bcd3",
        "name": "Response Agent #2",
        "type": "@n8n/n8n-nodes-langchain.agent",
        "position": [
          3232,
          736
        ],
        "typeVersion": 1.6
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -272,
          208
        ],
        "id": "d2b6b2e6-0a4f-4339-90ba-a77f4aeced24",
        "name": "Skip status"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -16,
          208
        ],
        "id": "14f8b96d-300f-4dce-bb14-f3c2d2df73a3",
        "name": "Skip my message"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          3920,
          -176
        ],
        "id": "7fdd977e-db00-40c1-b100-cef54bb2da8f",
        "name": "Skip agent 1's response"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          3952,
          960
        ],
        "id": "5d361054-229b-4361-8ad0-36cecb1d66af",
        "name": "Skip agent 2's response"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "462e3c61-8795-4b23-8431-8d3769d961a4",
                "leftValue": "={{ $json.output.text }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          3616,
          -400
        ],
        "id": "518b04af-f0e5-49a3-a37c-7af870989ad1",
        "name": "If agent 1 continues to respond"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "462e3c61-8795-4b23-8431-8d3769d961a4",
                "leftValue": "={{ $json.output.text }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          3648,
          736
        ],
        "id": "83bfdd63-8231-4972-a05e-cc06c2d6934f",
        "name": "If agent 2 continues to respond"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": false,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "78141ca4-f380-4d9a-908a-2f9db44e9c88",
                "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
                "rightValue": "([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))",
                "operator": {
                  "type": "string",
                  "operation": "regex"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {
            "ignoreCase": true
          }
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          2752,
          -416
        ],
        "id": "5a1c4c48-9d20-4a4f-bc8f-61b9e8ebfd38",
        "name": "Check for booking link"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": false,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "78141ca4-f380-4d9a-908a-2f9db44e9c88",
                "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
                "rightValue": "([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))",
                "operator": {
                  "type": "string",
                  "operation": "regex"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {
            "ignoreCase": true
          }
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          2752,
          352
        ],
        "id": "db0c5db7-97bd-4172-9683-7c5ebb41cfcd",
        "name": "Check for booking link_2"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Booking Link Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:calendar: New Booking Link Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Reservation Booking Link:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].link_preview.url }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Redirect Message Types').item.json.body.messages[0].link_preview?.body ? JSON.stringify($('Redirect Message Types').item.json.body.messages[0].link_preview.body).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          736,
          448
        ],
        "id": "fe622d85-393d-4b32-99e2-3876fae8415e",
        "name": "Send link to Slack",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Booking Link Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:calendar: New Booking Link Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Reservation Booking Link:*\\n{{ $json.extractedBookingUrl }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          3728,
          -688
        ],
        "id": "8b7f90ef-6c93-4bcc-94f1-dc81fe6353a3",
        "name": "Send booking link to Slack 2",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Booking Link Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:calendar: New Booking Link Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Reservation Booking Link:*\\n{{ $json.extractedBookingUrl }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          3760,
          464
        ],
        "id": "3f8602c9-e005-435f-a626-5327a3cb058c",
        "name": "Send booking link to Slack 3",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "leftValue": "={{ $json.output.classification }}",
                      "rightValue": "human",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "f620673b-58a0-4990-b57d-aeceafc007f7"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Human reply"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "ef99233a-2a44-4831-b14d-9a6928d5afce",
                      "leftValue": "={{ $json.output.classification }}",
                      "rightValue": "auto_bot",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "Auto reply"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          1104,
          -560
        ],
        "id": "8e58f025-1a57-457f-b236-b2d423ff9158",
        "name": "Switch"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          1344,
          -384
        ],
        "id": "a8033eb2-6f7d-4e5a-a192-944cb70db859",
        "name": "Skip auto reply"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
            "mode": "list",
            "cachedResultName": "AU OR Outreach - 2026",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1716060325,
            "mode": "list",
            "cachedResultName": "Target_List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Reservation Link": "={{ $('Redirect Message Types').item.json.body.messages[0].link_preview.url }}",
              "Number": "={{ $json.body.messages[0].from }}"
            },
            "matchingColumns": [
              "Number"
            ],
            "schema": [
              {
                "id": "Number",
                "displayName": "Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Name",
                "displayName": "Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "1st Msg",
                "displayName": "1st Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "2nd Msg",
                "displayName": "2nd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "3rd Msg",
                "displayName": "3rd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Queue Status",
                "displayName": "Message Queue Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Delivery Status",
                "displayName": "Message Delivery Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "First Response",
                "displayName": "First Response",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Sender",
                "displayName": "Sender",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Restaurant Name",
                "displayName": "Restaurant Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Batch Number",
                "displayName": "Batch Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Remarks",
                "displayName": "Remarks",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 1",
                "displayName": "Message 1",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 2",
                "displayName": "Message 2",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 3",
                "displayName": "Message 3",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Entry ID",
                "displayName": "Entry ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Place ID",
                "displayName": "Place ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Record ID",
                "displayName": "Record ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "record (attio)",
                "displayName": "record (attio)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Reservation Link",
                "displayName": "Reservation Link",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          944,
          448
        ],
        "id": "e4cbb2d9-bf52-4daa-93db-cd838f478a24",
        "name": "Add reservation link to Google Sheet",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H3k1lZEtuCVhMzHl",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
            "mode": "list",
            "cachedResultName": "AU OR Outreach - 2026",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1716060325,
            "mode": "list",
            "cachedResultName": "Target_List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
              "Reservation Link": "={{ $('Extract booking link1').item.json.extractedBookingUrl }}"
            },
            "matchingColumns": [
              "Number"
            ],
            "schema": [
              {
                "id": "Number",
                "displayName": "Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Name",
                "displayName": "Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "1st Msg",
                "displayName": "1st Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "2nd Msg",
                "displayName": "2nd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "3rd Msg",
                "displayName": "3rd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Queue Status",
                "displayName": "Message Queue Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Delivery Status",
                "displayName": "Message Delivery Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "First Response",
                "displayName": "First Response",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Sender",
                "displayName": "Sender",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Restaurant Name",
                "displayName": "Restaurant Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Batch Number",
                "displayName": "Batch Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Remarks",
                "displayName": "Remarks",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 1",
                "displayName": "Message 1",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 2",
                "displayName": "Message 2",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 3",
                "displayName": "Message 3",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Entry ID",
                "displayName": "Entry ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Place ID",
                "displayName": "Place ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Record ID",
                "displayName": "Record ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "record (attio)",
                "displayName": "record (attio)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Reservation Link",
                "displayName": "Reservation Link",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          3952,
          -688
        ],
        "id": "5e51507f-f611-4ddb-937e-f76e92dfa007",
        "name": "Add reservation link to Google Sheet_2",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H3k1lZEtuCVhMzHl",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Regex to capture domains/URLs even without http/https\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n  \n  const match = message.match(urlRegex);\n  \n  if (match) {\n    let extractedUrl = match[0];\n    \n    // Prepend https:// if the lead only provided the domain (e.g., barregio.com.au)\n    if (!extractedUrl.startsWith('http')) {\n      extractedUrl = 'https://' + extractedUrl;\n    }\n    \n    item.json.extractedBookingUrl = extractedUrl;\n  } else {\n    item.json.extractedBookingUrl = 'No URL found';\n  }\n\n  // Remove the conversationThreadFormatted field\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3536,
          464
        ],
        "id": "9757e4cb-9a2a-4098-b90f-c7bb5daaea85",
        "name": "Extract booking link"
      },
      {
        "parameters": {
          "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Regex to capture domains/URLs even without http/https\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n  \n  const match = message.match(urlRegex);\n  \n  if (match) {\n    let extractedUrl = match[0];\n    \n    // Prepend https:// if the lead only provided the domain (e.g., barregio.com.au)\n    if (!extractedUrl.startsWith('http')) {\n      extractedUrl = 'https://' + extractedUrl;\n    }\n    \n    item.json.extractedBookingUrl = extractedUrl;\n  } else {\n    item.json.extractedBookingUrl = 'No URL found';\n  }\n\n  // Remove the conversationThreadFormatted field\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3488,
          -688
        ],
        "id": "adfb34ec-fc52-493e-9bfa-ea6caa80cb3e",
        "name": "Extract booking link1"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
            "mode": "list",
            "cachedResultName": "AU OR Outreach - 2026",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1716060325,
            "mode": "list",
            "cachedResultName": "Target_List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Reservation Link": "={{ $('Extract booking link').item.json.extractedBookingUrl }}",
              "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
              "Trap Set": "NA"
            },
            "matchingColumns": [
              "Number"
            ],
            "schema": [
              {
                "id": "Number",
                "displayName": "Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Name",
                "displayName": "Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "1st Msg",
                "displayName": "1st Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "2nd Msg",
                "displayName": "2nd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "3rd Msg",
                "displayName": "3rd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Queue Status",
                "displayName": "Message Queue Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Delivery Status",
                "displayName": "Message Delivery Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "First Response",
                "displayName": "First Response",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Sender",
                "displayName": "Sender",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Restaurant Name",
                "displayName": "Restaurant Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Batch Number",
                "displayName": "Batch Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Remarks",
                "displayName": "Remarks",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 1",
                "displayName": "Message 1",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 2",
                "displayName": "Message 2",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 3",
                "displayName": "Message 3",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Entry ID",
                "displayName": "Entry ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Place ID",
                "displayName": "Place ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Record ID",
                "displayName": "Record ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "record (attio)",
                "displayName": "record (attio)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Reservation Link",
                "displayName": "Reservation Link",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Trap Set",
                "displayName": "Trap Set",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          3968,
          464
        ],
        "id": "fa778326-99a2-45f4-8da3-246a65bd895e",
        "name": "Add reservation link to Google Sheet_3",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H3k1lZEtuCVhMzHl",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Define specific regex for both types\n  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/i;\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n\n  const emailMatch = message.match(emailRegex);\n  const urlMatch = message.match(urlRegex);\n\n  // Logic: Check for email first to prevent overlap\n  if (emailMatch) {\n    item.json.extractedType = 'email';\n    item.json.extractedValue = emailMatch[0];\n  } else if (urlMatch) {\n    item.json.extractedType = 'url';\n    let url = urlMatch[0];\n    // Prepend https:// if it's a naked domain like barregio.com.au\n    item.json.extractedValue = url.startsWith('http') ? url : 'https://' + url;\n  } else {\n    item.json.extractedValue = 'No match found';\n  }\n\n  // Remove the conversationThreadFormatted field to keep output clean\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3536,
          240
        ],
        "id": "326ba0e4-485a-47e6-b3a7-4d3a6a1fa6cd",
        "name": "Extract email"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
            "mode": "list",
            "cachedResultName": "AU OR Outreach - 2026",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1716060325,
            "mode": "list",
            "cachedResultName": "Target_List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
              "Reservation Link": "Manual",
              "Trap Set": "NA",
              "Email": "={{ $json.extractedValue }}"
            },
            "matchingColumns": [
              "Number"
            ],
            "schema": [
              {
                "id": "Number",
                "displayName": "Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Name",
                "displayName": "Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "1st Msg",
                "displayName": "1st Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "2nd Msg",
                "displayName": "2nd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "3rd Msg",
                "displayName": "3rd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Queue Status",
                "displayName": "Message Queue Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Delivery Status",
                "displayName": "Message Delivery Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "First Response",
                "displayName": "First Response",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Sender",
                "displayName": "Sender",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Restaurant Name",
                "displayName": "Restaurant Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Batch Number",
                "displayName": "Batch Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Remarks",
                "displayName": "Remarks",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 1",
                "displayName": "Message 1",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 2",
                "displayName": "Message 2",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 3",
                "displayName": "Message 3",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Entry ID",
                "displayName": "Entry ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Place ID",
                "displayName": "Place ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Record ID",
                "displayName": "Record ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "record (attio)",
                "displayName": "record (attio)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Reservation Link",
                "displayName": "Reservation Link",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Trap Set",
                "displayName": "Trap Set",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Email",
                "displayName": "Email",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          3776,
          240
        ],
        "id": "82cb2c55-dce5-4526-955e-3e20bbca8913",
        "name": "Add email to Gsheet",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H3k1lZEtuCVhMzHl",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "for (const item of $input.all()) {\n  const message = $('Parse Chat History').first().json.leadMessage || \"\";\n  \n  // Define specific regex for both types\n  const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/i;\n  const urlRegex = /([-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*))/i;\n\n  const emailMatch = message.match(emailRegex);\n  const urlMatch = message.match(urlRegex);\n\n  // Logic: Check for email first to prevent overlap\n  if (emailMatch) {\n    item.json.extractedType = 'email';\n    item.json.extractedValue = emailMatch[0];\n  } else if (urlMatch) {\n    item.json.extractedType = 'url';\n    let url = urlMatch[0];\n    // Prepend https:// if it's a naked domain like barregio.com.au\n    item.json.extractedValue = url.startsWith('http') ? url : 'https://' + url;\n  } else {\n    item.json.extractedValue = 'No match found';\n  }\n\n  // Remove the conversationThreadFormatted field to keep output clean\n  delete item.json.conversationThreadFormatted;\n}\n\nreturn $input.all();"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3488,
          -896
        ],
        "id": "5e0f7a97-a5a2-4f80-8585-406c97159885",
        "name": "Extract email1"
      },
      {
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0",
            "mode": "list",
            "cachedResultName": "AU OR Outreach - 2026",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1716060325,
            "mode": "list",
            "cachedResultName": "Target_List",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ac5r_6CcArtudeUw7PPG6gzAinxgSNtq3YMz8wZVfV0/edit#gid=1716060325"
          },
          "columns": {
            "mappingMode": "defineBelow",
            "value": {
              "Number": "={{ $('Redirect Message Types').item.json.body.messages[0].from }}",
              "Reservation Link": "Manual",
              "Trap Set": "Done",
              "Email": "={{ $json.extractedValue }}"
            },
            "matchingColumns": [
              "Number"
            ],
            "schema": [
              {
                "id": "Number",
                "displayName": "Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "Name",
                "displayName": "Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "1st Msg",
                "displayName": "1st Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "2nd Msg",
                "displayName": "2nd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "3rd Msg",
                "displayName": "3rd Msg",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Queue Status",
                "displayName": "Message Queue Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message Delivery Status",
                "displayName": "Message Delivery Status",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "First Response",
                "displayName": "First Response",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Sender",
                "displayName": "Sender",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Restaurant Name",
                "displayName": "Restaurant Name",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Batch Number",
                "displayName": "Batch Number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Remarks",
                "displayName": "Remarks",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 1",
                "displayName": "Message 1",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 2",
                "displayName": "Message 2",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Message 3",
                "displayName": "Message 3",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Entry ID",
                "displayName": "Entry ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Place ID",
                "displayName": "Place ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Record ID",
                "displayName": "Record ID",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "record (attio)",
                "displayName": "record (attio)",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": true
              },
              {
                "id": "Reservation Link",
                "displayName": "Reservation Link",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Trap Set",
                "displayName": "Trap Set",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "Email",
                "displayName": "Email",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true
              },
              {
                "id": "row_number",
                "displayName": "row_number",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "number",
                "canBeUsedToMatch": true,
                "readOnly": true,
                "removed": true
              }
            ],
            "attemptToConvertTypes": false,
            "convertFieldsToString": false
          },
          "options": {}
        },
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          3824,
          -896
        ],
        "id": "e2e45e0d-26b7-437c-b5ff-ec1ebfc8545b",
        "name": "Add email to Gsheet1",
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H3k1lZEtuCVhMzHl",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "5c09f968-7624-4e62-813b-f197da23608f",
                "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
                "rightValue": "@",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          3232,
          336
        ],
        "id": "3677762b-2c3c-42b0-a95e-83f0a9ea91d8",
        "name": "Check for email"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 3
            },
            "conditions": [
              {
                "id": "5c09f968-7624-4e62-813b-f197da23608f",
                "leftValue": "={{ $('Parse Chat History').item.json.leadMessage }}",
                "rightValue": "@",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          3216,
          -816
        ],
        "id": "451c5edd-39d2-4ebf-8b7b-2cff512664d7",
        "name": "Check for email1"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Email address Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:e-mail: New Email Address Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Email Address:*\\n{{ $json.extractedValue }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          3824,
          -1104
        ],
        "id": "f581f915-8185-4f0e-989a-f3bdfc8d5a22",
        "name": "Send email to Slack ",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"channel\": \"C0A8PJQ9KU3\",\n  \"text\": \"üö® Email address Received!\",\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*:e-mail: New Email Address Received*\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"*Number:*\\n{{ $('Redirect Message Types').item.json.body.messages[0].from }}\"\n        }\n      ]\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Email Address:*\\n{{ $json.extractedValue }}\"\n      }\n    },\n    {\n      \"type\": \"divider\"\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Full Message:*\\n```{{ $('Parse Chat History').item.json.leadMessage ? JSON.stringify($('Parse Chat History').item.json.leadMessage).slice(1, -1) : 'NA' }}```\"\n      }\n    }\n  ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          3776,
          64
        ],
        "id": "ddb456dd-a568-438a-98dd-d025ea857227",
        "name": "Send email to Slack 1",
        "credentials": {
          "httpBearerAuth": {
            "id": "SWDEgTIP3Iofj3Ek",
            "name": "Slack's WhatsApp Agent 2"
          }
        }
      }
    ],
    "connections": {
      "Get User's Message": {
        "main": [
          [
            {
              "node": "Get Chat History",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Redirect Message Types": {
        "main": [
          [
            {
              "node": "Check if Bot Message",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get image URL",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get Voice URL",
              "type": "main",
              "index": 0
            }
          ],
          [],
          [
            {
              "node": "Get video URL",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Send link to Slack",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Notify in Slack",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "Response Agent #2",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Receive Reply": {
        "main": [
          [
            {
              "node": "Check event type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Topic Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Check if Bot Message",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Check if Prospect's Message": {
        "main": [
          [
            {
              "node": "Redirect Message Types",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Skip my message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini LLM": {
        "ai_languageModel": [
          [
            {
              "node": "Check if Bot Message",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Check if Bot Message": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Chat History": {
        "main": [
          [
            {
              "node": "Parse Chat History",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Chat History": {
        "main": [
          [
            {
              "node": "Check if respond after 30 mins",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Response Agent #2",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Check event type": {
        "main": [
          [
            {
              "node": "Check if Prospect's Message",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Skip status",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get image URL": {
        "main": [
          [
            {
              "node": "Analyze image",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check if human or bot": {
        "main": [
          [],
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Voice URL": {
        "main": [
          [
            {
              "node": "Transcribe voice message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Analyze image": {
        "main": [
          [
            {
              "node": "Format image description",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Transcribe voice message": {
        "main": [
          [
            {
              "node": "Format voice transcription",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format image description": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get video URL": {
        "main": [
          [
            {
              "node": "Analyze video",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Analyze video": {
        "main": [
          [
            {
              "node": "Format video description",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format video description": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format voice transcription": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Format response": {
        "main": [
          [
            {
              "node": "Get User's Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check if respond after 30 mins": {
        "main": [
          [
            {
              "node": "Check for booking link",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Check for booking link_2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Chat Model1": {
        "ai_languageModel": [
          [
            {
              "node": "Response Agent #1",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser1": {
        "ai_outputParser": [
          [
            {
              "node": "Response Agent #1",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Response Agent #1": {
        "main": [
          [
            {
              "node": "If agent 1 continues to respond",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Response Agent #2": {
        "main": [
          [
            {
              "node": "If agent 2 continues to respond",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If agent 1 continues to respond": {
        "main": [
          [
            {
              "node": "Send to Slack for Approval1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Skip agent 1's response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "If agent 2 continues to respond": {
        "main": [
          [
            {
              "node": "Send to Slack for Approval",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Skip agent 2's response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Skip agent 1's response": {
        "main": [
          []
        ]
      },
      "Check for booking link": {
        "main": [
          [
            {
              "node": "Check for email1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Response Agent #1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check for booking link_2": {
        "main": [
          [
            {
              "node": "Check for email",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Response Agent #2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Format response",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Skip auto reply",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send link to Slack": {
        "main": [
          [
            {
              "node": "Add reservation link to Google Sheet",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send booking link to Slack 2": {
        "main": [
          [
            {
              "node": "Add reservation link to Google Sheet_2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract booking link": {
        "main": [
          [
            {
              "node": "Send booking link to Slack 3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send booking link to Slack 3": {
        "main": [
          [
            {
              "node": "Add reservation link to Google Sheet_3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract booking link1": {
        "main": [
          [
            {
              "node": "Send booking link to Slack 2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract email": {
        "main": [
          [
            {
              "node": "Add email to Gsheet",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send email to Slack 1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract email1": {
        "main": [
          [
            {
              "node": "Add email to Gsheet1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send email to Slack ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check for email": {
        "main": [
          [
            {
              "node": "Extract email",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Extract booking link",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check for email1": {
        "main": [
          [
            {
              "node": "Extract email1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Extract booking link1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Oddle Engineer",
    "name": "Version ffc7ed94",
    "description": "",
    "autosaved": false
  },
  "tags": []
}