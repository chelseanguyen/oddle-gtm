{
  "updatedAt": "2026-01-16T07:48:34.841Z",
  "createdAt": "2026-01-02T06:07:57.708Z",
  "id": "Q3ayZFswJ7nIu0we",
  "name": "[Email] SDR Agent - Sophie",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "event": "emailsReplied",
        "options": {
          "campaignId": "cam_peDaoGPEGHR28WExF"
        }
      },
      "type": "n8n-nodes-base.lemlistTrigger",
      "typeVersion": 1,
      "position": [
        -2192,
        -416
      ],
      "name": "Reply Received",
      "webhookId": "lemlist-reply-webhook",
      "id": "721e1fd9-103d-4c58-ad68-92c218c25582",
      "credentials": {
        "lemlistApi": {
          "id": "6dgMHleAsx5bfyF9",
          "name": "Lemlist account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.lemlist.com/api/inbox/{{ $('Reply Received').item.json.contactId }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "lemlistApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -1760,
        -416
      ],
      "name": "Get Conversation History",
      "id": "800d3708-60a6-46a9-ac82-1b03a0e26955",
      "credentials": {
        "lemlistApi": {
          "id": "6dgMHleAsx5bfyF9",
          "name": "Lemlist account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -688,
        -240
      ],
      "name": "Google Gemini Flash",
      "id": "2835fccd-8d1a-4b00-b027-7478d0fe46da",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse and format Lemlist conversation history for AI agent\n\n// Helper function to strip HTML tags and decode HTML entities\nfunction stripHtml(html) {\n  if (!html) return '';\n  \n  // Remove HTML tags\n  let text = html.replace(/<[^>]*>/g, ' ');\n  \n  // Decode common HTML entities\n  text = text\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/&#x27;/g, \"'\")\n    .replace(/&apos;/g, \"'\")\n    .replace(/&#39;s/g, \"'s\");\n  \n  // Clean up extra whitespace\n  text = text.replace(/\\s+/g, ' ').trim();\n  \n  return text;\n}\n\n// Helper function to format timestamp\nfunction formatTimestamp(isoDate) {\n  const date = new Date(isoDate);\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const hours = String(date.getHours()).padStart(2, '0');\n  const minutes = String(date.getMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hours}:${minutes}`;\n}\n\n// Get the conversation data from the input\nconst inputData = $input.all();\nlet rawMessages = [];\n\nif (Array.isArray(inputData) && inputData.length > 0) {\n  const firstItem = inputData[0].json;\n  if (firstItem?.data && Array.isArray(firstItem.data)) {\n    rawMessages = firstItem.data;\n  } else if (Array.isArray(firstItem)) {\n    rawMessages = firstItem;\n  }\n}\n\n// 1. EXTRACT LEAD-SPECIFIC DATA\n// Find the latest reply from the prospect\nconst latestLeadReply = rawMessages.find(msg => msg.type === 'emailsReplied');\n// Also find any message that contains the leadEmail (could be a sent or received email)\nconst anyMessageWithEmail = rawMessages.find(msg => msg.leadEmail);\n\nlet leadMessage = '';\nlet leadEmail = anyMessageWithEmail ? anyMessageWithEmail.leadEmail : null;\nlet companyName = null;\n\nif (latestLeadReply) {\n  // Clean lead message and strip out historical \"On... wrote:\" quotes to help AI focus\n  if (latestLeadReply.message) {\n    let cleaned = stripHtml(latestLeadReply.message);\n    leadMessage = cleaned.split(/On\\s.*wrote:/i)[0]\n                         .split(/From:/i)[0]\n                         .split(/---/)[0]\n                         .trim()\n                         .substring(0, 1000);\n  }\n}\n\n// Extract Company Name from leadEmail domain if possible\nif (leadEmail && leadEmail.includes('@')) {\n  const domain = leadEmail.split('@')[1].split('.')[0];\n  // Simple logic to capitalize the first letter of the domain\n  companyName = domain.charAt(0).toUpperCase() + domain.slice(1);\n}\n\n// 2. PROCESS ALL MESSAGES FOR THE THREAD\nconst processedMessages = rawMessages.map(item => {\n  const isProspect = item.type === 'emailsReplied';\n  const role = isProspect ? 'Prospect' : 'SDR';\n  const senderName = isProspect \n    ? (item.fromEmail ? item.fromEmail.split('@')[0] : 'Prospect') \n    : (item.sendUserName || 'SDR');\n  \n  return {\n    timestamp: item.createdAt,\n    formattedTime: formatTimestamp(item.createdAt),\n    role: role,\n    sender: senderName,\n    message: stripHtml(item.message).substring(0, 500),\n    type: item.type,\n    subject: item.subject || ''\n  };\n});\n\n// Sort messages chronologically (oldest first)\nconst chronologicalMessages = [...processedMessages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));\n\n// 3. FORMAT CONVERSATION THREAD\nconst conversationThread = chronologicalMessages.map((msg, index) => {\n  const isLatest = index === chronologicalMessages.length - 1;\n  const prefix = isLatest ? '[LATEST] ' : '';\n  return `${prefix}[${msg.formattedTime}] ${msg.role} (${msg.sender}): ${msg.message}`;\n}).join('\\n\\n');\n\n// 4. CREATE STRUCTURED OBJECT\nconst structuredConversation = {\n  totalMessages: chronologicalMessages.length,\n  messages: chronologicalMessages,\n  summary: {\n    prospectMessageCount: chronologicalMessages.filter(m => m.role === 'Prospect').length,\n    sdrMessageCount: chronologicalMessages.filter(m => m.role === 'SDR').length,\n    latestRole: chronologicalMessages[chronologicalMessages.length - 1]?.role || 'Unknown'\n  }\n};\n\nreturn {\n  json: {\n    leadMessage: leadMessage,\n    leadEmail: leadEmail,\n    companyName: companyName,\n    parsedConversation: structuredConversation,\n    conversationThreadFormatted: conversationThread,\n    contactId: rawMessages[0]?.contactId || null,\n    subject: rawMessages[0]?.subject || ''\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        -416
      ],
      "name": "Parse Conversation History",
      "id": "6e63d921-c080-4600-82f0-d7affd788c3b"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "slack_channel",
              "name": "slackChannelId",
              "value": "C0A3N12LT5Z",
              "type": "string"
            },
            {
              "id": "webhook_path",
              "name": "webhookPath",
              "value": "slack-reply-approval",
              "type": "string"
            },
            {
              "id": "lemlist_base_url",
              "name": "lemlistBaseUrl",
              "value": "https://app.lemlist.com",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -1984,
        -416
      ],
      "name": "Workflow Configuration",
      "id": "5cf1faec-c2f6-4381-b2f6-4c4b57aa4dd2"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"content\": \"<html><body><p>Hi Chelsea,</p><p>Thanks for being upfront about that. I completely understand, if your current setup is working well for Chelsea's Bakery, there's no reason to change things just for the sake of it.</p><p>Just so I can better understand for the future, is there any specific feature or integration your current system is missing that would make a difference for your operations?</p></body></html>\"\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -432,
        -240
      ],
      "id": "638028d6-3c8b-43da-ad53-77335dd9c751",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"channel\": \"{{ $('Workflow Configuration').item.json.slackChannelId }}\",\n    \"text\": \"New prospect reply needs approval\",\n    \"blocks\": [\n        {\n            \"type\": \"header\",\n            \"text\": {\n                \"type\": \"plain_text\",\n                \"text\": \":bell: New Prospect Reply\",\n                \"emoji\": true\n            }\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"section\",\n            \"fields\": [\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Company:*\\n{{ $('Reply Received').item.json.companyName }}\"\n                },\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Lead Email:*\\n{{ $('Reply Received').item.json.leadEmail }}\"\n                },\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Reply-from Email:*\\n{{ $('Reply Received').item.json.fromEmail }}\"\n                },\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Outreach Campaign:*\\n{{ $('Reply Received').item.json.campaignName }}\"\n                }\n            ]\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"section\",\n            \"text\": {\n                \"type\": \"mrkdwn\",\n                 \"text\": \"*Prospect's Reply:*\\n```{{ $('Reply Received').item.json.text && $('Reply Received').item.json.text.length > 300 ? $('Reply Received').item.json.text.replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"').substring(0, 300) + '...\\\\n\\\\n[Message truncated - view full reply in Lemlist]' : ($('Reply Received').item.json.text || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n            }\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"section\",\n            \"text\": {\n                \"type\": \"mrkdwn\",\n                \"text\": \"*Agent Generated Response:*\\n```{{ ($json.output.content || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n            }\n        },\n        {\n            \"type\": \"context\",\n            \"elements\": [\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Reply Received').item.json.metaData.teamId }}/inbox/list/myConversations/contacts/{{ $('Reply Received').item.json.contactId }}|View full conversation in Lemlist>\"\n                }\n            ]\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"actions\",\n            \"block_id\": \"approval_actions\",\n            \"elements\": [\n                {\n                    \"type\": \"button\",\n                    \"text\": {\n                        \"type\": \"plain_text\",\n                        \"text\": \":white_check_mark: Approve & Send\",\n                        \"emoji\": true\n                    },\n                    \"style\": \"primary\",\n                    \"action_id\": \"approve\",\n                    \"value\": \"{{ $('Reply Received').item.json.messageId }}\"\n                },\n                {\n                    \"type\": \"button\",\n                    \"text\": {\n                        \"type\": \"plain_text\",\n                        \"text\": \"✏ Reject & Edit\",\n                        \"emoji\": true\n                    },\n                    \"style\": \"danger\",\n                    \"action_id\": \"reject\",\n                    \"url\": \"https://app.lemlist.com/teams/{{ $('Reply Received').item.json.metaData.teamId }}/inbox/list/myConversations/contacts/{{ $('Reply Received').item.json.contactId }}\"\n                }\n            ]\n        }\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -224,
        -416
      ],
      "id": "5aa9e056-a669-480e-9325-edb50a3e98f6",
      "name": "Send to Slack for Approval",
      "credentials": {
        "httpBearerAuth": {
          "id": "A9y0ZdmG00hI8udd",
          "name": "Slack's Email SDR Agent"
        }
      }
    },
    {
      "parameters": {
        "content": "### Additional tasks for Email Agent\n- Create Lead Profile, send to Attio & Slack\n- Hand off to AE: Send email to prospect & introduce AE with LP\n- Update Attio (CRM agent)",
        "height": 128,
        "width": 496,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -608,
        -576
      ],
      "typeVersion": 1,
      "id": "90f770b5-7c9d-4db6-8216-cb5bb4923590",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "Additional steps before receiving reply from Lemlist. Agent processes:\n- Lead's attributes & scoring data\n- Additional research on the lead if needed\n- Oddle's internal data\n\nThen propose a personalized outreach email\nGet human to approve\nSend to lead via Lemlist",
        "height": 208,
        "width": 384
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2672,
        -496
      ],
      "typeVersion": 1,
      "id": "36061de8-27eb-4ddf-b7e4-f9e3aad0d37c",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Workflow 1: Handling prospect's reply\n\n",
        "height": 100,
        "width": 640
      },
      "id": "a89cca53-ace2-435f-b80d-7f36f1fd4565",
      "name": "Sticky Note15",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2208,
        -752
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### Scenarios:\n- give us a number\n- request to send email to another email address instead",
        "height": 128,
        "width": 304
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2208,
        -224
      ],
      "typeVersion": 1,
      "id": "6648e4dc-c5f2-4311-9985-a72f7f2afc3c",
      "name": "Sticky Note19"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        -672,
        96
      ],
      "id": "672c90e6-1154-4932-9e38-78de9d165f54",
      "name": "Embeddings Google Gemini",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Use this tool to find similar past prospect emails and our approved responses (found in metadata.response_sent) to help draft new replies",
        "tableName": {
          "__rl": true,
          "value": "outbound_responses",
          "mode": "list",
          "cachedResultName": "outbound_responses"
        },
        "topK": 5,
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "topic",
                "value": "={{ $json.output.topic }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        -672,
        -64
      ],
      "id": "c9d82a8b-a0c5-4cba-9018-028c2313ca95",
      "name": "Past Email Knowledge Base",
      "credentials": {
        "supabaseApi": {
          "id": "aJzMx5t2Q4kcZ8EL",
          "name": "Supabase Account"
        }
      }
    },
    {
      "parameters": {
        "content": "### Additional materials required\n- Appt booking link to add to agent's prompt",
        "height": 128,
        "width": 496,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -608,
        -736
      ],
      "typeVersion": 1,
      "id": "6167b1c6-50e4-4057-9f1f-5b15296bf5b7",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "### To add: Manager Agent\n1) Look at conversation history\n2) Identify what needs to be done from the latest conversation\n- Generate a response -> Email agent\n- Create a Lead Profile -> LP agent\n- Update Attio -> CRM agent (not sure about this)",
        "height": 192,
        "width": 384,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1424,
        -656
      ],
      "typeVersion": 1,
      "id": "f37b9d75-cabf-4542-a5d1-18509810338c",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=- Email from: {{ $('Parse Conversation History').item.json.leadEmail }}\n- Company: {{ $('Parse Conversation History').item.json.companyName }}\n- Subject: {{ $('Parse Conversation History').item.json.subject }}\n- Lead's's latest reply: {{ $('Parse Conversation History').item.json.leadMessage }}\n- Topic: {{ $json.output.topic }}\n- Conversation History: {{ $('Parse Conversation History').item.json.conversationThreadFormatted }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are an AI SDR (Sales Development Representative) agent helping to qualify leads.\n\nYour goal is to engage with prospects and determine if they meet the SQL (Sales Qualified Lead) criteria through natural conversation, draft a response to the lead's email (lead message) categorized by topic.\n\n**Your responsibilities:**\n1. Analyze the prospect's reply and conversation context\n2. Ask relevant qualifying questions based on SQL criteria\n3. Handle different scenarios:\n   - Interested: Move conversation forward, ask qualifying questions\n   - Not interested: Acknowledge gracefully, ask if timing might be better later\n   - Objections: Address concerns, provide value proposition\n   - Questions: Answer clearly and helpfully\n   - Out of office: Acknowledge and suggest follow-up timeline\n\n**SQL Qualification Criteria to assess:**\n- Need/pain points\n- Decision-making authority\n- Timeline for implementation\n\n**Instructions**\n1. Use the 'Past Email Knowledge Base' tool to retrieve 3-5 successful historical interactions related to the topic provided in the user's request.\n2. Analyze the retrieved examples:\n   - 'content': This is what a previous prospect said.\n   - 'metadata.response_sent': This is the specific, approved response we sent to that prospect.\n3. Use these as 'few-shot' examples to understand our approved tone, formatting, and key talking points for this specific category.\n4. Draft a new response to the current prospect's 'lead_message'.\n\n**Guidelines:**\n- Keep responses professional, friendly, concise, and conversational\n- Ask one question at a time\n- Personalize based on their company and previous messages\n- Be helpful and consultative, not pushy\n- If they're clearly not interested, respect that\n- **Learn from feedback:** When humans reject your responses and send their own, those examples are stored in memory. Pay attention to the conversation patterns and tone that get approved vs rejected.\n\n**When responding:**\n- Provide relevant links when helpful\n- If you don't know something, offer to connect them with our team\n- Be aware that the user's message might contain a quote or reply from the previous message.\n\n**Important:** This workflow includes a feedback loop. When your responses are rejected, the actual message sent by the human is captured and stored. Over time, you'll have access to examples of:\n- What you suggested (rejected)\n- What the human actually sent (approved)\nUse these patterns to continuously improve your responses.\n\nGenerate a response that will be sent to the prospect after human approval."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -608,
        -416
      ],
      "name": "Email Agent",
      "id": "d6271e73-662a-4975-a649-cdf9e5e90827",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Lead's message: {{ $json.leadMessage }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are an AI assistant that categorizes prospect messages into topics.\n\nAnalyze the lead's message and categorize it into ONE of the following topics:\n\n**Valid Topics:**\n- pricing: Questions about cost, pricing plans, discounts, payment terms\n- product_feature: Questions about specific features, functionality, capabilities\n- competitor_comparison: Comparisons with competitors, asking why choose us\n- objection: Concerns, doubts, hesitations, or pushback\n- interested: Expressing interest, wanting to learn more, positive signals\n- not_interested: Clearly not interested, politely declining, no need\n- timing: Questions about implementation timeline, when to start, availability\n- technical: Technical questions, integrations, API, security, compliance\n- scheduling: Requesting a demo, meeting, call, or follow-up\n- general_inquiry: General questions that don't fit other categories\n- auto_reply: Auto-replies, bot replies, out of office messages\n\n**Instructions:**\n1. Read the prospect's message carefully\n2. Identify the main intent or topic\n3. Return ONLY the topic keyword (e.g., \"pricing\", \"product_feature\")\n4. Use lowercase and underscores for multi-word topics\n5. Choose the MOST relevant single topic\n\n**Output Format:**\nReturn a JSON object with the topic:\n{\n  \"topic\": \"<topic_keyword>\"\n}\n\n**Examples:**\nMessage: \"How much does this cost?\"\nOutput: {\"topic\": \"pricing\"}\n\nMessage: \"Does it integrate with POS?\"\nOutput: {\"topic\": \"technical\"}\n\nMessage: \"Not interested right now, thanks.\"\nOutput: {\"topic\": \"not_interested\"}\n\nMessage: \"Can you tell me more about the reporting features?\"\nOutput: {\"topic\": \"product_feature\"}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        -1088,
        -416
      ],
      "name": "Categorize Lead Message Topic",
      "id": "6235c31b-6ef4-4416-8922-95dddaf0f359"
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1152,
        -208
      ],
      "name": "Google Gemini Chat",
      "id": "5a3d304b-d490-4af5-ab78-ff01872c628f",
      "credentials": {
        "googlePalmApi": {
          "id": "RYsSfOkTTr5PB58p",
          "name": "Oddle's Google Gemini(PaLM) API account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"topic\": \"pricing\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -864,
        -208
      ],
      "name": "Topic Output Parser",
      "id": "eb148603-6507-456a-824c-f574e121268e"
    }
  ],
  "connections": {
    "Reply Received": {
      "main": [
        [
          {
            "node": "Workflow Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Conversation History": {
      "main": [
        [
          {
            "node": "Parse Conversation History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Flash": {
      "ai_languageModel": [
        [
          {
            "node": "Email Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Conversation History": {
      "main": [
        [
          {
            "node": "Categorize Lead Message Topic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Workflow Configuration": {
      "main": [
        [
          {
            "node": "Get Conversation History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Email Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Send to Slack for Approval": {
      "main": [
        []
      ]
    },
    "Embeddings Google Gemini": {
      "ai_embedding": [
        [
          {
            "node": "Past Email Knowledge Base",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Past Email Knowledge Base": {
      "ai_tool": [
        [
          {
            "node": "Email Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Email Agent": {
      "main": [
        [
          {
            "node": "Send to Slack for Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Categorize Lead Message Topic": {
      "main": [
        [
          {
            "node": "Email Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat": {
      "ai_languageModel": [
        [
          {
            "node": "Categorize Lead Message Topic",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Topic Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Categorize Lead Message Topic",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "timeSavedPerExecution": 60
  },
  "staticData": {
    "node:Reply Received": {
      "webhookId": "hoo_bRmfHmR9yD57vosaf"
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Send to Slack for Approval": [
      {
        "json": {
          "ok": true,
          "channel": "C0A3N12LT5Z",
          "ts": "1768208798.238949",
          "message": {
            "user": "U0A484RHCNR",
            "type": "message",
            "ts": "1768208798.238949",
            "bot_id": "B0A4BHC4802",
            "app_id": "A0A55SZF3EU",
            "text": "New prospect reply needs approval",
            "team": "T030ZCV78",
            "bot_profile": {
              "id": "B0A4BHC4802",
              "app_id": "A0A55SZF3EU",
              "user_id": "U0A484RHCNR",
              "name": "SDR Agent",
              "icons": {
                "image_36": "https://a.slack-edge.com/80588/img/plugins/app/bot_36.png",
                "image_48": "https://a.slack-edge.com/80588/img/plugins/app/bot_48.png",
                "image_72": "https://a.slack-edge.com/80588/img/plugins/app/service_72.png"
              },
              "deleted": false,
              "updated": 1766040647,
              "team_id": "T030ZCV78"
            },
            "blocks": [
              {
                "type": "header",
                "block_id": "HxiTh",
                "text": {
                  "type": "plain_text",
                  "text": ":bell: New Prospect Reply",
                  "emoji": true
                }
              },
              {
                "type": "divider",
                "block_id": "YHtGn"
              },
              {
                "type": "section",
                "block_id": "7iKG/",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Company:*\nChelsea's Bakery",
                    "verbatim": false
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Lead Email:*\n<mailto:chelsea@oddle.me|chelsea@oddle.me>",
                    "verbatim": false
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Reply-from Email:*\n<mailto:chelsea@oddle.me|chelsea@oddle.me>",
                    "verbatim": false
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Outreach Campaign:*\nChelsea's Test Campaign",
                    "verbatim": false
                  }
                ]
              },
              {
                "type": "divider",
                "block_id": "wKYdJ"
              },
              {
                "type": "section",
                "block_id": "KgvbQ",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Prospect's Reply:*\n```Hi Chloe,\n\nThank you for your detailed explanation and for offering to clarify the\npricing after the free 1-year trial. I still don't see a strong point in\nswitch over from my current reservation system yet.\n\nRegards,\nChelsea\n\nOn Fri, 2 Jan 2026 at 14:51, Chelsea Nguyen &lt;chelsea@oddle.me...\n\n[Message truncated - view full reply in Lemlist]```",
                  "verbatim": false
                }
              },
              {
                "type": "divider",
                "block_id": "9q9pZ"
              },
              {
                "type": "section",
                "block_id": "XGfsm",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Agent Generated Response:*\n```Hi Chelsea,\n\nAppreciate the transparency! It makes total sense to stick with what’s working for Chelsea's Bakery right now.\n\nUsually, when restaurants decide to explore Oddle Reserve, it's because they're looking to eliminate per-cover fees or want better ownership of their guest data for marketing. If those aren't current pain points for you, I certainly wouldn't want to disrupt your operations.\n\nJust so I can be respectful of your time, do you have a specific time of year when you typically review your vendor contracts? I'd be happy to check back in then to see if your needs have evolved.```",
                  "verbatim": false
                }
              },
              {
                "type": "context",
                "block_id": "6sP0F",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": ":e-mail: <https://app.lemlist.com/teams/tea_gYwPePZxuhFb6QraW/inbox/list/myConversations/contacts/ctc_GGiXv4DJjRS6GHRKw|View full conversation in Lemlist>",
                    "verbatim": false
                  }
                ]
              },
              {
                "type": "divider",
                "block_id": "K9/db"
              },
              {
                "type": "actions",
                "block_id": "approval_actions",
                "elements": [
                  {
                    "type": "button",
                    "action_id": "approve",
                    "text": {
                      "type": "plain_text",
                      "text": ":white_check_mark: Approve &amp; Send",
                      "emoji": true
                    },
                    "style": "primary",
                    "value": "<CAFjBc67=qSvL1Yna0HHoyVMdy_-wrXv-1jdW7N_CO8YAep95DA@mail.gmail.com>"
                  },
                  {
                    "type": "button",
                    "action_id": "reject",
                    "text": {
                      "type": "plain_text",
                      "text": ":pencil2: Reject &amp; Edit",
                      "emoji": true
                    },
                    "style": "danger",
                    "url": "https://app.lemlist.com/teams/tea_gYwPePZxuhFb6QraW/inbox/list/myConversations/contacts/ctc_GGiXv4DJjRS6GHRKw"
                  }
                ]
              }
            ]
          },
          "warning": "missing_charset",
          "response_metadata": {
            "warnings": [
              "missing_charset"
            ]
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Email Agent": [
      {
        "json": {
          "output": {
            "content": "Hi Chelsea,\n\nAppreciate the transparency! It makes total sense to stick with what’s working for Chelsea's Bakery right now.\n\nUsually, when restaurants decide to explore Oddle Reserve, it's because they're looking to eliminate per-cover fees or want better ownership of their guest data for marketing. If those aren't current pain points for you, I certainly wouldn't want to disrupt your operations.\n\nJust so I can be respectful of your time, do you have a specific time of year when you typically review your vendor contracts? I'd be happy to check back in then to see if your needs have evolved."
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Reply Received": [
      {
        "json": {
          "_id": "act_aDLvFCYmR9sDqbPSg",
          "type": "emailsReplied",
          "emailId": "eml_bPskWZKB42Xau25Gn",
          "messageId": "<CAFjBc65kNs18e5SSt5YwX8smTNWT41qFT1b7jD9Ab_8_HpnWiQ@mail.gmail.com>",
          "createdBy": "usr_gYdTGt9D9RHqcwssi",
          "createdAt": "2026-01-15T02:51:52.000Z",
          "fromEmail": "chelsea@oddle.me",
          "isFirst": true,
          "stopped": true,
          "subject": "Re: Test - Oddle Reserve",
          "messagePreview": "Hi Chloei,",
          "bot": false,
          "teamId": "tea_gYwPePZxuhFb6QraW",
          "leadId": "lea_XzitMMZiGdJQLrBrr",
          "campaignId": "cam_peDaoGPEGHR28WExF",
          "sequenceId": "seq_ynGxRvredfzuGunCx",
          "sequenceStep": 0,
          "emailTemplateId": "etp_ksZ5EMTXncLiysr3t",
          "sendUserId": "usr_gYdTGt9D9RHqcwssi",
          "totalSequenceStep": 0,
          "name": "Chelsea's Test Campaign",
          "sendUserName": "Chloei Marithe Garcia",
          "sendUserEmail": "chloei.garcia_m@oddle.me",
          "sendUserMailboxId": "usm_hjsnvtva7qbPiaedC",
          "sendUserMailboxProviderId": "chloei.garcia_m@oddle.me",
          "leadFirstName": "Chelsea",
          "leadLastName": "Nguyen",
          "leadEmail": "chelsea@oddle.me",
          "leadCompanyName": "Chelsea Coffee Roaster",
          "contactId": "ctc_GGiXv4DJjRS6GHRKw",
          "relatedSentAt": "2026-01-15T02:42:39.294Z",
          "metaData": {
            "teamId": "tea_gYwPePZxuhFb6QraW",
            "campaignId": "cam_peDaoGPEGHR28WExF",
            "leadId": "lea_XzitMMZiGdJQLrBrr",
            "type": "emailsReplied",
            "createdBy": "usr_gYdTGt9D9RHqcwssi",
            "s3ready": false,
            "taskId": "tsk_4iBb2gJWKiF8C8unT"
          },
          "campaignName": "Chelsea's Test Campaign",
          "html": "<div dir=\"ltr\">Hi Chloei,<div><br></div><div>After 1 year free, how is the pricing like?</div></div><br><div class=\"gmail_quote gmail_quote_container\"><div dir=\"ltr\" class=\"gmail_attr\">On Thu, 15 Jan 2026 at 10:42, Chloei Garcia &lt;<a href=\"mailto:chloei.garcia_m@oddle.me\">chloei.garcia_m@oddle.me</a>&gt; wrote:<br></div><blockquote class=\"gmail_quote\" style=\"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex\"><div style=\"min-width:360px\"></div><div dir=\"ltr\"><div dir=\"ltr\">\n    <div><p id=\"m_3463525707039213200isPasted\" style=\"margin:0px;box-sizing:border-box\">Hi Chelsea Coffee Roaster , </p><p style=\"margin:0px;box-sizing:border-box\"><br style=\"box-sizing:border-box\"></p><p style=\"margin:0px;box-sizing:border-box\">This is Chloei Marithe from Oddle.</p><p style=\"margin:0px;box-sizing:border-box\"><br style=\"box-sizing:border-box\"></p><p style=\"margin:0px;box-sizing:border-box\">We work with hundreds of restaurants across <strong style=\"font-weight:700;box-sizing:border-box\">Singapore, Malaysia, Taiwan, and Hong Kong, </strong> helping them grow through tools like <strong style=\"font-weight:700;box-sizing:border-box\">reservations, delivery, loyalty, and email marketing</strong>.</p><p style=\"margin:0px;box-sizing:border-box\"><br style=\"box-sizing:border-box\"></p><p style=\"margin:0px;box-sizing:border-box\">We’re now expanding into Australia, and we’re inviting a select group of restaurants to try <strong style=\"font-weight:700;box-sizing:border-box\">Oddle Reserve free for a year - our fuss free &amp; comprehensive system</strong> that helps get more bookings without the monthly fees.</p><p style=\"margin:0px;box-sizing:border-box\"><br style=\"box-sizing:border-box\"></p><p style=\"margin:0px;box-sizing:border-box\">You can take a look at our reservation system <a style=\"color:rgb(51,138,241);text-decoration:none;background-color:transparent;box-sizing:border-box;font-weight:500\" rel=\"noopener noreferrer\" href=\"https://b2btrack.oddle.me/api/t/c/usr_tN2v4CzXRtSkvwSkg/tsk_4iBb2gJWKiF8C8unT/enc_U2FsdGVkX1_E_HaJIk_yP_4M45lw5slC27FxejSkdb5diPG_yfYC-KNvn_Zw8B_7YTYqnh2ol4gvK-WuF2XkMk0gJ39JGxS82Yfgu_GNMfPHw0Z54YQNQaNGkteTpXq_NiVvY8fjr4zIha6CkR50CekNGwdH8J4gCGc69Bq191ciiq0tTCPS_RL3yX-1KW9Zv00ddywG3-dDy48uuaF6doV2jjMRoGhaYtZtIAJv4TI=\" target=\"_blank\"><strong style=\"font-weight:700;box-sizing:border-box\">here</strong></a>.</p><p style=\"margin:0px;box-sizing:border-box\"><br style=\"box-sizing:border-box\"></p><p style=\"margin:0px;box-sizing:border-box\">Would you be open to a quick chat so I can show you how it works?</p><p style=\"margin:0px;box-sizing:border-box\"><br style=\"box-sizing:border-box\"></p><p style=\"margin:0px;box-sizing:border-box\"><br style=\"box-sizing:border-box\"></p><p style=\"margin:0px;box-sizing:border-box\">Cheers,</p><p style=\"margin:0px;box-sizing:border-box\">Chloei Marithe</p><p style=\"margin:0px;box-sizing:border-box\"> at Oddle </p></div>\n    <div class=\"gmail_extra\">\n      <div class=\"gmail_signature\"><div dir=\"ltr\"><div><div dir=\"ltr\"></div></div></div></div>\n      \n    </div>\n    </div>\n<span summary=\"/api/reply/data-ll-tsk_4iBb2gJWKiF8C8unT\"></span>\n<img alt=\"logo\" src=\"https://b2btrack.oddle.me/api/track/open/usr_tN2v4CzXRtSkvwSkg/tsk_4iBb2gJWKiF8C8unT\" height=\"1\" width=\"1\"></div><br>\n</blockquote></div><div><br clear=\"all\"></div><div><br></div><span class=\"gmail_signature_prefix\">-- </span><br><div dir=\"ltr\" class=\"gmail_signature\"><div dir=\"ltr\">Regards,<div>Chelsea</div></div></div>\n",
          "text": "Hi Chloei,\n\nAfter 1 year free, how is the pricing like?\n\nOn Thu, 15 Jan 2026 at 10:42, Chloei Garcia <chloei.garcia_m@oddle.me>\nwrote:\n\n> Hi Chelsea Coffee Roaster ,\n>\n>\n> This is Chloei Marithe from Oddle.\n>\n>\n> We work with hundreds of restaurants across *Singapore, Malaysia, Taiwan,\n> and Hong Kong, * helping them grow through tools like *reservations,\n> delivery, loyalty, and email marketing*.\n>\n>\n> We’re now expanding into Australia, and we’re inviting a select group of\n> restaurants to try *Oddle Reserve free for a year - our fuss free &\n> comprehensive system* that helps get more bookings without the monthly\n> fees.\n>\n>\n> You can take a look at our reservation system *here*\n> <https://b2btrack.oddle.me/api/t/c/usr_tN2v4CzXRtSkvwSkg/tsk_4iBb2gJWKiF8C8unT/enc_U2FsdGVkX1_E_HaJIk_yP_4M45lw5slC27FxejSkdb5diPG_yfYC-KNvn_Zw8B_7YTYqnh2ol4gvK-WuF2XkMk0gJ39JGxS82Yfgu_GNMfPHw0Z54YQNQaNGkteTpXq_NiVvY8fjr4zIha6CkR50CekNGwdH8J4gCGc69Bq191ciiq0tTCPS_RL3yX-1KW9Zv00ddywG3-dDy48uuaF6doV2jjMRoGhaYtZtIAJv4TI=>\n> .\n>\n>\n> Would you be open to a quick chat so I can show you how it works?\n>\n>\n>\n> Cheers,\n>\n> Chloei Marithe\n>\n> at Oddle\n> [image: logo]\n>\n>\n\n-- \nRegards,\nChelsea\n",
          "email": "chelsea@oddle.me",
          "firstName": "Chelsea",
          "lastName": "Nguyen",
          "companyName": "Chelsea Coffee Roaster",
          "emailTemplateName": "Blank"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "d149826c-a09c-4cb8-9ac5-1e9a7f66ce28",
  "activeVersionId": "bd569dbc-ec30-4b0d-ace0-b7f759023d6b",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-01-02T06:07:57.708Z",
      "createdAt": "2026-01-02T06:07:57.708Z",
      "role": "workflow:owner",
      "workflowId": "Q3ayZFswJ7nIu0we",
      "projectId": "tAHBdayTR1Nb6OKK"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-01-15T03:12:00.400Z",
    "createdAt": "2026-01-15T03:11:46.215Z",
    "versionId": "bd569dbc-ec30-4b0d-ace0-b7f759023d6b",
    "workflowId": "Q3ayZFswJ7nIu0we",
    "nodes": [
      {
        "parameters": {
          "event": "emailsReplied",
          "options": {
            "campaignId": "cam_peDaoGPEGHR28WExF"
          }
        },
        "type": "n8n-nodes-base.lemlistTrigger",
        "typeVersion": 1,
        "position": [
          -2192,
          -416
        ],
        "name": "Reply Received",
        "webhookId": "lemlist-reply-webhook",
        "id": "721e1fd9-103d-4c58-ad68-92c218c25582",
        "credentials": {
          "lemlistApi": {
            "id": "6dgMHleAsx5bfyF9",
            "name": "Lemlist account"
          }
        }
      },
      {
        "parameters": {
          "url": "=https://api.lemlist.com/api/inbox/{{ $('Reply Received').item.json.contactId }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "lemlistApi",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.1,
        "position": [
          -1760,
          -416
        ],
        "name": "Get Conversation History",
        "id": "800d3708-60a6-46a9-ac82-1b03a0e26955",
        "credentials": {
          "lemlistApi": {
            "id": "6dgMHleAsx5bfyF9",
            "name": "Lemlist account"
          }
        }
      },
      {
        "parameters": {
          "modelName": "models/gemini-3-flash-preview",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          -688,
          -240
        ],
        "name": "Google Gemini Flash",
        "id": "2835fccd-8d1a-4b00-b027-7478d0fe46da",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Parse and format Lemlist conversation history for AI agent\n\n// Helper function to strip HTML tags and decode HTML entities\nfunction stripHtml(html) {\n  if (!html) return '';\n  \n  // Remove HTML tags\n  let text = html.replace(/<[^>]*>/g, ' ');\n  \n  // Decode common HTML entities\n  text = text\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/&#x27;/g, \"'\")\n    .replace(/&apos;/g, \"'\")\n    .replace(/&#39;s/g, \"'s\");\n  \n  // Clean up extra whitespace\n  text = text.replace(/\\s+/g, ' ').trim();\n  \n  return text;\n}\n\n// Helper function to format timestamp\nfunction formatTimestamp(isoDate) {\n  const date = new Date(isoDate);\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const hours = String(date.getHours()).padStart(2, '0');\n  const minutes = String(date.getMinutes()).padStart(2, '0');\n  return `${year}-${month}-${day} ${hours}:${minutes}`;\n}\n\n// Get the conversation data from the input\nconst inputData = $input.all();\nlet rawMessages = [];\n\nif (Array.isArray(inputData) && inputData.length > 0) {\n  const firstItem = inputData[0].json;\n  if (firstItem?.data && Array.isArray(firstItem.data)) {\n    rawMessages = firstItem.data;\n  } else if (Array.isArray(firstItem)) {\n    rawMessages = firstItem;\n  }\n}\n\n// 1. EXTRACT LEAD-SPECIFIC DATA\n// Find the latest reply from the prospect\nconst latestLeadReply = rawMessages.find(msg => msg.type === 'emailsReplied');\n// Also find any message that contains the leadEmail (could be a sent or received email)\nconst anyMessageWithEmail = rawMessages.find(msg => msg.leadEmail);\n\nlet leadMessage = '';\nlet leadEmail = anyMessageWithEmail ? anyMessageWithEmail.leadEmail : null;\nlet companyName = null;\n\nif (latestLeadReply) {\n  // Clean lead message and strip out historical \"On... wrote:\" quotes to help AI focus\n  if (latestLeadReply.message) {\n    let cleaned = stripHtml(latestLeadReply.message);\n    leadMessage = cleaned.split(/On\\s.*wrote:/i)[0]\n                         .split(/From:/i)[0]\n                         .split(/---/)[0]\n                         .trim()\n                         .substring(0, 1000);\n  }\n}\n\n// Extract Company Name from leadEmail domain if possible\nif (leadEmail && leadEmail.includes('@')) {\n  const domain = leadEmail.split('@')[1].split('.')[0];\n  // Simple logic to capitalize the first letter of the domain\n  companyName = domain.charAt(0).toUpperCase() + domain.slice(1);\n}\n\n// 2. PROCESS ALL MESSAGES FOR THE THREAD\nconst processedMessages = rawMessages.map(item => {\n  const isProspect = item.type === 'emailsReplied';\n  const role = isProspect ? 'Prospect' : 'SDR';\n  const senderName = isProspect \n    ? (item.fromEmail ? item.fromEmail.split('@')[0] : 'Prospect') \n    : (item.sendUserName || 'SDR');\n  \n  return {\n    timestamp: item.createdAt,\n    formattedTime: formatTimestamp(item.createdAt),\n    role: role,\n    sender: senderName,\n    message: stripHtml(item.message).substring(0, 500),\n    type: item.type,\n    subject: item.subject || ''\n  };\n});\n\n// Sort messages chronologically (oldest first)\nconst chronologicalMessages = [...processedMessages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));\n\n// 3. FORMAT CONVERSATION THREAD\nconst conversationThread = chronologicalMessages.map((msg, index) => {\n  const isLatest = index === chronologicalMessages.length - 1;\n  const prefix = isLatest ? '[LATEST] ' : '';\n  return `${prefix}[${msg.formattedTime}] ${msg.role} (${msg.sender}): ${msg.message}`;\n}).join('\\n\\n');\n\n// 4. CREATE STRUCTURED OBJECT\nconst structuredConversation = {\n  totalMessages: chronologicalMessages.length,\n  messages: chronologicalMessages,\n  summary: {\n    prospectMessageCount: chronologicalMessages.filter(m => m.role === 'Prospect').length,\n    sdrMessageCount: chronologicalMessages.filter(m => m.role === 'SDR').length,\n    latestRole: chronologicalMessages[chronologicalMessages.length - 1]?.role || 'Unknown'\n  }\n};\n\nreturn {\n  json: {\n    leadMessage: leadMessage,\n    leadEmail: leadEmail,\n    companyName: companyName,\n    parsedConversation: structuredConversation,\n    conversationThreadFormatted: conversationThread,\n    contactId: rawMessages[0]?.contactId || null,\n    subject: rawMessages[0]?.subject || ''\n  }\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1536,
          -416
        ],
        "name": "Parse Conversation History",
        "id": "6e63d921-c080-4600-82f0-d7affd788c3b"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "slack_channel",
                "name": "slackChannelId",
                "value": "C0A3N12LT5Z",
                "type": "string"
              },
              {
                "id": "webhook_path",
                "name": "webhookPath",
                "value": "slack-reply-approval",
                "type": "string"
              },
              {
                "id": "lemlist_base_url",
                "name": "lemlistBaseUrl",
                "value": "https://app.lemlist.com",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.3,
        "position": [
          -1984,
          -416
        ],
        "name": "Workflow Configuration",
        "id": "5cf1faec-c2f6-4381-b2f6-4c4b57aa4dd2"
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n  \"content\": \"<html><body><p>Hi Chelsea,</p><p>Thanks for being upfront about that. I completely understand, if your current setup is working well for Chelsea's Bakery, there's no reason to change things just for the sake of it.</p><p>Just so I can better understand for the future, is there any specific feature or integration your current system is missing that would make a difference for your operations?</p></body></html>\"\n}\n"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          -432,
          -240
        ],
        "id": "638028d6-3c8b-43da-ad53-77335dd9c751",
        "name": "Structured Output Parser"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpBearerAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n    \"channel\": \"{{ $('Workflow Configuration').item.json.slackChannelId }}\",\n    \"text\": \"New prospect reply needs approval\",\n    \"blocks\": [\n        {\n            \"type\": \"header\",\n            \"text\": {\n                \"type\": \"plain_text\",\n                \"text\": \":bell: New Prospect Reply\",\n                \"emoji\": true\n            }\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"section\",\n            \"fields\": [\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Company:*\\n{{ $('Reply Received').item.json.companyName }}\"\n                },\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Lead Email:*\\n{{ $('Reply Received').item.json.leadEmail }}\"\n                },\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Reply-from Email:*\\n{{ $('Reply Received').item.json.fromEmail }}\"\n                },\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \"*Outreach Campaign:*\\n{{ $('Reply Received').item.json.campaignName }}\"\n                }\n            ]\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"section\",\n            \"text\": {\n                \"type\": \"mrkdwn\",\n                 \"text\": \"*Prospect's Reply:*\\n```{{ $('Reply Received').item.json.text && $('Reply Received').item.json.text.length > 300 ? $('Reply Received').item.json.text.replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"').substring(0, 300) + '...\\\\n\\\\n[Message truncated - view full reply in Lemlist]' : ($('Reply Received').item.json.text || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n            }\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"section\",\n            \"text\": {\n                \"type\": \"mrkdwn\",\n                \"text\": \"*Agent Generated Response:*\\n```{{ ($json.output.content || '').replace(/\\r\\n/g, '\\\\n').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\n').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\\"/g, '\\\\\"') }}```\"\n            }\n        },\n        {\n            \"type\": \"context\",\n            \"elements\": [\n                {\n                    \"type\": \"mrkdwn\",\n                    \"text\": \":e-mail: <https://app.lemlist.com/teams/{{ $('Reply Received').item.json.metaData.teamId }}/inbox/list/myConversations/contacts/{{ $('Reply Received').item.json.contactId }}|View full conversation in Lemlist>\"\n                }\n            ]\n        },\n        {\n            \"type\": \"divider\"\n        },\n        {\n            \"type\": \"actions\",\n            \"block_id\": \"approval_actions\",\n            \"elements\": [\n                {\n                    \"type\": \"button\",\n                    \"text\": {\n                        \"type\": \"plain_text\",\n                        \"text\": \":white_check_mark: Approve & Send\",\n                        \"emoji\": true\n                    },\n                    \"style\": \"primary\",\n                    \"action_id\": \"approve\",\n                    \"value\": \"{{ $('Reply Received').item.json.messageId }}\"\n                },\n                {\n                    \"type\": \"button\",\n                    \"text\": {\n                        \"type\": \"plain_text\",\n                        \"text\": \"✏ Reject & Edit\",\n                        \"emoji\": true\n                    },\n                    \"style\": \"danger\",\n                    \"action_id\": \"reject\",\n                    \"url\": \"https://app.lemlist.com/teams/{{ $('Reply Received').item.json.metaData.teamId }}/inbox/list/myConversations/contacts/{{ $('Reply Received').item.json.contactId }}\"\n                }\n            ]\n        }\n    ]\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.3,
        "position": [
          -224,
          -416
        ],
        "id": "5aa9e056-a669-480e-9325-edb50a3e98f6",
        "name": "Send to Slack for Approval",
        "credentials": {
          "httpBearerAuth": {
            "id": "A9y0ZdmG00hI8udd",
            "name": "Slack's SDR Agent OAuth Token"
          }
        }
      },
      {
        "parameters": {
          "content": "### Additional tasks for Email Agent\n- Create Lead Profile, send to Attio & Slack\n- Hand off to AE: Send email to prospect & introduce AE with LP\n- Update Attio (CRM agent)",
          "height": 128,
          "width": 496,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -608,
          -576
        ],
        "typeVersion": 1,
        "id": "90f770b5-7c9d-4db6-8216-cb5bb4923590",
        "name": "Sticky Note"
      },
      {
        "parameters": {
          "content": "Additional steps before receiving reply from Lemlist. Agent processes:\n- Lead's attributes & scoring data\n- Additional research on the lead if needed\n- Oddle's internal data\n\nThen propose a personalized outreach email\nGet human to approve\nSend to lead via Lemlist",
          "height": 208,
          "width": 384
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -2672,
          -496
        ],
        "typeVersion": 1,
        "id": "36061de8-27eb-4ddf-b7e4-f9e3aad0d37c",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "content": "## Workflow 1: Handling prospect's reply\n\n",
          "height": 100,
          "width": 640
        },
        "id": "a89cca53-ace2-435f-b80d-7f36f1fd4565",
        "name": "Sticky Note15",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -2208,
          -752
        ],
        "typeVersion": 1
      },
      {
        "parameters": {
          "content": "### Scenarios:\n- give us a number\n- request to send email to another email address instead",
          "height": 128,
          "width": 304
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -2208,
          -224
        ],
        "typeVersion": 1,
        "id": "6648e4dc-c5f2-4311-9985-a72f7f2afc3c",
        "name": "Sticky Note19"
      },
      {
        "parameters": {},
        "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
        "typeVersion": 1,
        "position": [
          -672,
          96
        ],
        "id": "672c90e6-1154-4932-9e38-78de9d165f54",
        "name": "Embeddings Google Gemini",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "mode": "retrieve-as-tool",
          "toolDescription": "Use this tool to find similar past prospect emails and our approved responses (found in metadata.response_sent) to help draft new replies",
          "tableName": {
            "__rl": true,
            "value": "outbound_responses",
            "mode": "list",
            "cachedResultName": "outbound_responses"
          },
          "topK": 5,
          "options": {
            "metadata": {
              "metadataValues": [
                {
                  "name": "topic",
                  "value": "={{ $json.output.topic }}"
                }
              ]
            }
          }
        },
        "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
        "typeVersion": 1.3,
        "position": [
          -672,
          -64
        ],
        "id": "c9d82a8b-a0c5-4cba-9018-028c2313ca95",
        "name": "Past Email Knowledge Base",
        "credentials": {
          "supabaseApi": {
            "id": "aJzMx5t2Q4kcZ8EL",
            "name": "Supabase account"
          }
        }
      },
      {
        "parameters": {
          "content": "### Additional materials required\n- Appt booking link to add to agent's prompt",
          "height": 128,
          "width": 496,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -608,
          -736
        ],
        "typeVersion": 1,
        "id": "6167b1c6-50e4-4057-9f1f-5b15296bf5b7",
        "name": "Sticky Note4"
      },
      {
        "parameters": {
          "content": "### To add: Manager Agent\n1) Look at conversation history\n2) Identify what needs to be done from the latest conversation\n- Generate a response -> Email agent\n- Create a Lead Profile -> LP agent\n- Update Attio -> CRM agent (not sure about this)",
          "height": 192,
          "width": 384,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1424,
          -656
        ],
        "typeVersion": 1,
        "id": "f37b9d75-cabf-4542-a5d1-18509810338c",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=- Email from: {{ $('Parse Conversation History').item.json.leadEmail }}\n- Company: {{ $('Parse Conversation History').item.json.companyName }}\n- Subject: {{ $('Parse Conversation History').item.json.subject }}\n- Lead's's latest reply: {{ $('Parse Conversation History').item.json.leadMessage }}\n- Topic: {{ $json.output.topic }}\n- Conversation History: {{ $('Parse Conversation History').item.json.conversationThreadFormatted }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "=You are an AI SDR (Sales Development Representative) agent helping to qualify leads.\n\nYour goal is to engage with prospects and determine if they meet the SQL (Sales Qualified Lead) criteria through natural conversation, draft a response to the lead's email (lead message) categorized by topic.\n\n**Your responsibilities:**\n1. Analyze the prospect's reply and conversation context\n2. Ask relevant qualifying questions based on SQL criteria\n3. Handle different scenarios:\n   - Interested: Move conversation forward, ask qualifying questions\n   - Not interested: Acknowledge gracefully, ask if timing might be better later\n   - Objections: Address concerns, provide value proposition\n   - Questions: Answer clearly and helpfully\n   - Out of office: Acknowledge and suggest follow-up timeline\n\n**SQL Qualification Criteria to assess:**\n- Need/pain points\n- Decision-making authority\n- Timeline for implementation\n\n**Instructions**\n1. Use the 'Past Email Knowledge Base' tool to retrieve 3-5 successful historical interactions related to the topic provided in the user's request.\n2. Analyze the retrieved examples:\n   - 'content': This is what a previous prospect said.\n   - 'metadata.response_sent': This is the specific, approved response we sent to that prospect.\n3. Use these as 'few-shot' examples to understand our approved tone, formatting, and key talking points for this specific category.\n4. Draft a new response to the current prospect's 'lead_message'.\n\n**Guidelines:**\n- Keep responses professional, friendly, concise, and conversational\n- Ask one question at a time\n- Personalize based on their company and previous messages\n- Be helpful and consultative, not pushy\n- If they're clearly not interested, respect that\n- **Learn from feedback:** When humans reject your responses and send their own, those examples are stored in memory. Pay attention to the conversation patterns and tone that get approved vs rejected.\n\n**When responding:**\n- Provide relevant links when helpful\n- If you don't know something, offer to connect them with our team\n- Be aware that the user's message might contain a quote or reply from the previous message.\n\n**Important:** This workflow includes a feedback loop. When your responses are rejected, the actual message sent by the human is captured and stored. Over time, you'll have access to examples of:\n- What you suggested (rejected)\n- What the human actually sent (approved)\nUse these patterns to continuously improve your responses.\n\nGenerate a response that will be sent to the prospect after human approval."
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          -608,
          -416
        ],
        "name": "Email Agent",
        "id": "d6271e73-662a-4975-a649-cdf9e5e90827",
        "alwaysOutputData": false
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Lead's message: {{ $json.leadMessage }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "You are an AI assistant that categorizes prospect messages into topics.\n\nAnalyze the lead's message and categorize it into ONE of the following topics:\n\n**Valid Topics:**\n- pricing: Questions about cost, pricing plans, discounts, payment terms\n- product_feature: Questions about specific features, functionality, capabilities\n- competitor_comparison: Comparisons with competitors, asking why choose us\n- objection: Concerns, doubts, hesitations, or pushback\n- interested: Expressing interest, wanting to learn more, positive signals\n- not_interested: Clearly not interested, politely declining, no need\n- timing: Questions about implementation timeline, when to start, availability\n- technical: Technical questions, integrations, API, security, compliance\n- scheduling: Requesting a demo, meeting, call, or follow-up\n- general_inquiry: General questions that don't fit other categories\n- auto_reply: Auto-replies, bot replies, out of office messages\n\n**Instructions:**\n1. Read the prospect's message carefully\n2. Identify the main intent or topic\n3. Return ONLY the topic keyword (e.g., \"pricing\", \"product_feature\")\n4. Use lowercase and underscores for multi-word topics\n5. Choose the MOST relevant single topic\n\n**Output Format:**\nReturn a JSON object with the topic:\n{\n  \"topic\": \"<topic_keyword>\"\n}\n\n**Examples:**\nMessage: \"How much does this cost?\"\nOutput: {\"topic\": \"pricing\"}\n\nMessage: \"Does it integrate with POS?\"\nOutput: {\"topic\": \"technical\"}\n\nMessage: \"Not interested right now, thanks.\"\nOutput: {\"topic\": \"not_interested\"}\n\nMessage: \"Can you tell me more about the reporting features?\"\nOutput: {\"topic\": \"product_feature\"}"
          }
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 1.6,
        "position": [
          -1088,
          -416
        ],
        "name": "Categorize Lead Message Topic",
        "id": "6235c31b-6ef4-4416-8922-95dddaf0f359"
      },
      {
        "parameters": {
          "modelName": "models/gemini-3-flash-preview",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
        "typeVersion": 1,
        "position": [
          -1152,
          -208
        ],
        "name": "Google Gemini Chat",
        "id": "5a3d304b-d490-4af5-ab78-ff01872c628f",
        "credentials": {
          "googlePalmApi": {
            "id": "RYsSfOkTTr5PB58p",
            "name": "Oddle's Google Gemini(PaLM) API account"
          }
        }
      },
      {
        "parameters": {
          "jsonSchemaExample": "{\n  \"topic\": \"pricing\"\n}"
        },
        "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
        "typeVersion": 1.3,
        "position": [
          -864,
          -208
        ],
        "name": "Topic Output Parser",
        "id": "eb148603-6507-456a-824c-f574e121268e"
      }
    ],
    "connections": {
      "Reply Received": {
        "main": [
          [
            {
              "node": "Workflow Configuration",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Conversation History": {
        "main": [
          [
            {
              "node": "Parse Conversation History",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Flash": {
        "ai_languageModel": [
          [
            {
              "node": "Email Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Parse Conversation History": {
        "main": [
          [
            {
              "node": "Categorize Lead Message Topic",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Workflow Configuration": {
        "main": [
          [
            {
              "node": "Get Conversation History",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Structured Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Email Agent",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      },
      "Send to Slack for Approval": {
        "main": [
          []
        ]
      },
      "Embeddings Google Gemini": {
        "ai_embedding": [
          [
            {
              "node": "Past Email Knowledge Base",
              "type": "ai_embedding",
              "index": 0
            }
          ]
        ]
      },
      "Past Email Knowledge Base": {
        "ai_tool": [
          [
            {
              "node": "Email Agent",
              "type": "ai_tool",
              "index": 0
            }
          ]
        ]
      },
      "Email Agent": {
        "main": [
          [
            {
              "node": "Send to Slack for Approval",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Categorize Lead Message Topic": {
        "main": [
          [
            {
              "node": "Email Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Google Gemini Chat": {
        "ai_languageModel": [
          [
            {
              "node": "Categorize Lead Message Topic",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Topic Output Parser": {
        "ai_outputParser": [
          [
            {
              "node": "Categorize Lead Message Topic",
              "type": "ai_outputParser",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Oddle Engineer",
    "name": "test #2 - 15 jan",
    "description": "",
    "autosaved": false
  },
  "tags": []
}